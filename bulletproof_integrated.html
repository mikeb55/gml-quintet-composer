<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer - Bulletproof Edition</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        input, select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .generate-btn { background: #4CAF50; color: white; }
        .export-btn { background: #2196F3; color: white; }
        .status {
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¼ Quintet Composer - Bulletproof Working Version</h1>
        <div id="status" class="status success">Ready - All exports working</div>
        
        <div class="controls">
            <div class="control-group">
                <label>Measures</label>
                <input type="number" id="measures" min="1" max="128" value="16">
            </div>
            <div class="control-group">
                <label>Tempo</label>
                <input type="number" id="tempo" min="40" max="240" value="120">
            </div>
            <div class="control-group">
                <label>Complexity</label>
                <select id="complexity">
                    <option value="simple">Simple</option>
                    <option value="medium" selected>Medium</option>
                    <option value="complex">Complex</option>
                </select>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="generate-btn" onclick="generateMusic()">Generate</button>
            <button class="export-btn" onclick="exportMusicXML()">Export MusicXML</button>
            <button class="export-btn" onclick="exportMIDI()">Export MIDI</button>
        </div>
    </div>
    
    <script>
        // Include the working code from our session
        let composition = null;
        const INSTRUMENTS = [
            { id: 'guitar', name: 'Classical Guitar', low: 40, high: 76 },
            { id: 'violin1', name: 'Violin 1', low: 55, high: 88 },
            { id: 'violin2', name: 'Violin 2', low: 55, high: 84 },
            { id: 'viola', name: 'Viola', low: 48, high: 72 },
            { id: 'cello', name: 'Cello', low: 36, high: 69 }
        ];
        
        function generateMusic() {
            const measures = parseInt(document.getElementById('measures').value);
            const tempo = parseInt(document.getElementById('tempo').value);
            const complexity = document.getElementById('complexity').value;
            
            composition = { measures, tempo, parts: [] };
            
            INSTRUMENTS.forEach(inst => {
                const part = { name: inst.name, notes: [] };
                let currentPitch = Math.floor((inst.low + inst.high) / 2);
                
                for (let m = 0; m < measures; m++) {
                    let measureDuration = 0;
                    while (measureDuration < 4) {
                        let duration = complexity === 'simple' ? 1 : 
                                      complexity === 'complex' ? [0.25,0.5,1,2,4][Math.floor(Math.random()*5)] : 
                                      [0.5,1,2][Math.floor(Math.random()*3)];
                        duration = Math.min(duration, 4 - measureDuration);
                        
                        const interval = Math.floor(Math.random() * 5) - 2;
                        currentPitch = Math.max(inst.low, Math.min(inst.high, currentPitch + interval));
                        
                        part.notes.push({
                            measure: m + 1,
                            pitch: currentPitch,
                            duration: duration
                        });
                        measureDuration += duration;
                    }
                }
                composition.parts.push(part);
            });
            document.getElementById('status').textContent = 'Generated!';
        }
        
        function exportMusicXML() {
            if (!composition) return;
            
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<score-partwise version="3.1">\n<part-list>\n';
            INSTRUMENTS.forEach((inst, i) => {
                xml += `<score-part id="P${i+1}"><part-name>${inst.name}</part-name></score-part>\n`;
            });
            xml += '</part-list>\n';
            
            composition.parts.forEach((part, idx) => {
                xml += `<part id="P${idx+1}">\n`;
                for (let m = 1; m <= composition.measures; m++) {
                    xml += `<measure number="${m}">\n`;
                    if (m === 1) xml += '<attributes><divisions>4</divisions><key><fifths>0</fifths></key><time><beats>4</beats><beat-type>4</beat-type></time></attributes>\n';
                    
                    const measureNotes = part.notes.filter(n => n.measure === m);
                    if (measureNotes.length === 0) {
                        // Add rest for empty measures
                        xml += '<note><rest/><duration>16</duration><type>whole</type></note>\n';
                    } else {
                        measureNotes.forEach(note => {
                            const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
                            const oct = Math.floor(note.pitch / 12) - 1;
                            const name = names[note.pitch % 12];
                            const duration = Math.round(note.duration * 4); // Ensure integer duration
                            xml += '<note><pitch><step>' + name.replace('#','') + '</step>';
                            if (name.includes('#')) xml += '<alter>1</alter>';
                            xml += `<octave>${oct}</octave></pitch><duration>${duration}</duration>`;
                            xml += `<type>${note.duration===4?'whole':note.duration===2?'half':note.duration===1?'quarter':note.duration===0.5?'eighth':'16th'}</type></note>\n`;
                        });
                    }
                    xml += '</measure>\n';
                }
                xml += '</part>\n';
            });
            xml += '</score-partwise>';
            
            const blob = new Blob([xml], {type: 'application/xml'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'quintet.musicxml';
            a.click();
        }
        
        function exportMIDI() {
            if (!composition) return;
            
            const b = [];
            b.push(0x4D,0x54,0x68,0x64,0,0,0,6,0,1,0,5,1,0xE0);
            
            composition.parts.forEach((part, i) => {
                const t = [];
                t.push(0,0xFF,3,part.name.length,...Array.from(part.name).map(c=>c.charCodeAt(0)));
                if (i===0) {
                    const tempo = Math.floor(60000000/composition.tempo);
                    t.push(0,0xFF,0x51,3,(tempo>>16)&0xFF,(tempo>>8)&0xFF,tempo&0xFF);
                }
                t.push(0,0xC0|i,[24,40,40,41,42][i]);
                
                part.notes.forEach(n => {
                    t.push(0,0x90|i,n.pitch,0x50);
                    const ticks = Math.round(n.duration * 480);
                    if (ticks < 128) t.push(ticks);
                    else t.push(0x80|(ticks>>7), ticks&0x7F);
                    t.push(0x80|i,n.pitch,0);
                });
                t.push(0,0xFF,0x2F,0);
                
                b.push(0x4D,0x54,0x72,0x6B);
                b.push((t.length>>24)&0xFF,(t.length>>16)&0xFF,(t.length>>8)&0xFF,t.length&0xFF);
                b.push(...t);
            });
            
            const blob = new Blob([new Uint8Array(b)], {type: 'audio/midi'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'quintet.mid';
            a.click();
        }
    </script>
    
    <!-- Option to load your existing scripts if needed -->
    <!-- <script src="rhythm_patterns.js"></script> -->
    <!-- <script src="structure_generator.js"></script> -->
</body>
</html>
