 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer v9.2 - Fixed 4/4 Timing</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:active {
            transform: translateY(0);
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .instrument {
            margin-bottom: 15px;
        }
        .instrument h4 {
            margin: 5px 0;
            color: #555;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .measures {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .measure {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            padding: 8px;
            text-align: center;
            transition: all 0.3s;
        }
        .measure:hover {
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .measure-number {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }
        .notes {
            min-height: 30px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }
        .note {
            display: inline-block;
            margin: 0 2px;
            padding: 2px 4px;
            background: #f0f0f0;
            border-radius: 3px;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 8px;
            color: #2e7d32;
            text-align: center;
            font-weight: 500;
        }
        input[type="file"] {
            padding: 10px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .theme-controls {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .tempo-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }
        input[type="range"] {
            flex: 1;
            height: 6px;
            background: #667eea;
            outline: none;
            border-radius: 3px;
        }
        select {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 5px;
            background: white;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº Quintet Composer v9.2 - Fixed 4/4 Timing</h1>
        
        <div class="theme-controls">
            <h3>Composition Settings</h3>
            <div class="tempo-control">
                <label>Tempo: <span id="tempoValue">120</span> BPM</label>
                <input type="range" id="tempo" min="60" max="180" value="120">
            </div>
            <div class="tempo-control">
                <label>Key:</label>
                <select id="keySignature">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="F">F Major</option>
                </select>
            </div>
        </div>

        <div class="controls">
            <button onclick="generateComposition()">üé≤ Generate Composition</button>
            <button onclick="playComposition()">‚ñ∂Ô∏è Play</button>
            <button onclick="stopPlayback()">‚èπÔ∏è Stop</button>
            <button onclick="exportMusicXML()">üíæ Export MusicXML</button>
            <button onclick="exportMIDI()">üéπ Export MIDI</button>
            <input type="file" id="midiFile" accept=".mid,.midi" onchange="loadMidiFile(event)">
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="measureCount">32</div>
                <div class="stat-label">Measures</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="noteCount">0</div>
                <div class="stat-label">Total Notes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="sectionCount">5</div>
                <div class="stat-label">Sections</div>
            </div>
        </div>

        <div id="composition"></div>
        <div id="status">Ready to compose!</div>
    </div>

    <script>
        // Global composition state
        let composition = {
            tempo: 120,
            timeSignature: { numerator: 4, denominator: 4 },
            keySignature: 'C',
            sections: [],
            totalMeasures: 32
        };
        
        let isPlaying = false;
        let playbackTimeout = null;
        let audioContext = null;
        let importedTheme = null;

        // Musical constants
        const TICKS_PER_QUARTER = 4;
        const QUARTERS_PER_MEASURE = 4;
        const TICKS_PER_MEASURE = TICKS_PER_QUARTER * QUARTERS_PER_MEASURE; // 16 ticks per 4/4 measure

        // Note mappings for different keys
        const keySignatures = {
            'C': ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
            'G': ['G', 'A', 'B', 'C', 'D', 'E', 'F#'],
            'D': ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'],
            'A': ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'],
            'F': ['F', 'G', 'A', 'Bb', 'C', 'D', 'E']
        };

        const noteToMidi = {
            'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5,
            'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11, 'Bb': 10
        };

        // Initialize on load
        window.onload = function() {
            document.getElementById('tempo').addEventListener('input', function(e) {
                composition.tempo = parseInt(e.target.value);
                document.getElementById('tempoValue').textContent = composition.tempo;
            });
            
            document.getElementById('keySignature').addEventListener('change', function(e) {
                composition.keySignature = e.target.value;
            });
            
            generateComposition();
        };

        function generateSection(sectionType, startMeasure, endMeasure) {
            const section = {
                type: sectionType,
                startMeasure: startMeasure,
                endMeasure: endMeasure,
                instruments: {
                    guitar: [],
                    violin1: [],
                    violin2: [],
                    viola: [],
                    cello: []
                }
            };

            const numMeasures = endMeasure - startMeasure + 1;
            const scale = keySignatures[composition.keySignature];

            // Generate notes for each instrument
            for (let measure = 0; measure < numMeasures; measure++) {
                const measureNum = startMeasure + measure;
                
                // Guitar - melody line (4 quarter notes per measure)
                const guitarMeasure = [];
                for (let beat = 0; beat < 4; beat++) {
                    guitarMeasure.push({
                        pitch: scale[Math.floor(Math.random() * scale.length)] + '4',
                        tick: beat * TICKS_PER_QUARTER,
                        duration: TICKS_PER_QUARTER
                    });
                }
                section.instruments.guitar.push(guitarMeasure);

                // Violin 1 - counter melody (4 quarter notes)
                const violin1Measure = [];
                for (let beat = 0; beat < 4; beat++) {
                    violin1Measure.push({
                        pitch: scale[Math.floor(Math.random() * scale.length)] + '4',
                        tick: beat * TICKS_PER_QUARTER,
                        duration: TICKS_PER_QUARTER
                    });
                }
                section.instruments.violin1.push(violin1Measure);

                // Violin 2 - harmony (2 half notes)
                const violin2Measure = [];
                violin2Measure.push({
                    pitch: scale[Math.floor(Math.random() * scale.length)] + '3',
                    tick: 0,
                    duration: TICKS_PER_QUARTER * 2
                });
                violin2Measure.push({
                    pitch: scale[Math.floor(Math.random() * scale.length)] + '3',
                    tick: TICKS_PER_QUARTER * 2,
                    duration: TICKS_PER_QUARTER * 2
                });
                section.instruments.violin2.push(violin2Measure);

                // Viola - rhythmic pattern (8 eighth notes)
                const violaMeasure = [];
                for (let eighth = 0; eighth < 8; eighth++) {
                    violaMeasure.push({
                        pitch: scale[Math.floor(Math.random() * scale.length)] + '3',
                        tick: eighth * (TICKS_PER_QUARTER / 2),
                        duration: TICKS_PER_QUARTER / 2
                    });
                }
                section.instruments.viola.push(violaMeasure);

                // Cello - bass line (whole note)
                const celloMeasure = [];
                celloMeasure.push({
                    pitch: scale[0] + '2',
                    tick: 0,
                    duration: TICKS_PER_MEASURE
                });
                section.instruments.cello.push(celloMeasure);
            }

            return section;
        }

        function generateComposition() {
            composition.sections = [];
            
            // Structure: Intro (4), Verse (8), Chorus (8), Bridge (8), Outro (4)
            composition.sections.push(generateSection('Intro', 1, 4));
            composition.sections.push(generateSection('Verse', 5, 12));
            composition.sections.push(generateSection('Chorus', 13, 20));
            composition.sections.push(generateSection('Bridge', 21, 28));
            composition.sections.push(generateSection('Outro', 29, 32));

            displayComposition();
            updateStatus('New composition generated!');
            updateStats();
        }

        function displayComposition() {
            const container = document.getElementById('composition');
            container.innerHTML = '';

            composition.sections.forEach((section, sectionIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section';
                sectionDiv.innerHTML = `<h3>${section.type} (Measures ${section.startMeasure}-${section.endMeasure})</h3>`;

                ['guitar', 'violin1', 'violin2', 'viola', 'cello'].forEach(instrument => {
                    const instrumentDiv = document.createElement('div');
                    instrumentDiv.className = 'instrument';
                    
                    const instrumentName = instrument.replace('violin1', 'Violin I')
                                                     .replace('violin2', 'Violin II')
                                                     .replace(/^\w/, c => c.toUpperCase());
                    
                    instrumentDiv.innerHTML = `<h4>üéµ ${instrumentName}</h4>`;
                    
                    const measuresDiv = document.createElement('div');
                    measuresDiv.className = 'measures';
                    
                    section.instruments[instrument].forEach((measure, measureIndex) => {
                        const measureDiv = document.createElement('div');
                        measureDiv.className = 'measure';
                        
                        const globalMeasureNum = section.startMeasure + measureIndex;
                        measureDiv.innerHTML = `
                            <div class="measure-number">M${globalMeasureNum}</div>
                            <div class="notes">
                                ${measure.map(note => `<span class="note">${note.pitch}</span>`).join(' ')}
                            </div>
                        `;
                        
                        measuresDiv.appendChild(measureDiv);
                    });
                    
                    instrumentDiv.appendChild(measuresDiv);
                    sectionDiv.appendChild(instrumentDiv);
                });

                container.appendChild(sectionDiv);
            });
        }

        function updateStats() {
            let totalNotes = 0;
            composition.sections.forEach(section => {
                Object.values(section.instruments).forEach(instrument => {
                    instrument.forEach(measure => {
                        totalNotes += measure.length;
                    });
                });
            });
            
            document.getElementById('noteCount').textContent = totalNotes;
        }

        function exportMusicXML() {
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">\n';
            xml += '<score-partwise version="3.1">\n';
            
            // Work title
            xml += '  <work><work-title>Quintet Composition v9.2</work-title></work>\n';
            
            // Part list
            xml += '  <part-list>\n';
            const parts = [
                { id: 'P1', name: 'Guitar' },
                { id: 'P2', name: 'Violin I' },
                { id: 'P3', name: 'Violin II' },
                { id: 'P4', name: 'Viola' },
                { id: 'P5', name: 'Cello' }
            ];
            
            parts.forEach(part => {
                xml += `    <score-part id="${part.id}">\n`;
                xml += `      <part-name>${part.name}</part-name>\n`;
                xml += '    </score-part>\n';
            });
            xml += '  </part-list>\n';
            
            // Generate parts
            ['guitar', 'violin1', 'violin2', 'viola', 'cello'].forEach((instrument, partIndex) => {
                xml += `  <part id="P${partIndex + 1}">\n`;
                
                let measureNum = 1;
                composition.sections.forEach(section => {
                    section.instruments[instrument].forEach((measure, measureIndex) => {
                        xml += `    <measure number="${measureNum}">\n`;
                        
                        // Add attributes for first measure
                        if (measureNum === 1) {
                            xml += '      <attributes>\n';
                            xml += '        <divisions>4</divisions>\n'; // 4 divisions per quarter note
                            xml += '        <key><fifths>0</fifths></key>\n';
                            xml += '        <time><beats>4</beats><beat-type>4</beat-type></time>\n';
                            xml += `        <clef><sign>${partIndex === 4 ? 'F' : 'G'}</sign><line>${partIndex === 4 ? '4' : '2'}</line></clef>\n`;
                            xml += '      </attributes>\n';
                        }
                        
                        // Add notes
                        measure.forEach(note => {
                            const [noteName, octave] = [note.pitch.slice(0, -1), note.pitch.slice(-1)];
                            const step = noteName[0];
                            const alter = noteName.includes('#') ? 1 : (noteName.includes('b') ? -1 : 0);
                            
                            xml += '      <note>\n';
                            xml += '        <pitch>\n';
                            xml += `          <step>${step}</step>\n`;
                            if (alter !== 0) xml += `          <alter>${alter}</alter>\n`;
                            xml += `          <octave>${octave}</octave>\n`;
                            xml += '        </pitch>\n';
                            xml += `        <duration>${note.duration}</duration>\n`;
                            
                            // Determine note type based on duration
                            let noteType = 'quarter';
                            if (note.duration === 16) noteType = 'whole';
                            else if (note.duration === 8) noteType = 'half';
                            else if (note.duration === 2) noteType = 'eighth';
                            else if (note.duration === 1) noteType = '16th';
                            
                            xml += `        <type>${noteType}</type>\n`;
                            xml += '      </note>\n';
                        });
                        
                        xml += '    </measure>\n';
                        measureNum++;
                    });
                });
                
                xml += '  </part>\n';
            });
            
            xml += '</score-partwise>';
            
            downloadFile(xml, 'quintet_composition.xml', 'text/xml');
            updateStatus('MusicXML exported successfully!');
        }

        function exportMIDI() {
            updateStatus('MIDI export coming soon!');
        }

        function playComposition() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            isPlaying = true;
            let currentMeasure = 0;
            const measureDuration = (60 / composition.tempo) * 4 * 1000; // Duration of one 4/4 measure in ms
            
            function playMeasure() {
                if (!isPlaying || currentMeasure >= composition.totalMeasures) {
                    stopPlayback();
                    return;
                }
                
                // Highlight current measure
                document.querySelectorAll('.measure').forEach((el, index) => {
                    el.style.background = index === currentMeasure ? '#ffe0b2' : 'white';
                });
                
                // Play notes for current measure (simplified audio)
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440 + (currentMeasure * 20); // Simple progression
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
                
                currentMeasure++;
                playbackTimeout = setTimeout(playMeasure, measureDuration);
            }
            
            playMeasure();
            updateStatus('Playing composition...');
        }

        function stopPlayback() {
            isPlaying = false;
            if (playbackTimeout) {
                clearTimeout(playbackTimeout);
                playbackTimeout = null;
            }
            
            document.querySelectorAll('.measure').forEach(el => {
                el.style.background = 'white';
            });
            
            updateStatus('Playback stopped');
        }

        function loadMidiFile(event) {
            const file = event.target.files[0];
            if (file) {
                updateStatus(`MIDI file "${file.name}" loaded - theme import coming soon!`);
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function updateStatus(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.animation = 'pulse 0.5s';
            setTimeout(() => {
                statusDiv.style.animation = '';
            }, 500);
        }
    </script>
</body>
</html>