<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer v10.4 - Authentic Composer Profiles</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #5a67d8;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .version {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .composer-selector {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .composer-selector h3 {
            color: #92400e;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .composer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .composer-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }
        
        .composer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .composer-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
        }
        
        .composer-card h4 {
            color: #4c1d95;
            margin-bottom: 5px;
        }
        
        .composer-card .era {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 8px;
        }
        
        .composer-card .characteristics {
            font-size: 11px;
            color: #9333ea;
            line-height: 1.4;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .control-group h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        label {
            display: block;
            margin: 8px 0;
            color: #4a5568;
            font-weight: 500;
        }
        
        input[type="number"], 
        input[type="text"], 
        select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .section-container {
            margin-bottom: 30px;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-controls {
            background: #f9fafb;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        button.danger {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
        }
        
        button.add-section {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .remove-section {
            background: #fc8181;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .style-indicator {
            background: #fef3c7;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº Quintet Composer v10.4 üéµ</h1>
        <div class="version">Authentic Composer Profiles with Distinctive Styles</div>
        
        <!-- Composer Selection -->
        <div class="composer-selector">
            <h3>üé≠ Select Composer Style</h3>
            <div class="composer-grid">
                <div class="composer-card selected" data-composer="bach">
                    <h4>J.S. Bach</h4>
                    <div class="era">Baroque (1685-1750)</div>
                    <div class="characteristics">Fugal ‚Ä¢ Continuous motion ‚Ä¢ Functional harmony</div>
                </div>
                <div class="composer-card" data-composer="mozart">
                    <h4>W.A. Mozart</h4>
                    <div class="era">Classical (1756-1791)</div>
                    <div class="characteristics">Elegant ‚Ä¢ Alberti bass ‚Ä¢ Balanced phrases</div>
                </div>
                <div class="composer-card" data-composer="beethoven">
                    <h4>L. Beethoven</h4>
                    <div class="era">Classical-Romantic (1770-1827)</div>
                    <div class="characteristics">Motivic ‚Ä¢ Dramatic ‚Ä¢ Sforzando</div>
                </div>
                <div class="composer-card" data-composer="brahms">
                    <h4>J. Brahms</h4>
                    <div class="era">Romantic (1833-1897)</div>
                    <div class="characteristics">Dense ‚Ä¢ Hemiola ‚Ä¢ Chromatic</div>
                </div>
                <div class="composer-card" data-composer="ravel">
                    <h4>M. Ravel</h4>
                    <div class="era">Impressionist (1875-1937)</div>
                    <div class="characteristics">Modal ‚Ä¢ Spanish rhythms ‚Ä¢ Orchestral color</div>
                </div>
                <div class="composer-card" data-composer="glass">
                    <h4>P. Glass</h4>
                    <div class="era">Minimalist (1937-)</div>
                    <div class="characteristics">Repetitive ‚Ä¢ Additive rhythm ‚Ä¢ Phasing</div>
                </div>
            </div>
        </div>
        
        <!-- Global Controls -->
        <div class="controls-grid">
            <div class="control-group">
                <h3>üéµ Composition</h3>
                <label>
                    Title:
                    <input type="text" id="title" value="Quintet Study" />
                </label>
                <label>
                    Tempo (BPM):
                    <input type="number" id="tempo" min="40" max="200" value="120" />
                </label>
            </div>
            
            <div class="control-group">
                <h3>üìê Structure</h3>
                <label>
                    Measures per Section:
                    <input type="number" id="measuresPerSection" min="4" max="16" value="8" />
                </label>
                <label>
                    Key Signature:
                    <select id="globalKey">
                        <option value="C">C Major</option>
                        <option value="G">G Major</option>
                        <option value="D">D Major</option>
                        <option value="F">F Major</option>
                        <option value="Am">A minor</option>
                        <option value="Em">E minor</option>
                    </select>
                </label>
            </div>
        </div>
        
        <!-- Sections Container -->
        <div id="sectionsContainer"></div>
        
        <!-- Add Section Button -->
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="addSection()" class="add-section">‚ûï Add New Section</button>
        </div>
        
        <!-- Generate/Export Buttons -->
        <div class="button-group">
            <button onclick="generateScore()">üéº Generate Score</button>
            <button onclick="exportMusicXML()" class="secondary" id="exportBtn" disabled>üíæ Export MusicXML</button>
            <button onclick="resetAll()" class="danger">üîÑ Reset All</button>
        </div>
        
        <div id="status"></div>
    </div>
    
    <script>
        // Global variables
        let currentScore = null;
        let sections = [];
        let sectionCounter = 0;
        let currentComposer = 'bach';
        
        // Composer Profiles with authentic characteristics
        const COMPOSER_PROFILES = {
            bach: {
                name: 'J.S. Bach',
                harmony: 'functional', // Circle of fifths progressions
                rhythm: 'continuous_16th', // Constant motion
                texture: 'polyphonic', // Multiple independent voices
                dynamics: ['p', 'mp', 'mf'], // Terraced dynamics
                specialty: 'fugue', // Fugal development
                chordProgressions: [
                    ['C', 'G', 'Am', 'Em', 'F', 'C', 'G', 'C'], // I-V-vi-iii-IV-I-V-I
                    ['C', 'Dm', 'G', 'C', 'F', 'Bdim', 'C', 'C']  // Circle of fifths
                ],
                generatePattern: function(instrument, measure) {
                    // Continuous 16th notes for Bach
                    if (instrument === 'violin1') {
                        return this.generateFugalSubject(measure);
                    } else if (instrument === 'cello') {
                        return this.generateWalkingBass(measure);
                    }
                    return this.generateCounterpoint(measure);
                },
                generateFugalSubject: function(measure) {
                    const subjects = [
                        ['G', 'F', 'E', 'D', 'C', 'D', 'E', 'F'], // BWV 578 style
                        ['C', 'D', 'E', 'F', 'G', 'F', 'E', 'D']
                    ];
                    return subjects[measure % 2];
                },
                generateWalkingBass: function(measure) {
                    const patterns = [
                        ['C', 'D', 'E', 'F', 'G', 'F', 'E', 'D'],
                        ['C', 'B', 'A', 'G', 'F', 'E', 'D', 'C']
                    ];
                    return patterns[measure % 2];
                },
                generateCounterpoint: function(measure) {
                    const patterns = [
                        ['E', 'D', 'C', 'D', 'E', 'F', 'G', 'E'],
                        ['G', 'A', 'B', 'C', 'B', 'A', 'G', 'F']
                    ];
                    return patterns[measure % 2];
                }
            },
            
            mozart: {
                name: 'W.A. Mozart',
                harmony: 'classical', // Simple, clear progressions
                rhythm: 'balanced', // 4+4 bar phrases
                texture: 'homophonic', // Melody + accompaniment
                dynamics: ['p', 'mp', 'mf', 'f'],
                specialty: 'alberti_bass',
                chordProgressions: [
                    ['C', 'G', 'C', 'G', 'F', 'C', 'G', 'C'], // I-V-I-V-IV-I-V-I
                    ['C', 'F', 'G', 'C', 'Am', 'Dm', 'G', 'C']
                ],
                generatePattern: function(instrument, measure) {
                    if (instrument === 'guitar') {
                        return this.generateAlbertiBass(measure);
                    } else if (instrument === 'violin1') {
                        return this.generateElegantMelody(measure);
                    }
                    return this.generateHarmony(measure);
                },
                generateAlbertiBass: function(measure) {
                    // Classic Alberti bass pattern: low-high-middle-high
                    return ['C', 'G', 'E', 'G', 'C', 'G', 'E', 'G'];
                },
                generateElegantMelody: function(measure) {
                    const melodies = [
                        ['E', 'F', 'G', 'G', 'F', 'E', 'D', 'C'],
                        ['C', 'D', 'E', 'F', 'G', 'F', 'E', 'D']
                    ];
                    return melodies[measure % 2];
                },
                generateHarmony: function(measure) {
                    return ['C', 'E', 'G', 'E', 'C', 'E', 'G', 'E'];
                }
            },
            
            beethoven: {
                name: 'L. Beethoven',
                harmony: 'expanded', // Extended harmony, sudden modulations
                rhythm: 'motivic', // Short motifs developed
                texture: 'orchestral',
                dynamics: ['pp', 'p', 'mp', 'mf', 'f', 'ff', 'sf'], // Wide range + sforzando
                specialty: 'development',
                chordProgressions: [
                    ['C', 'C', 'C', 'G', 'Ab', 'Ab', 'G', 'C'], // Surprise modulation
                    ['C', 'Eb', 'G', 'C', 'F', 'Fm', 'C', 'G']  // Borrowing from minor
                ],
                generatePattern: function(instrument, measure) {
                    if (instrument === 'violin1') {
                        return this.generateFateMotif(measure);
                    } else if (instrument === 'cello') {
                        return this.generateDramaticBass(measure);
                    }
                    return this.generateMotivicDevelopment(measure);
                },
                generateFateMotif: function(measure) {
                    // Famous "fate knocking" rhythm: short-short-short-long
                    if (measure % 2 === 0) {
                        return ['G', 'G', 'G', 'Eb', 'rest', 'rest', 'rest', 'rest'];
                    }
                    return ['F', 'F', 'F', 'D', 'rest', 'rest', 'rest', 'rest'];
                },
                generateDramaticBass: function(measure) {
                    return ['C', 'rest', 'C', 'rest', 'G', 'rest', 'G', 'rest'];
                },
                generateMotivicDevelopment: function(measure) {
                    const motif = ['C', 'D', 'Eb', 'D'];
                    const developed = ['Eb', 'F', 'G', 'F'];
                    return measure % 2 === 0 ? [...motif, ...motif] : [...developed, ...developed];
                }
            },
            
            brahms: {
                name: 'J. Brahms',
                harmony: 'chromatic', // Rich chromatic harmony
                rhythm: 'hemiola', // 3 against 2
                texture: 'dense', // Multiple inner voices
                dynamics: ['pp', 'p', 'mp', 'mf', 'f'],
                specialty: 'cross_rhythm',
                chordProgressions: [
                    ['C', 'Am', 'F', 'Dm', 'G', 'Em', 'Am', 'G'], // Rich progression
                    ['C', 'Eb', 'Ab', 'Db', 'G', 'G7', 'C', 'C']   // Chromatic
                ],
                generatePattern: function(instrument, measure) {
                    if (instrument === 'violin1') {
                        return this.generateHemiola(measure);
                    } else if (instrument === 'viola') {
                        return this.generateInnerVoice(measure);
                    }
                    return this.generateRichHarmony(measure);
                },
                generateHemiola: function(measure) {
                    // 3 against 2 pattern
                    return ['C', 'E', 'G', 'rest', 'C', 'E', 'G', 'rest'];
                },
                generateInnerVoice: function(measure) {
                    return ['E', 'F', 'E', 'D', 'C', 'D', 'E', 'F'];
                },
                generateRichHarmony: function(measure) {
                    return ['C', 'Eb', 'G', 'Bb', 'Ab', 'F', 'Eb', 'C'];
                }
            },
            
            ravel: {
                name: 'M. Ravel',
                harmony: 'modal', // Modes, extended chords
                rhythm: 'spanish', // Bolero, habanera rhythms
                texture: 'coloristic',
                dynamics: ['ppp', 'pp', 'p', 'mp', 'mf'],
                specialty: 'ostinato',
                chordProgressions: [
                    ['C', 'Dm7', 'Em7', 'Fmaj7', 'G7', 'Am7', 'Bm7b5', 'Cmaj7'],
                    ['C', 'D', 'E', 'F#', 'G#', 'A#', 'C', 'C'] // Whole tone
                ],
                generatePattern: function(instrument, measure) {
                    if (instrument === 'guitar') {
                        return this.generateBoleroRhythm(measure);
                    } else if (instrument === 'violin1') {
                        return this.generateModalMelody(measure);
                    }
                    return this.generateOstinato(measure);
                },
                generateBoleroRhythm: function(measure) {
                    // Bolero rhythm pattern
                    return ['C', 'rest', 'C', 'C', 'rest', 'C', 'C', 'rest'];
                },
                generateModalMelody: function(measure) {
                    // Dorian mode
                    return ['D', 'E', 'F', 'G', 'A', 'B', 'C', 'D'];
                },
                generateOstinato: function(measure) {
                    // Repeating pattern
                    return ['C', 'D', 'Eb', 'D', 'C', 'D', 'Eb', 'D'];
                }
            },
            
            glass: {
                name: 'P. Glass',
                harmony: 'minimalist', // Simple, repetitive
                rhythm: 'additive', // 3+3+2, 2+3+3 patterns
                texture: 'repetitive',
                dynamics: ['p', 'mp', 'mf'],
                specialty: 'phasing',
                chordProgressions: [
                    ['C', 'C', 'C', 'C', 'F', 'F', 'F', 'F'], // Static harmony
                    ['Am', 'Am', 'Am', 'Am', 'C', 'C', 'C', 'C']
                ],
                generatePattern: function(instrument, measure) {
                    if (instrument === 'violin1') {
                        return this.generatePhasing(measure);
                    }
                    return this.generateAdditiveRhythm(measure);
                },
                generatePhasing: function(measure) {
                    // Pattern that gradually shifts
                    const base = ['C', 'D', 'E', 'D'];
                    const shift = measure % 4;
                    return [...base.slice(shift), ...base.slice(0, shift), ...base.slice(shift), ...base.slice(0, shift)];
                },
                generateAdditiveRhythm: function(measure) {
                    // 3+3+2 additive rhythm
                    if (measure % 2 === 0) {
                        return ['C', 'C', 'C', 'D', 'D', 'D', 'E', 'E'];
                    }
                    return ['E', 'E', 'D', 'D', 'D', 'C', 'C', 'C'];
                }
            }
        };
        
        // Initialize composer selection
        document.querySelectorAll('.composer-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.composer-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                currentComposer = card.dataset.composer;
                updateComposerIndicator();
            });
        });
        
        function updateComposerIndicator() {
            const profile = COMPOSER_PROFILES[currentComposer];
            document.getElementById('tempo').value = 
                currentComposer === 'bach' ? 100 :
                currentComposer === 'mozart' ? 120 :
                currentComposer === 'beethoven' ? 108 :
                currentComposer === 'brahms' ? 92 :
                currentComposer === 'ravel' ? 72 :
                currentComposer === 'glass' ? 144 : 120;
        }
        
        // Initialize with one section
        function initialize() {
            addSection();
            updateComposerIndicator();
        }
        
        // Add a new section
        function addSection() {
            const sectionNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            const sectionName = sectionNames[sections.length % sectionNames.length];
            
            const section = {
                id: `section-${sectionCounter}`,
                name: sectionName,
                type: sections.length === 0 ? 'intro' : 
                      sections.length === 1 ? 'theme' : 
                      sections.length === 2 ? 'development' : 'recapitulation'
            };
            
            sections.push(section);
            sectionCounter++;
            renderSections();
        }
        
        // Remove a section
        function removeSection(id) {
            if (sections.length > 1) {
                sections = sections.filter(s => s.id !== id);
                renderSections();
            } else {
                showStatus('Must have at least one section', 'error');
            }
        }
        
        // Render all sections
        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = sections.map(section => `
                <div class="section-container">
                    <div class="section-header">
                        <h2>Section ${section.name}: ${section.type.charAt(0).toUpperCase() + section.type.slice(1)}</h2>
                        ${sections.length > 1 ? 
                            `<button class="remove-section" onclick="removeSection('${section.id}')">Remove</button>` 
                            : ''}
                    </div>
                    <div class="section-controls">
                        <div class="style-indicator">
                            This section will be generated in the style of <strong>${COMPOSER_PROFILES[currentComposer]?.name || 'Bach'}</strong>
                            with ${section.type === 'intro' ? 'introductory material' :
                                   section.type === 'theme' ? 'main thematic content' :
                                   section.type === 'development' ? 'developed variations' :
                                   'return of themes'}.
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Generate the score with composer-specific patterns
        function generateScore() {
            try {
                const title = document.getElementById('title').value;
                const tempo = parseInt(document.getElementById('tempo').value);
                const measuresPerSection = parseInt(document.getElementById('measuresPerSection').value);
                const globalKey = document.getElementById('globalKey').value;
                const profile = COMPOSER_PROFILES[currentComposer];
                
                // Build MusicXML
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                let musicXML = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <work>
    <work-title>${title} (${profile.name} Style) - ${timestamp}</work-title>
  </work>
  <identification>
    <creator type="composer">Generated in style of ${profile.name}</creator>
    <encoding>
      <software>Quintet Composer v10.4</software>
      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
    </encoding>
  </identification>
  <part-list>
    <score-part id="P1">
      <part-name>Guitar</part-name>
    </score-part>
    <score-part id="P2">
      <part-name>Violin I</part-name>
    </score-part>
    <score-part id="P3">
      <part-name>Violin II</part-name>
    </score-part>
    <score-part id="P4">
      <part-name>Viola</part-name>
    </score-part>
    <score-part id="P5">
      <part-name>Cello</part-name>
    </score-part>
  </part-list>`;
                
                // Generate parts with composer-specific patterns
                const instruments = ['guitar', 'violin1', 'violin2', 'viola', 'cello'];
                const partIds = ['P1', 'P2', 'P3', 'P4', 'P5'];
                
                instruments.forEach((instrument, index) => {
                    musicXML += generateComposerPart(
                        partIds[index],
                        instrument,
                        sections,
                        measuresPerSection,
                        tempo,
                        globalKey,
                        profile
                    );
                });
                
                musicXML += '\n</score-partwise>';
                
                currentScore = musicXML;
                document.getElementById('exportBtn').disabled = false;
                showStatus(`Score generated in ${profile.name} style!`, 'success');
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // Generate part with composer-specific patterns
        function generateComposerPart(partId, instrument, sections, measuresPerSection, tempo, key, profile) {
            let partXML = `\n  <part id="${partId}">`;
            let measureNumber = 1;
            
            sections.forEach((section, sectionIndex) => {
                for (let m = 0; m < measuresPerSection; m++) {
                    partXML += `\n    <measure number="${measureNumber}">`;
                    
                    // Add attributes for first measure
                    if (measureNumber === 1) {
                        partXML += generateAttributes(key, instrument, tempo);
                    }
                    
                    // Add section marker
                    if (m === 0) {
                        partXML += `\n      <direction placement="above">
        <direction-type>
          <rehearsal>${section.name}</rehearsal>
        </direction-type>
      </direction>`;
                        
                        // Add dynamics based on composer style
                        const dynamics = profile.dynamics[sectionIndex % profile.dynamics.length];
                        partXML += `\n      <direction placement="below">
        <direction-type>
          <dynamics>
            <${dynamics}/>
          </dynamics>
        </direction-type>
      </direction>`;
                    }
                    
                    // Generate notes based on composer profile
                    partXML += generateComposerNotes(
                        instrument, profile, section, m, key
                    );
                    
                    partXML += `\n    </measure>`;
                    measureNumber++;
                }
            });
            
            partXML += `\n  </part>`;
            return partXML;
        }
        
        // Generate composer-specific notes
        function generateComposerNotes(instrument, profile, section, measure, key) {
            let xml = '';
            
            // Get pattern from composer profile
            let pattern = [];
            if (profile.generatePattern) {
                pattern = profile.generatePattern(instrument, measure);
            }
            
            // Different rhythm patterns based on composer
            if (currentComposer === 'bach') {
                // Continuous 16th notes
                if (instrument === 'violin1' && section.type === 'theme') {
                    // Fugue subject enters
                    const subject = ['G', 'F', 'E', 'F', 'D', 'rest', 'G', 'G'];
                    for (let note of subject) {
                        if (note === 'rest') {
                            xml += createRest(2);
                        } else {
                            xml += createNote(note, 4, 0, 2); // 16th notes
                        }
                    }
                } else if (instrument === 'cello') {
                    // Walking bass
                    for (let i = 0; i < 8; i++) {
                        const bassNotes = ['C', 'D', 'E', 'F', 'G', 'F', 'E', 'D'];
                        xml += createNote(bassNotes[i % 8], 2, 0, 2);
                    }
                } else {
                    // Continuous motion
                    for (let i = 0; i < 8; i++) {
                        const notes = pattern.length > 0 ? pattern : ['C', 'E', 'G', 'E'];
                        xml += createNote(notes[i % notes.length], getOctave(instrument), 0, 2);
                    }
                }
                
            } else if (currentComposer === 'mozart') {
                // Elegant classical style
                if (instrument === 'guitar' && profile.specialty === 'alberti_bass') {
                    // Alberti bass pattern
                    const alberti = ['C', 'G', 'E', 'G'];
                    for (let beat = 0; beat < 4; beat++) {
                        xml += createNote(alberti[beat], 3, 0, 4);
                    }
                } else if (instrument === 'violin1') {
                    // Melodic line
                    const melody = pattern.length > 0 ? pattern.slice(0, 4) : ['E', 'F', 'G', 'E'];
                    for (let note of melody) {
                        xml += createNote(note, 5, 0, 4);
                    }
                } else {
                    // Simple accompaniment
                    xml += createNote('C', getOctave(instrument), 0, 8); // Half note
                    xml += createNote('G', getOctave(instrument), 0, 8); // Half note
                }
                
            } else if (currentComposer === 'beethoven') {
                // Dramatic motivic style
                if (instrument === 'violin1' && section.type === 'theme') {
                    // Fate motif
                    xml += createNote('G', 4, 0, 3);
                    xml += createNote('G', 4, 0, 3);
                    xml += createNote('G', 4, 0, 3);
                    xml += createNote('E', 4, -1, 7); // Eb as long note
                } else {
                    // Supporting dramatic texture
                    xml += createNote('C', getOctave(instrument), 0, 4);
                    xml += createRest(4);
                    xml += createNote('G', getOctave(instrument), 0, 4);
                    xml += createRest(4);
                }
                
            } else if (currentComposer === 'brahms') {
                // Dense romantic style with hemiola
                if (profile.rhythm === 'hemiola' && instrument === 'violin1') {
                    // 3 against 2
                    for (let i = 0; i < 3; i++) {
                        const notes = ['A', 'C', 'E'];
                        xml += createNote(notes[i], 5, 0, 5, false, false, true, 3, 2);
                    }
                    xml += createRest(1);
                } else {
                    // Rich inner voices
                    const innerVoice = pattern.length > 0 ? pattern.slice(0, 4) : ['E', 'F', 'E', 'D'];
                    for (let note of innerVoice) {
                        xml += createNote(note, getOctave(instrument), 0, 4);
                    }
                }
                
            } else if (currentComposer === 'ravel') {
                // Impressionistic style
                if (instrument === 'guitar' && section.type === 'theme') {
                    // Bolero rhythm
                    xml += createNote('C', 3, 0, 3);
                    xml += createRest(1);
                    xml += createNote('C', 3, 0, 2);
                    xml += createNote('C', 3, 0, 2);
                    xml += createRest(1);
                    xml += createNote('C', 3, 0, 3);
                    xml += createNote('C', 3, 0, 2);
                    xml += createRest(2);
                } else if (instrument === 'violin1') {
                    // Modal melody (Dorian mode)
                    const dorian = ['D', 'E', 'F', 'G'];
                    for (let note of dorian) {
                        xml += createNote(note, 5, 0, 4);
                    }
                } else {
                    // Sustained pedal
                    xml += createNote('D', getOctave(instrument), 0, 16);
                }
                
            } else if (currentComposer === 'glass') {
                // Minimalist repetitive style
                const additivePattern = measure % 2 === 0 ? 
                    ['C', 'C', 'C', 'D', 'D', 'D', 'E', 'E'] : // 3+3+2
                    ['E', 'E', 'D', 'D', 'D', 'C', 'C', 'C'];  // 2+3+3
                    
                for (let i = 0; i < additivePattern.length; i++) {
                    xml += createNote(additivePattern[i], getOctave(instrument), 0, 2);
                }
            }
            
            return xml;
        }
        
        // Helper function to create attributes
        function generateAttributes(key, instrument, tempo) {
            const keyFifths = {
                'C': 0, 'G': 1, 'D': 2, 'F': -1, 'Am': 0, 'Em': 1
            };
            
            return `\n      <attributes>
        <divisions>4</divisions>
        <key>
          <fifths>${keyFifths[key] || 0}</fifths>
        </key>
        <time>
          <beats>4</beats>
          <beat-type>4</beat-type>
        </time>
        <clef>
          <sign>${instrument === 'cello' ? 'F' : instrument === 'viola' ? 'C' : 'G'}</sign>
          <line>${instrument === 'cello' ? '4' : instrument === 'viola' ? '3' : '2'}</line>
        </clef>
      </attributes>
      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${tempo}</per-minute>
          </metronome>
        </direction-type>
      </direction>`;
        }
        
        // Helper function to create a note
        function createNote(pitch, octave, alter, duration, isChord = false, articulation = null, tuplet = false, tupletNum = 0, tupletBase = 0) {
            let xml = '\n      <note>';
            
            if (isChord) {
                xml += '\n        <chord/>';
            }
            
            xml += '\n        <pitch>';
            xml += `\n          <step>${pitch.charAt(0)}</step>`;
            
            if (alter !== 0 || pitch.includes('#') || pitch.includes('b')) {
                const alterValue = pitch.includes('#') ? 1 : pitch.includes('b') ? -1 : alter;
                if (alterValue !== 0) {
                    xml += `\n          <alter>${alterValue}</alter>`;
                }
            }
            
            xml += `\n          <octave>${octave}</octave>`;
            xml += '\n        </pitch>';
            xml += `\n        <duration>${duration}</duration>`;
            xml += `\n        <type>${getDurationType(duration)}</type>`;
            
            if (tuplet && tupletNum > 0) {
                xml += '\n        <time-modification>';
                xml += `\n          <actual-notes>${tupletNum}</actual-notes>`;
                xml += `\n          <normal-notes>${tupletBase}</normal-notes>`;
                xml += '\n        </time-modification>';
            }
            
            if (articulation) {
                xml += '\n        <notations>';
                if (articulation === 'staccato') {
                    xml += '\n          <articulations>\n            <staccato/>\n          </articulations>';
                } else if (articulation === 'sforzando') {
                    xml += '\n          <articulations>\n            <strong-accent/>\n          </articulations>';
                }
                xml += '\n        </notations>';
            }
            
            xml += '\n      </note>';
            return xml;
        }
        
        // Helper function to create a rest
        function createRest(duration) {
            return `\n      <note>
        <rest/>
        <duration>${duration}</duration>
        <type>${getDurationType(duration)}</type>
      </note>`;
        }
        
        // Get duration type
        function getDurationType(duration) {
            if (duration >= 16) return 'whole';
            if (duration >= 8) return 'half';
            if (duration >= 4) return 'quarter';
            if (duration >= 2) return 'eighth';
            if (duration >= 1) return '16th';
            return '32nd';
        }
        
        // Get octave for instrument
        function getOctave(instrument) {
            const octaves = {
                'guitar': 3,
                'violin1': 5,
                'violin2': 4,
                'viola': 3,
                'cello': 2
            };
            return octaves[instrument] || 4;
        }
        
        // Export MusicXML
        function exportMusicXML() {
            if (!currentScore) {
                showStatus('No score to export! Generate a score first.', 'error');
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const composer = COMPOSER_PROFILES[currentComposer].name.replace(/\s+/g, '_');
            const blob = new Blob([currentScore], { type: 'application/vnd.recordare.musicxml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quintet-${composer}-v10.4-${timestamp}.musicxml`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('MusicXML file exported successfully!', 'success');
        }
        
        // Reset all
        function resetAll() {
            sections = [];
            sectionCounter = 0;
            currentScore = null;
            currentComposer = 'bach';
            document.getElementById('exportBtn').disabled = true;
            document.querySelectorAll('.composer-card').forEach(c => c.classList.remove('selected'));
            document.querySelector('[data-composer="bach"]').classList.add('selected');
            initialize();
            showStatus('All settings reset', 'info');
        }
        
        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            setTimeout(() => {
                status.textContent = '';
                status.className = 'status';
            }, 5000);
        }
        
        // Initialize on load
        initialize();
    </script>
</body>
</html>