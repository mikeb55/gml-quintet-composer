<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer v12.28 - Safe Working</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #5a67d8;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .version {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .section-type-buttons {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .section-type-buttons h3 {
            color: #92400e;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .section-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .section-type-btn {
            background: white;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            text-align: center;
        }
        
        .section-type-btn:hover {
            background: #f59e0b;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .section-type-btn.exposition::before { content: "üìñ "; }
        .section-type-btn.development::before { content: "üîÑ "; }
        .section-type-btn.recapitulation::before { content: "üîÅ "; }
        .section-type-btn.coda::before { content: "üéµ "; }
        .section-type-btn.custom::before { content: "‚ú® "; }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20863d 100%);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        
        .section h4 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .section-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº Quintet Composer v12.28</h1>
        <p class="version">Safe Working Version - No Sibelius Crashes</p>
        
        <div class="section-type-buttons">
            <h3>Section Types</h3>
            <div class="section-type-grid">
                <button class="section-type-btn exposition" onclick="addSection('exposition')">Exposition</button>
                <button class="section-type-btn development" onclick="addSection('development')">Development</button>
                <button class="section-type-btn recapitulation" onclick="addSection('recapitulation')">Recapitulation</button>
                <button class="section-type-btn coda" onclick="addSection('coda')">Coda</button>
                <button class="section-type-btn custom" onclick="addSection('custom')">Custom</button>
            </div>
        </div>
        
        <div class="controls-grid">
            <div class="control-group">
                <label>Composition Title</label>
                <input type="text" id="title" value="Quintet in C Major - Safe Version">
            </div>
            
            <div class="control-group">
                <label>Key Signature</label>
                <select id="key">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="F">F Major</option>
                    <option value="Bb">B‚ô≠ Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Time Signature</label>
                <select id="timeSignature">
                    <option value="4/4">4/4 (Common)</option>
                    <option value="3/4">3/4 (Waltz)</option>
                    <option value="6/8">6/8 (Compound)</option>
                    <option value="2/4">2/4 (March)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Composer Style</label>
                <select id="composer">
                    <option value="bach">J.S. Bach (Baroque)</option>
                    <option value="mozart">W.A. Mozart (Classical)</option>
                    <option value="beethoven">L. Beethoven (Romantic)</option>
                    <option value="brahms">J. Brahms (Late Romantic)</option>
                    <option value="debussy">C. Debussy (Impressionist)</option>
                </select>
            </div>
        </div>
        
        <div id="sections-container">
            <!-- Sections will be added here -->
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="generateComposition()">Generate Composition</button>
            <button class="btn btn-success" onclick="exportMusicXML()">Export MusicXML</button>
            <button class="btn btn-secondary" onclick="exportMIDI()">Export MIDI</button>
        </div>
        
        <div class="status" id="status"></div>
    </div>

    <script>
        // ==================== SAFE QUINTET COMPOSER ====================
        
        class SafeQuintetComposer {
            constructor() {
                this.composition = null;
                this.sections = [];
                this.divisions = 256; // Safe divisions value
                
                this.instruments = {
                    'guitar': { name: 'Guitar', clef: 'G', line: 2, range: [48, 84] },
                    'violin1': { name: 'Violin I', clef: 'G', line: 2, range: [55, 88] },
                    'violin2': { name: 'Violin II', clef: 'G', line: 2, range: [55, 84] },
                    'viola': { name: 'Viola', clef: 'C', line: 3, range: [48, 76] },
                    'cello': { name: 'Cello', clef: 'F', line: 4, range: [36, 72] }
                };
                
                this.composers = {
                    'bach': { name: 'J.S. Bach', style: 'contrapuntal' },
                    'mozart': { name: 'W.A. Mozart', style: 'elegant' },
                    'beethoven': { name: 'L. Beethoven', style: 'dramatic' },
                    'brahms': { name: 'J. Brahms', style: 'complex' },
                    'debussy': { name: 'C. Debussy', style: 'impressionist' }
                };
            }
            
            addSection(type) {
                const section = {
                    id: Date.now(),
                    type: type,
                    name: this.getSectionName(type),
                    measures: 8,
                    key: document.getElementById('key').value,
                    composer: document.getElementById('composer').value,
                    instruments: {
                        'guitar': 'chords',
                        'violin1': 'melody',
                        'violin2': 'harmony',
                        'viola': 'harmony',
                        'cello': 'bassline'
                    }
                };
                
                this.sections.push(section);
                this.renderSections();
                showStatus(`Added ${section.name} section`, 'success');
            }
            
            getSectionName(type) {
                const names = {
                    'exposition': 'Exposition',
                    'development': 'Development',
                    'recapitulation': 'Recapitulation',
                    'coda': 'Coda',
                    'custom': 'Custom Section'
                };
                return names[type] || 'Section';
            }
            
            renderSections() {
                const container = document.getElementById('sections-container');
                container.innerHTML = '';
                
                this.sections.forEach((section, index) => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'section';
                    sectionDiv.innerHTML = `
                        <h4>${section.name} (${section.measures} measures)</h4>
                        <div class="section-controls">
                            <div class="control-group">
                                <label>Measures</label>
                                <input type="number" value="${section.measures}" min="1" max="32" 
                                       onchange="updateSectionMeasures(${index}, this.value)">
                            </div>
                            <div class="control-group">
                                <label>Key</label>
                                <select onchange="updateSectionKey(${index}, this.value)">
                                    <option value="C" ${section.key === 'C' ? 'selected' : ''}>C Major</option>
                                    <option value="G" ${section.key === 'G' ? 'selected' : ''}>G Major</option>
                                    <option value="D" ${section.key === 'D' ? 'selected' : ''}>D Major</option>
                                    <option value="A" ${section.key === 'A' ? 'selected' : ''}>A Major</option>
                                    <option value="F" ${section.key === 'F' ? 'selected' : ''}>F Major</option>
                                    <option value="Bb" ${section.key === 'Bb' ? 'selected' : ''}>B‚ô≠ Major</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Composer</label>
                                <select onchange="updateSectionComposer(${index}, this.value)">
                                    <option value="bach" ${section.composer === 'bach' ? 'selected' : ''}>Bach</option>
                                    <option value="mozart" ${section.composer === 'mozart' ? 'selected' : ''}>Mozart</option>
                                    <option value="beethoven" ${section.composer === 'beethoven' ? 'selected' : ''}>Beethoven</option>
                                    <option value="brahms" ${section.composer === 'brahms' ? 'selected' : ''}>Brahms</option>
                                    <option value="debussy" ${section.composer === 'debussy' ? 'selected' : ''}>Debussy</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <button class="btn btn-secondary" onclick="removeSection(${index})">Remove</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(sectionDiv);
                });
            }
            
            generateComposition() {
                if (this.sections.length === 0) {
                    showStatus('Please add at least one section!', 'error');
                    return;
                }
                
                this.composition = {
                    title: document.getElementById('title').value,
                    key: document.getElementById('key').value,
                    timeSignature: document.getElementById('timeSignature').value,
                    composer: document.getElementById('composer').value,
                    sections: this.sections,
                    parts: {}
                };
                
                // Generate each instrument part
                Object.keys(this.instruments).forEach(inst => {
                    this.composition.parts[inst] = this.generatePart(inst);
                });
                
                showStatus('Composition generated successfully!', 'success');
            }
            
            generatePart(instrument) {
                const part = [];
                let measureNumber = 1;
                
                this.sections.forEach(section => {
                    for (let m = 0; m < section.measures; m++) {
                        const measure = this.generateMeasure(instrument, section, measureNumber);
                        part.push(measure);
                        measureNumber++;
                    }
                });
                
                return part;
            }
            
            generateMeasure(instrument, section, measureNumber) {
                const measure = [];
                const instData = this.instruments[instrument];
                const composer = this.composers[section.composer];
                
                // Generate simple, safe rhythm pattern
                const rhythmPattern = this.getSafeRhythmPattern(composer.style);
                
                rhythmPattern.forEach(rhythm => {
                    const note = this.generateSafeNote(instrument, section, rhythm);
                    measure.push(note);
                });
                
                return measure;
            }
            
            getSafeRhythmPattern(style) {
                // Simple, safe patterns that won't crash Sibelius
                const patterns = {
                    'contrapuntal': [
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions }
                    ],
                    'elegant': [
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions },
                        { type: 'half', duration: this.divisions * 2 }
                    ],
                    'dramatic': [
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions }
                    ],
                    'complex': [
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions },
                        { type: 'quarter', duration: this.divisions }
                    ],
                    'impressionist': [
                        { type: 'half', duration: this.divisions * 2 },
                        { type: 'half', duration: this.divisions * 2 }
                    ]
                };
                
                return patterns[style] || patterns['elegant'];
            }
            
            generateSafeNote(instrument, section, rhythm) {
                const instData = this.instruments[instrument];
                const scale = this.getScale(section.key);
                
                // Generate safe pitch within range
                const pitch = this.generateSafePitch(scale, instData.range);
                
                return {
                    pitch: pitch.note,
                    octave: pitch.octave,
                    duration: rhythm.duration,
                    type: rhythm.type,
                    instrument: instrument
                };
            }
            
            generateSafePitch(scale, range) {
                const [minMidi, maxMidi] = range;
                const midiNote = Math.floor(Math.random() * (maxMidi - minMidi + 1)) + minMidi;
                const octave = Math.floor(midiNote / 12) - 1;
                const noteIndex = midiNote % 12;
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                return {
                    note: noteNames[noteIndex],
                    octave: octave,
                    midi: midiNote
                };
            }
            
            getScale(key) {
                const scales = {
                    'C': ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
                    'G': ['G', 'A', 'B', 'C', 'D', 'E', 'F#'],
                    'D': ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'],
                    'A': ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'],
                    'F': ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'],
                    'Bb': ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A']
                };
                return scales[key] || scales['C'];
            }
            
            // ==================== SAFE MUSICXML EXPORT ====================
            
            exportMusicXML() {
                if (!this.composition) {
                    showStatus('Please generate a composition first!', 'error');
                    return;
                }
                
                try {
                    let xml = this.generateSafeMusicXMLHeader();
                    xml += this.generatePartList();
                    
                    // Generate each part
                    Object.keys(this.instruments).forEach((inst, index) => {
                        xml += this.generateSafePartXML(inst, index + 1);
                    });
                    
                    xml += '</score-partwise>';
                    
                    this.downloadXML(xml);
                    showStatus('Safe MusicXML exported successfully!', 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    showStatus(`Export error: ${error.message}`, 'error');
                }
            }
            
            generateSafeMusicXMLHeader() {
                return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <work>
    <work-title>${this.composition.title}</work-title>
  </work>
  <identification>
    <creator type="composer">Quintet Composer v12.28</creator>
    <encoding>
      <software>Quintet Composer v12.28</software>
      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
    </encoding>
  </identification>`;
            }
            
            generatePartList() {
                let xml = '  <part-list>\n';
                Object.keys(this.instruments).forEach((inst, index) => {
                    xml += `    <score-part id="P${index + 1}">\n`;
                    xml += `      <part-name>${this.instruments[inst].name}</part-name>\n`;
                    xml += `    </score-part>\n`;
                });
                xml += '  </part-list>\n';
                return xml;
            }
            
            generateSafePartXML(instrument, partNumber) {
                const instData = this.instruments[instrument];
                const part = this.composition.parts[instrument];
                let xml = `  <part id="P${partNumber}">\n`;
                
                part.forEach((measure, measureIndex) => {
                    xml += `    <measure number="${measureIndex + 1}">\n`;
                    
                    // Add attributes to first measure only
                    if (measureIndex === 0) {
                        xml += this.generateSafeAttributes(instrument);
                    }
                    
                    // Add notes
                    measure.forEach(note => {
                        xml += this.generateSafeNoteXML(note);
                    });
                    
                    xml += '    </measure>\n';
                });
                
                xml += '  </part>\n';
                return xml;
            }
            
            generateSafeAttributes(instrument) {
                const instData = this.instruments[instrument];
                const keyFifths = this.getKeyFifths(this.composition.key);
                const timeSignature = this.composition.timeSignature;
                const [beats, beatType] = timeSignature.split('/');
                
                return `      <attributes>
        <divisions>${this.divisions}</divisions>
        <key>
          <fifths>${keyFifths}</fifths>
        </key>
        <time>
          <beats>${beats}</beats>
          <beat-type>${beatType}</beat-type>
        </time>
        <clef>
          <sign>${instData.clef}</sign>
          <line>${instData.line}</line>
        </clef>
      </attributes>\n`;
            }
            
            generateSafeNoteXML(note) {
                // SAFE XML generation - no stray text
                let xml = '      <note>\n';
                
                if (note.pitch === 'rest') {
                    xml += '        <rest/>\n';
                } else {
                    xml += '        <pitch>\n';
                    xml += `          <step>${note.pitch}</step>\n`;
                    xml += `          <octave>${note.octave}</octave>\n`;
                    xml += '        </pitch>\n';
                }
                
                xml += `        <duration>${note.duration}</duration>\n`;
                xml += `        <type>${note.type}</type>\n`;
                xml += '      </note>\n';
                
                return xml;
            }
            
            getKeyFifths(key) {
                const keySignatures = {
                    'C': 0, 'G': 1, 'D': 2, 'A': 3, 'E': 4, 'B': 5, 'F#': 6,
                    'F': -1, 'Bb': -2, 'Eb': -3, 'Ab': -4, 'Db': -5, 'Gb': -6
                };
                return keySignatures[key] || 0;
            }
            
            downloadXML(xml) {
                const blob = new Blob([xml], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quintet-safe-${Date.now()}.musicxml`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            exportMIDI() {
                showStatus('MIDI export coming soon!', 'info');
            }
        }
        
        // ==================== GLOBAL FUNCTIONS ====================
        
        const composer = new SafeQuintetComposer();
        
        function addSection(type) {
            composer.addSection(type);
        }
        
        function removeSection(index) {
            composer.sections.splice(index, 1);
            composer.renderSections();
            showStatus('Section removed', 'info');
        }
        
        function updateSectionMeasures(index, measures) {
            composer.sections[index].measures = parseInt(measures);
            showStatus('Section updated', 'info');
        }
        
        function updateSectionKey(index, key) {
            composer.sections[index].key = key;
            showStatus('Section updated', 'info');
        }
        
        function updateSectionComposer(index, composer) {
            composer.sections[index].composer = composer;
            showStatus('Section updated', 'info');
        }
        
        function generateComposition() {
            composer.generateComposition();
        }
        
        function exportMusicXML() {
            composer.exportMusicXML();
        }
        
        function exportMIDI() {
            composer.exportMIDI();
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        // Initialize
        showStatus('Safe Quintet Composer v12.28 Ready!', 'info');
    </script>
</body>
</html>

