<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>String Quintet Composer v16 - Fixed & Harmonized</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1000px;
            width: 100%;
            padding: 40px;
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .version {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .version .status {
            color: #4CAF50;
            font-weight: bold;
        }

        .instruments-display {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .control-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 150px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 5px;
        }

        #generateBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #playBtn {
            background: #4CAF50;
            color: white;
        }

        #stopBtn {
            background: #f44336;
            color: white;
        }

        #exportMidiBtn {
            background: #2196F3;
            color: white;
        }

        #exportXmlBtn {
            background: #FF9800;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #output {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            min-height: 150px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stops-controls {
            background: #fff9e6;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .progression-display {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº String Quintet Composer</h1>
        <div class="version">
            v16.0 - <span class="status">‚úì FIXED: Harmonic Progressions Added</span>
        </div>
        
        <div class="instruments-display">
            <strong>Instruments:</strong> üé∏ Guitar | üéª Violin I | üéª Violin II | üéª Viola | üéª Cello
        </div>

        <div class="control-panel">
            <div class="control-row">
                <div class="control-group">
                    <label for="composer">Composer Style</label>
                    <select id="composer">
                        <option value="classical">Classical (Haydn)</option>
                        <option value="romantic">Romantic (Brahms)</option>
                        <option value="modern">Modern (Bart√≥k)</option>
                        <option value="minimalist">Minimalist (Glass)</option>
                        <option value="impressionist">Impressionist (Debussy)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="tempo">Tempo (BPM)</label>
                    <input type="number" id="tempo" min="60" max="200" value="120">
                </div>
                <div class="control-group">
                    <label for="measures">Measures</label>
                    <input type="number" id="measures" min="4" max="32" value="8">
                </div>
            </div>
            
            <div class="control-row">
                <div class="control-group">
                    <label for="key">Key</label>
                    <select id="key">
                        <option value="C">C Major</option>
                        <option value="G">G Major</option>
                        <option value="D">D Major</option>
                        <option value="A">A Major</option>
                        <option value="F">F Major</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="timeSignature">Time Signature</label>
                    <select id="timeSignature">
                        <option value="4/4">4/4</option>
                        <option value="3/4">3/4</option>
                        <option value="6/8">6/8</option>
                    </select>
                </div>
            </div>

            <div style="padding: 10px; background: #f0f0ff; border-radius: 8px; margin-top: 15px;">
                <label>
                    <input type="checkbox" id="enableStops">
                    Enable Multiple Stops (Strings Only)
                </label>
            </div>
            
            <div class="stops-controls" id="stopsControls" style="display: none;">
                <div class="control-group">
                    <label>Double Stops: <span id="doubleValue">20</span>%</label>
                    <input type="range" id="doubleStops" min="0" max="50" value="20" 
                           oninput="document.getElementById('doubleValue').textContent = this.value">
                </div>
                <div class="control-group">
                    <label>Triple Stops: <span id="tripleValue">10</span>%</label>
                    <input type="range" id="tripleStops" min="0" max="30" value="10"
                           oninput="document.getElementById('tripleValue').textContent = this.value">
                </div>
                <div class="control-group">
                    <label>Quadruple Stops: <span id="quadValue">5</span>%</label>
                    <input type="range" id="quadrupleStops" min="0" max="20" value="5"
                           oninput="document.getElementById('quadValue').textContent = this.value">
                </div>
            </div>
            
            <div class="progression-display" id="progressionDisplay" style="display: none;">
                Chord Progression: <span id="progressionText"></span>
            </div>
            
            <div class="button-group">
                <button id="generateBtn">üé≤ Generate</button>
                <button id="playBtn" disabled>‚ñ∂Ô∏è Play</button>
                <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
                <button id="exportMidiBtn" disabled>üíæ Export MIDI</button>
                <button id="exportXmlBtn" disabled>üìÑ Export MusicXML</button>
            </div>
        </div>
        
        <div id="output">Click Generate to create your composition...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
    <script>
        // String Quintet Composer v16 - WITH HARMONIC PROGRESSIONS
        let composition = null;
        let synths = [];
        let parts = [];

        // Initialize synths for each instrument
        function initSynths() {
            for (let i = 0; i < 5; i++) {
                synths[i] = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: i === 0 ? 'triangle' : 'sawtooth' },
                    envelope: {
                        attack: 0.02,
                        decay: 0.1,
                        sustain: 0.3,
                        release: 0.8
                    }
                }).toDestination();
            }
        }

        // Chord progression definitions
        const progressions = {
            classical: ['I', 'IV', 'V', 'I', 'I', 'ii', 'V', 'I'],
            romantic: ['I', 'vi', 'IV', 'V', 'I', 'IV', 'V', 'I'],
            modern: ['I', 'bII', 'IV', 'v', 'I', 'iii', 'V', 'I'],
            minimalist: ['I', 'V', 'I', 'V', 'I', 'V', 'I', 'V'],
            impressionist: ['I', 'iii', 'vi', 'IV', 'ii', 'V', 'I', 'I']
        };

        // Convert chord symbols to actual notes
        function getChordNotes(key, chordSymbol) {
            const scales = {
                'C': [60, 62, 64, 65, 67, 69, 71],  // C D E F G A B
                'G': [67, 69, 71, 72, 74, 76, 78],  // G A B C D E F#
                'D': [62, 64, 66, 67, 69, 71, 73],  // D E F# G A B C#
                'A': [69, 71, 73, 74, 76, 78, 80],  // A B C# D E F# G#
                'F': [65, 67, 69, 70, 72, 74, 76]   // F G A Bb C D E
            };

            const scale = scales[key] || scales['C'];
            
            // Map chord symbols to scale degrees
            const chordMap = {
                'I': [0, 2, 4],      // Root, third, fifth
                'ii': [1, 3, 5],
                'iii': [2, 4, 6],
                'IV': [3, 5, 0],
                'V': [4, 6, 1],
                'vi': [5, 0, 2],
                'vii': [6, 1, 3],
                'v': [4, 6, 1],      // Minor dominant
                'bII': [1, 3, 5]     // Flat II
            };

            const degrees = chordMap[chordSymbol] || chordMap['I'];
            return {
                root: scale[degrees[0]],
                third: scale[degrees[1]], 
                fifth: scale[degrees[2]],
                all: degrees.map(d => scale[d % 7])
            };
        }

        // Stops validator
        const StopsValidator = {
            tunings: {
                violin: [55, 62, 69, 76],  // G3, D4, A4, E5
                viola: [48, 55, 62, 69],   // C3, G3, D4, A4
                cello: [36, 43, 50, 57]    // C2, G2, D3, A3
            },
            
            generateStop: function(basePitch, instrument, stopType) {
                const tuning = this.tunings[instrument];
                if (!tuning) return [basePitch];
                
                let numNotes = stopType === 'double' ? 2 : stopType === 'triple' ? 3 : 4;
                let stop = [basePitch];
                
                // Add notes using chord tones
                const intervals = [3, 4, 5, 7]; // thirds, fourths, fifths
                for (let i = 1; i < numNotes && stop.length < numNotes; i++) {
                    const interval = intervals[Math.floor(Math.random() * intervals.length)];
                    const note = basePitch + interval;
                    if (note >= tuning[0] && note <= tuning[3] + 12) {
                        stop.push(note);
                    }
                }
                
                return stop.sort((a, b) => a - b);
            }
        };

        // Generate composition with HARMONIC PROGRESSIONS
        function generate() {
            const tempo = parseInt(document.getElementById('tempo').value);
            const measures = parseInt(document.getElementById('measures').value);
            const key = document.getElementById('key').value;
            const timeSignature = document.getElementById('timeSignature').value;
            const composer = document.getElementById('composer').value;
            
            composition = {
                tempo: tempo,
                timeSignature: timeSignature,
                key: key,
                measures: [],
                instruments: ['Guitar', 'Violin I', 'Violin II', 'Viola', 'Cello'],
                progression: progressions[composer]
            };

            const [beats] = timeSignature.split('/').map(Number);
            
            // Show progression
            document.getElementById('progressionDisplay').style.display = 'block';
            document.getElementById('progressionText').textContent = composition.progression.join(' - ');

            // Generate measures with chord progressions
            for (let m = 0; m < measures; m++) {
                const measure = { number: m + 1, notes: [] };
                
                // Get current chord
                const chordSymbol = composition.progression[m % composition.progression.length];
                const chord = getChordNotes(key, chordSymbol);
                measure.chord = chordSymbol;

                // Generate for each instrument based on ROLE
                for (let inst = 0; inst < 5; inst++) {
                    for (let beat = 0; beat < beats; beat++) {
                        let pitch;
                        
                        // Assign roles to each instrument
                        switch(inst) {
                            case 0: // Guitar - plays chord roots
                                pitch = chord.root;
                                if (beat % 2 === 0) pitch = chord.root;
                                else pitch = chord.fifth - 12;
                                break;
                                
                            case 1: // Violin I - melody using chord tones
                                const melodyNotes = [chord.root + 12, chord.third + 12, chord.fifth + 12];
                                pitch = melodyNotes[Math.floor(Math.random() * melodyNotes.length)];
                                // Add passing notes occasionally
                                if (Math.random() < 0.3) pitch += Math.floor(Math.random() * 3) - 1;
                                break;
                                
                            case 2: // Violin II - harmony (thirds)
                                pitch = chord.third + 12;
                                if (beat % 2 === 1) pitch = chord.fifth + 12;
                                break;
                                
                            case 3: // Viola - inner voice
                                pitch = beat % 2 === 0 ? chord.fifth : chord.third;
                                break;
                                
                            case 4: // Cello - bass line
                                pitch = beat === 0 ? chord.root - 12 : chord.fifth - 12;
                                pitch = Math.max(36, Math.min(pitch, 60)); // Keep in range
                                break;
                        }

                        // Check for multiple stops (strings only, not guitar)
                        let multipleStop = null;
                        if (inst > 0 && document.getElementById('enableStops').checked) {
                            const doubleChance = parseInt(document.getElementById('doubleStops').value);
                            const tripleChance = parseInt(document.getElementById('tripleStops').value);
                            const quadChance = parseInt(document.getElementById('quadrupleStops').value);
                            
                            const rand = Math.random() * 100;
                            const instrumentName = inst === 1 || inst === 2 ? 'violin' : 
                                                 inst === 3 ? 'viola' : 'cello';
                            
                            if (rand < quadChance && beat === 0) {
                                multipleStop = StopsValidator.generateStop(pitch, instrumentName, 'quadruple');
                            } else if (rand < quadChance + tripleChance) {
                                multipleStop = StopsValidator.generateStop(pitch, instrumentName, 'triple');
                            } else if (rand < quadChance + tripleChance + doubleChance) {
                                multipleStop = StopsValidator.generateStop(pitch, instrumentName, 'double');
                            }
                        }

                        measure.notes.push({
                            instrument: inst,
                            pitch: pitch,
                            time: beat,
                            duration: 1,
                            velocity: 80,
                            multipleStop: multipleStop
                        });
                    }
                }
                
                composition.measures.push(measure);
            }

            Tone.Transport.bpm.value = tempo;
            updateDisplay();
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('exportMidiBtn').disabled = false;
            document.getElementById('exportXmlBtn').disabled = false;
        }

        // Update display
        function updateDisplay() {
            let output = `Generated ${composition.measures.length} measures in ${composition.key} Major\n`;
            output += `Tempo: ${composition.tempo} BPM | Time: ${composition.timeSignature}\n`;
            output += `Progression: ${composition.progression.join(' - ')}\n\n`;
            
            let stopsCount = { double: 0, triple: 0, quadruple: 0 };
            
            composition.measures.forEach(measure => {
                output += `Measure ${measure.number} [${measure.chord}]:\n`;
                composition.instruments.forEach((inst, idx) => {
                    const notes = measure.notes.filter(n => n.instrument === idx);
                    const stops = notes.filter(n => n.multipleStop).length;
                    
                    notes.forEach(n => {
                        if (n.multipleStop) {
                            if (n.multipleStop.length === 2) stopsCount.double++;
                            else if (n.multipleStop.length === 3) stopsCount.triple++;
                            else if (n.multipleStop.length === 4) stopsCount.quadruple++;
                        }
                    });
                    
                    output += `  ${inst}: ${notes.length} notes`;
                    if (stops > 0) output += ` [${stops} stops]`;
                    output += '\n';
                });
                output += '\n';
            });
            
            if (document.getElementById('enableStops').checked) {
                output += `\nMultiple Stops: Double=${stopsCount.double}, Triple=${stopsCount.triple}, Quadruple=${stopsCount.quadruple}`;
            }
            
            document.getElementById('output').textContent = output;
        }

        // Play composition
        function play() {
            if (!composition) return;
            
            stop(); // Clear any existing playback
            
            composition.measures.forEach(measure => {
                measure.notes.forEach(note => {
                    const time = `${measure.number - 1}:${note.time}:0`;
                    
                    if (note.multipleStop && note.multipleStop.length > 1) {
                        // Play multiple notes
                        note.multipleStop.forEach(pitch => {
                            const part = new Tone.Part((time, value) => {
                                synths[value.inst].triggerAttackRelease(value.pitch, '4n', time);
                            }, [{time: time, pitch: Tone.Frequency(pitch, 'midi'), inst: note.instrument}]).start(0);
                            parts.push(part);
                        });
                    } else {
                        // Play single note
                        const part = new Tone.Part((time, value) => {
                            synths[value.inst].triggerAttackRelease(value.pitch, '4n', time);
                        }, [{time: time, pitch: Tone.Frequency(note.pitch, 'midi'), inst: note.instrument}]).start(0);
                        parts.push(part);
                    }
                });
            });
            
            Tone.Transport.start();
            
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        }

        // Stop playback
        function stop() {
            parts.forEach(part => {
                part.stop();
                part.dispose();
            });
            parts = [];
            
            Tone.Transport.stop();
            Tone.Transport.position = 0;
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        // Export MIDI
        function exportMIDI() {
            if (!composition) return;
            
            const ticksPerQuarter = 480;
            const tracks = [];
            
            // MIDI header and tempo track
            const tempoTrack = [];
            const microsecondsPerQuarter = Math.round(60000000 / composition.tempo);
            tempoTrack.push(0x00, 0xFF, 0x51, 0x03);
            tempoTrack.push((microsecondsPerQuarter >> 16) & 0xFF);
            tempoTrack.push((microsecondsPerQuarter >> 8) & 0xFF);
            tempoTrack.push(microsecondsPerQuarter & 0xFF);
            tempoTrack.push(0x00, 0xFF, 0x2F, 0x00);
            tracks.push(tempoTrack);
            
            // Create tracks for each instrument
            const midiPrograms = [24, 40, 40, 41, 42]; // Guitar, Violin, Violin, Viola, Cello
            
            for (let inst = 0; inst < 5; inst++) {
                const track = [];
                const events = [];
                
                // Program change
                track.push(0x00, 0xC0 | inst, midiPrograms[inst]);
                
                // Collect notes
                composition.measures.forEach((measure, mIdx) => {
                    const instNotes = measure.notes.filter(n => n.instrument === inst);
                    instNotes.forEach(note => {
                        const startTick = (mIdx * 4 + note.time) * ticksPerQuarter;
                        const endTick = startTick + ticksPerQuarter;
                        
                        if (note.multipleStop && note.multipleStop.length > 1) {
                            note.multipleStop.forEach(pitch => {
                                events.push({ tick: startTick, type: 'on', pitch: pitch });
                                events.push({ tick: endTick, type: 'off', pitch: pitch });
                            });
                        } else {
                            events.push({ tick: startTick, type: 'on', pitch: note.pitch });
                            events.push({ tick: endTick, type: 'off', pitch: note.pitch });
                        }
                    });
                });
                
                // Sort and write events
                events.sort((a, b) => a.tick - b.tick || (a.type === 'off' ? -1 : 1));
                
                let currentTick = 0;
                events.forEach(event => {
                    const delta = event.tick - currentTick;
                    if (delta < 128) {
                        track.push(delta);
                    } else {
                        track.push(((delta >> 7) & 0x7F) | 0x80, delta & 0x7F);
                    }
                    
                    if (event.type === 'on') {
                        track.push(0x90 | inst, event.pitch, 80);
                    } else {
                        track.push(0x80 | inst, event.pitch, 0);
                    }
                    currentTick = event.tick;
                });
                
                track.push(0x00, 0xFF, 0x2F, 0x00);
                tracks.push(track);
            }
            
            // Build MIDI file
            const header = [0x4D, 0x54, 0x68, 0x64, 0x00, 0x00, 0x00, 0x06, 
                          0x00, 0x01, 0x00, tracks.length,
                          (ticksPerQuarter >> 8) & 0xFF, ticksPerQuarter & 0xFF];
            
            let midiData = [...header];
            tracks.forEach(track => {
                midiData.push(0x4D, 0x54, 0x72, 0x6B);
                const len = track.length;
                midiData.push((len >> 24) & 0xFF, (len >> 16) & 0xFF, 
                            (len >> 8) & 0xFF, len & 0xFF);
                midiData.push(...track);
            });
            
            // Download
            const blob = new Blob([new Uint8Array(midiData)], { type: 'audio/midi' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'string_quintet.mid';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Export MusicXML
        function exportMusicXML() {
            if (!composition) return;
            
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">\n';
            xml += '<score-partwise version="3.1">\n';
            xml += '  <part-list>\n';
            
            composition.instruments.forEach((inst, idx) => {
                xml += `    <score-part id="P${idx + 1}"><part-name>${inst}</part-name></score-part>\n`;
            });
            xml += '  </part-list>\n';
            
            // Generate parts
            for (let inst = 0; inst < 5; inst++) {
                xml += `  <part id="P${inst + 1}">\n`;
                
                composition.measures.forEach((measure, mIdx) => {
                    xml += `    <measure number="${measure.number}">\n`;
                    
                    if (mIdx === 0) {
                        xml += '      <attributes>\n';
                        xml += '        <divisions>4</divisions>\n';
                        xml += '        <key><fifths>0</fifths></key>\n';
                        const [beats, beatType] = composition.timeSignature.split('/');
                        xml += `        <time><beats>${beats}</beats><beat-type>${beatType}</beat-type></time>\n`;
                        xml += `        <clef><sign>${inst === 4 ? 'F' : 'G'}</sign><line>${inst === 4 ? '4' : '2'}</line></clef>\n`;
                        xml += '      </attributes>\n';
                    }
                    
                    const instNotes = measure.notes.filter(n => n.instrument === inst);
                    instNotes.forEach(note => {
                        if (note.multipleStop && note.multipleStop.length > 1) {
                            note.multipleStop.forEach((pitch, idx) => {
                                xml += '      <note>\n';
                                if (idx > 0) xml += '        <chord/>\n';
                                
                                const noteNames = ['C', 'C', 'D', 'D', 'E', 'F', 'F', 'G', 'G', 'A', 'A', 'B'];
                                const step = noteNames[pitch % 12];
                                const octave = Math.floor(pitch / 12) - 1;
                                
                                xml += `        <pitch><step>${step}</step><octave>${octave}</octave></pitch>\n`;
                                xml += '        <duration>4</duration>\n';
                                xml += '        <type>quarter</type>\n';
                                xml += '      </note>\n';
                            });
                        } else {
                            const noteNames = ['C', 'C', 'D', 'D', 'E', 'F', 'F', 'G', 'G', 'A', 'A', 'B'];
                            const step = noteNames[note.pitch % 12];
                            const octave = Math.floor(note.pitch / 12) - 1;
                            
                            xml += '      <note>\n';
                            xml += `        <pitch><step>${step}</step><octave>${octave}</octave></pitch>\n`;
                            xml += '        <duration>4</duration>\n';
                            xml += '        <type>quarter</type>\n';
                            xml += '      </note>\n';
                        }
                    });
                    
                    xml += '    </measure>\n';
                });
                
                xml += '  </part>\n';
            }
            
            xml += '</score-partwise>';
            
            // Download
            const blob = new Blob([xml], { type: 'application/vnd.recordare.musicxml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'string_quintet.musicxml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('generateBtn').addEventListener('click', generate);
        document.getElementById('playBtn').addEventListener('click', play);
        document.getElementById('stopBtn').addEventListener('click', stop);
        document.getElementById('exportMidiBtn').addEventListener('click', exportMIDI);
        document.getElementById('exportXmlBtn').addEventListener('click', exportMusicXML);

        document.getElementById('enableStops').addEventListener('change', (e) => {
            document.getElementById('stopsControls').style.display = e.target.checked ? 'block' : 'none';
        });

        // Initialize on load
        initSynths();
        generate();
    </script>
</body>
</html>