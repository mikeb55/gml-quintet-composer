<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet V3.4 - Song Sections ABCD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            color: #333;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.2em;
        }
        
        .version-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .sections-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .section-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .section-tab {
            padding: 10px 20px;
            border: none;
            background: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            position: relative;
        }
        
        .section-tab.active {
            background: #667eea;
            color: white;
        }
        
        .section-tab:hover {
            transform: translateY(-2px);
        }
        
        .section-config {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .instruments-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .instrument {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }
        
        .instrument-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .instrument-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #495057;
        }
        
        .pattern-display {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 3px;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .beat {
            aspect-ratio: 1;
            background: #e0e0e0;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: #666;
        }
        
        .beat.active {
            background: #667eea;
            color: white;
        }
        
        .beat.playing {
            background: #4CAF50;
            transform: scale(1.1);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .section-display {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section-indicator {
            padding: 5px 15px;
            border-radius: 5px;
            background: #e0e0e0;
            color: #666;
        }
        
        .section-indicator.current {
            background: #667eea;
            color: white;
            animation: pulse 1s infinite;
        }
        
        .section-indicator.played {
            background: #4CAF50;
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .song-structure {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        
        .structure-label {
            font-weight: bold;
            color: #495057;
        }
        
        .structure-input {
            flex: 1;
            max-width: 300px;
        }
        
        .structure-help {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quintet V3.4 - Guitar + String Quartet</h1>
            <div class="subtitle">Advanced Composition with Song Sections</div>
            <div class="version-badge">Version 3.4 - ABCD Sections</div>
        </div>
        
        <div class="song-structure">
            <span class="structure-label">Song Structure:</span>
            <input type="text" id="songStructure" class="structure-input" value="AABA" placeholder="e.g., AABA, ABCD, ABABCB">
            <span class="structure-help">Use A, B, C, D for sections</span>
        </div>
        
        <div class="sections-container">
            <div class="section-tabs">
                <button class="section-tab active" data-section="A">Section A (Verse)</button>
                <button class="section-tab" data-section="B">Section B (Chorus)</button>
                <button class="section-tab" data-section="C">Section C (Bridge)</button>
                <button class="section-tab" data-section="D">Section D (Outro)</button>
            </div>
            
            <div class="section-config" id="sectionConfig">
                <div class="section-title">Section A Configuration</div>
                <div class="controls-grid">
                    <div class="control-group">
                        <label>Measures:</label>
                        <input type="number" id="measuresA" value="4" min="1" max="32">
                    </div>
                    <div class="control-group">
                        <label>Key:</label>
                        <select id="keyA">
                            <option value="C">C Major</option>
                            <option value="G">G Major</option>
                            <option value="D">D Major</option>
                            <option value="A">A Major</option>
                            <option value="E">E Major</option>
                            <option value="F">F Major</option>
                            <option value="Bb">Bb Major</option>
                            <option value="Am">A Minor</option>
                            <option value="Em">E Minor</option>
                            <option value="Dm">D Minor</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Tempo:</label>
                        <input type="number" id="tempoA" value="120" min="60" max="200">
                    </div>
                    <div class="control-group">
                        <label>Global Style:</label>
                        <select id="globalStyleA">
                            <option value="">Individual Settings</option>
                            <option value="melodic">All Melodic Lead</option>
                            <option value="baroque">Baroque Counterpoint</option>
                            <option value="classical">Classical Balance</option>
                            <option value="romantic">Romantic Expression</option>
                            <option value="waltz">Viennese Waltz</option>
                            <option value="march">Ceremonial March</option>
                            <option value="ballad">Slow Ballad</option>
                            <option value="minimalist">Minimalist</option>
                            <option value="spanish">Spanish Classical</option>
                            <option value="tango">Argentine Tango</option>
                            <option value="modern">Modern/Contemporary</option>
                            <option value="chamber">Chamber Music</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls-grid">
            <div class="control-group">
                <label>Time Signature:</label>
                <select id="timeSignature">
                    <option value="4/4">4/4</option>
                    <option value="3/4">3/4</option>
                    <option value="6/8">6/8</option>
                    <option value="5/4">5/4</option>
                </select>
            </div>
        </div>
        
        <div class="section-display" id="sectionDisplay"></div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="generateAll()">Generate All Sections</button>
            <button class="btn btn-success" onclick="playAll()" id="playBtn">Play Full Song</button>
            <button class="btn btn-danger" onclick="stopPlayback()" id="stopBtn" disabled>Stop</button>
            <button class="btn btn-warning" onclick="exportMusicXML()">Export MusicXML</button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%">0%</div>
        </div>
        
        <div class="instruments-grid" id="instruments"></div>
    </div>
    
    <script>
        // Audio context
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let isPlaying = false;
        let currentTimeout = null;
        let currentSection = '';
        let currentBeat = 0;
        let currentMeasure = 0;
        
        // Section configurations
        const sections = {
            A: { measures: 4, key: 'C', tempo: 120, style: '', patterns: {} },
            B: { measures: 4, key: 'C', tempo: 120, style: '', patterns: {} },
            C: { measures: 4, key: 'C', tempo: 120, style: '', patterns: {} },
            D: { measures: 4, key: 'C', tempo: 120, style: '', patterns: {} }
        };
        
        // Current active section for editing
        let activeSection = 'A';
        
        // Instrument definitions
        const instruments = [
            { name: 'Classical Guitar', id: 'guitar', clef: 'treble', octave: 3 },
            { name: 'Violin I', id: 'violin1', clef: 'treble', octave: 4 },
            { name: 'Violin II', id: 'violin2', clef: 'treble', octave: 4 },
            { name: 'Viola', id: 'viola', clef: 'alto', octave: 3 },
            { name: 'Cello', id: 'cello', clef: 'bass', octave: 2 }
        ];
        
        // Rhythm patterns for each style
        const rhythmPatterns = {
            guitar: {
                'Melodic Lead': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 2, type: 'eighth'}, 
                     {start: 6, duration: 2, type: 'eighth'}, {start: 8, duration: 8, type: 'half'}],
                    [{start: 0, duration: 2, type: 'eighth'}, {start: 2, duration: 2, type: 'eighth'},
                     {start: 4, duration: 4, type: 'quarter'}, {start: 8, duration: 8, type: 'half'}]
                ],
                'Arpeggiated': [
                    [{start: 0, duration: 2, type: 'eighth'}, {start: 2, duration: 2, type: 'eighth'},
                     {start: 4, duration: 2, type: 'eighth'}, {start: 6, duration: 2, type: 'eighth'},
                     {start: 8, duration: 2, type: 'eighth'}, {start: 10, duration: 2, type: 'eighth'},
                     {start: 12, duration: 2, type: 'eighth'}, {start: 14, duration: 2, type: 'eighth'}]
                ],
                'Fingerstyle': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 2, type: 'eighth'},
                     {start: 6, duration: 2, type: 'eighth'}, {start: 8, duration: 4, type: 'quarter'},
                     {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Spanish Flamenco': [
                    [{start: 0, duration: 1, type: 'sixteenth'}, {start: 1, duration: 1, type: 'sixteenth'},
                     {start: 2, duration: 2, type: 'eighth'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 2, type: 'eighth'}, {start: 10, duration: 2, type: 'eighth'},
                     {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Classical': [
                    [{start: 0, duration: 8, type: 'half'}, {start: 8, duration: 4, type: 'quarter'},
                     {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Waltz': [
                    [{start: 0, duration: 8, type: 'half'}, {start: 8, duration: 4, type: 'quarter'},
                     {start: 12, duration: 0, type: 'rest'}]
                ],
                'Tremolo': [
                    [{start: 0, duration: 1, type: 'sixteenth'}, {start: 1, duration: 1, type: 'sixteenth'},
                     {start: 2, duration: 1, type: 'sixteenth'}, {start: 3, duration: 1, type: 'sixteenth'},
                     {start: 4, duration: 1, type: 'sixteenth'}, {start: 5, duration: 1, type: 'sixteenth'},
                     {start: 6, duration: 1, type: 'sixteenth'}, {start: 7, duration: 1, type: 'sixteenth'},
                     {start: 8, duration: 8, type: 'half'}]
                ],
                'Minimalist': [
                    [{start: 0, duration: 16, type: 'whole'}]
                ]
            },
            violin1: {
                'Melodic Lead': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 2, type: 'eighth'},
                     {start: 6, duration: 2, type: 'eighth'}, {start: 8, duration: 8, type: 'half'}]
                ],
                'Baroque': [
                    [{start: 0, duration: 2, type: 'eighth'}, {start: 2, duration: 2, type: 'eighth'},
                     {start: 4, duration: 2, type: 'eighth'}, {start: 6, duration: 2, type: 'eighth'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Classical': [
                    [{start: 0, duration: 8, type: 'half'}, {start: 8, duration: 4, type: 'quarter'},
                     {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Romantic': [
                    [{start: 0, duration: 6, type: 'dotted_quarter'}, {start: 6, duration: 2, type: 'eighth'},
                     {start: 8, duration: 8, type: 'half'}]
                ],
                'Waltz': [
                    [{start: 0, duration: 8, type: 'half'}, {start: 8, duration: 4, type: 'quarter'},
                     {start: 12, duration: 0, type: 'rest'}]
                ],
                'March': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Ballad': [
                    [{start: 0, duration: 16, type: 'whole'}]
                ],
                'Minimalist': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 0, type: 'rest'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 0, type: 'rest'}]
                ]
            },
            violin2: {
                'Melodic Lead': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 2, type: 'eighth'},
                     {start: 6, duration: 2, type: 'eighth'}, {start: 8, duration: 8, type: 'half'}]
                ],
                'Harmonic Support': [
                    [{start: 0, duration: 0, type: 'rest'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 8, type: 'half'}]
                ],
                'Baroque': [
                    [{start: 0, duration: 0, type: 'rest'}, {start: 2, duration: 2, type: 'eighth'},
                     {start: 4, duration: 2, type: 'eighth'}, {start: 6, duration: 2, type: 'eighth'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Classical': [
                    [{start: 0, duration: 0, type: 'rest'}, {start: 8, duration: 4, type: 'quarter'},
                     {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Romantic': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 8, type: 'half'}]
                ],
                'Waltz': [
                    [{start: 0, duration: 0, type: 'rest'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 4, type: 'quarter'}]
                ],
                'March': [
                    [{start: 0, duration: 2, type: 'eighth'}, {start: 2, duration: 2, type: 'eighth'},
                     {start: 4, duration: 2, type: 'eighth'}, {start: 6, duration: 2, type: 'eighth'},
                     {start: 8, duration: 2, type: 'eighth'}, {start: 10, duration: 2, type: 'eighth'},
                     {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Ballad': [
                    [{start: 0, duration: 8, type: 'half'}, {start: 8, duration: 8, type: 'half'}]
                ],
                'Minimalist': [
                    [{start: 0, duration: 0, type: 'rest'}]
                ]
            },
            viola: {
                'Melodic Lead': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 2, type: 'eighth'},
                     {start: 6, duration: 2, type: 'eighth'}, {start: 8, duration: 8, type: 'half'}]
                ],
                'Rhythmic Inner Voice': [
                    [{start: 0, duration: 0, type: 'rest'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 0, type: 'rest'}]
                ],
                'Baroque': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 2, type: 'eighth'}, {start: 10, duration: 2, type: 'eighth'},
                     {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Classical': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 0, type: 'rest'}]
                ],
                'Romantic': [
                    [{start: 0, duration: 2, type: 'eighth'}, {start: 2, duration: 2, type: 'eighth'},
                     {start: 4, duration: 4, type: 'quarter'}, {start: 8, duration: 8, type: 'half'}]
                ],
                'Waltz': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 0, type: 'rest'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 4, type: 'quarter'}]
                ],
                'March': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Ballad': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 0, type: 'rest'},
                     {start: 8, duration: 8, type: 'half'}]
                ],
                'Minimalist': [
                    [{start: 0, duration: 8, type: 'half'}, {start: 8, duration: 0, type: 'rest'}]
                ]
            },
            cello: {
                'Melodic Lead': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 2, type: 'eighth'},
                     {start: 6, duration: 2, type: 'eighth'}, {start: 8, duration: 8, type: 'half'}]
                ],
                'Bass Foundation': [
                    [{start: 0, duration: 8, type: 'half'}, {start: 8, duration: 4, type: 'quarter'},
                     {start: 12, duration: 0, type: 'rest'}]
                ],
                'Baroque': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 4, type: 'quarter'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 4, type: 'quarter'}]
                ],
                'Classical': [
                    [{start: 0, duration: 8, type: 'half'}, {start: 8, duration: 8, type: 'half'}]
                ],
                'Romantic': [
                    [{start: 0, duration: 16, type: 'whole'}]
                ],
                'Waltz': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 0, type: 'rest'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 4, type: 'quarter'}]
                ],
                'March': [
                    [{start: 0, duration: 4, type: 'quarter'}, {start: 4, duration: 0, type: 'rest'},
                     {start: 8, duration: 4, type: 'quarter'}, {start: 12, duration: 0, type: 'rest'}]
                ],
                'Ballad': [
                    [{start: 0, duration: 16, type: 'whole'}]
                ],
                'Minimalist': [
                    [{start: 0, duration: 0, type: 'rest'}]
                ]
            }
        };
        
        // Initialize section tabs
        document.querySelectorAll('.section-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                activeSection = this.dataset.section;
                loadSectionConfig(activeSection);
            });
        });
        
        // Load section configuration
        function loadSectionConfig(section) {
            document.querySelector('.section-title').textContent = `Section ${section} Configuration`;
            document.getElementById('measuresA').value = sections[section].measures;
            document.getElementById('keyA').value = sections[section].key;
            document.getElementById('tempoA').value = sections[section].tempo;
            document.getElementById('globalStyleA').value = sections[section].style;
            
            // Update IDs dynamically (in a real app, we'd handle this better)
            document.getElementById('measuresA').id = `measures${section}`;
            document.getElementById('keyA').id = `key${section}`;
            document.getElementById('tempoA').id = `tempo${section}`;
            document.getElementById('globalStyleA').id = `globalStyle${section}`;
        }
        
        // Save section configuration
        function saveSectionConfig(section) {
            sections[section].measures = parseInt(document.getElementById(`measures${section}`).value) || 4;
            sections[section].key = document.getElementById(`key${section}`).value || 'C';
            sections[section].tempo = parseInt(document.getElementById(`tempo${section}`).value) || 120;
            sections[section].style = document.getElementById(`globalStyle${section}`).value || '';
        }
        
        // Initialize instruments display
        function initializeInstruments() {
            const container = document.getElementById('instruments');
            container.innerHTML = '';
            
            instruments.forEach(inst => {
                const div = document.createElement('div');
                div.className = 'instrument';
                div.innerHTML = `
                    <div class="instrument-header">
                        <span class="instrument-name">${inst.name}</span>
                        <select id="${inst.id}-style">
                            ${getStyleOptions(inst.id)}
                        </select>
                    </div>
                    <div class="pattern-display" id="${inst.id}-pattern"></div>
                `;
                container.appendChild(div);
            });
        }
        
        // Get style options for instrument
        function getStyleOptions(instrumentId) {
            const styles = Object.keys(rhythmPatterns[instrumentId]);
            return styles.map(style => 
                `<option value="${style}">${style}</option>`
            ).join('');
        }
        
        // Generate all sections
        function generateAll() {
            const structure = document.getElementById('songStructure').value.toUpperCase() || 'AABA';
            
            // Save current section config
            saveSectionConfig(activeSection);
            
            // Generate patterns for each unique section
            const uniqueSections = [...new Set(structure.split(''))];
            uniqueSections.forEach(section => {
                if (sections[section]) {
                    generateSection(section);
                }
            });
            
            // Display section indicators
            displaySectionStructure(structure);
        }
        
        // Generate patterns for a section
        function generateSection(section) {
            const config = sections[section];
            const globalStyle = config.style;
            
            instruments.forEach(inst => {
                const style = globalStyle && rhythmPatterns[inst.id][getGlobalStyleMapping(globalStyle, inst.id)] 
                    ? getGlobalStyleMapping(globalStyle, inst.id)
                    : document.getElementById(`${inst.id}-style`).value;
                
                const patterns = rhythmPatterns[inst.id][style];
                const pattern = patterns[Math.floor(Math.random() * patterns.length)];
                
                // Generate notes for the pattern
                const notes = generateNotes(inst.id, config.key, pattern, config.measures);
                config.patterns[inst.id] = notes;
            });
        }
        
        // Get global style mapping for instrument
        function getGlobalStyleMapping(globalStyle, instrumentId) {
            const mappings = {
                'melodic': 'Melodic Lead',
                'baroque': 'Baroque',
                'classical': 'Classical',
                'romantic': 'Romantic',
                'waltz': 'Waltz',
                'march': 'March',
                'ballad': 'Ballad',
                'minimalist': 'Minimalist',
                'spanish': instrumentId === 'guitar' ? 'Spanish Flamenco' : 'Romantic',
                'tango': instrumentId === 'guitar' ? 'Spanish Flamenco' : 'Romantic',
                'modern': 'Minimalist',
                'chamber': 'Classical'
            };
            
            return mappings[globalStyle] || Object.keys(rhythmPatterns[instrumentId])[0];
        }
        
        // Generate notes based on key and pattern
        function generateNotes(instrumentId, key, pattern, measures) {
            const scales = {
                'C': ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
                'G': ['G', 'A', 'B', 'C', 'D', 'E', 'F#'],
                'D': ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'],
                'A': ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'],
                'E': ['E', 'F#', 'G#', 'A', 'B', 'C#', 'D#'],
                'F': ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'],
                'Bb': ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A'],
                'Am': ['A', 'B', 'C', 'D', 'E', 'F', 'G'],
                'Em': ['E', 'F#', 'G', 'A', 'B', 'C', 'D'],
                'Dm': ['D', 'E', 'F', 'G', 'A', 'Bb', 'C']
            };
            
            const scale = scales[key] || scales['C'];
            const instrument = instruments.find(i => i.id === instrumentId);
            const octave = instrument.octave;
            
            const allNotes = [];
            for (let measure = 0; measure < measures; measure++) {
                pattern.forEach(note => {
                    if (note.type !== 'rest') {
                        const scaleIndex = Math.floor(Math.random() * scale.length);
                        const pitch = scale[scaleIndex] + octave;
                        allNotes.push({
                            ...note,
                            pitch: pitch,
                            measure: measure
                        });
                    } else {
                        allNotes.push({
                            ...note,
                            measure: measure
                        });
                    }
                });
            }
            
            return allNotes;
        }
        
        // Display section structure
        function displaySectionStructure(structure) {
            const display = document.getElementById('sectionDisplay');
            display.innerHTML = '';
            
            structure.split('').forEach((section, index) => {
                const div = document.createElement('div');
                div.className = 'section-indicator';
                div.id = `section-${index}`;
                div.textContent = `${section} (${sections[section].measures}m)`;
                display.appendChild(div);
            });
        }
        
        // Play all sections
        function playAll() {
            if (isPlaying) return;
            
            const structure = document.getElementById('songStructure').value.toUpperCase() || 'AABA';
            isPlaying = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            playSectionSequence(structure.split(''), 0);
        }
        
        // Play sections in sequence
        function playSectionSequence(sectionList, index) {
            if (!isPlaying || index >= sectionList.length) {
                stopPlayback();
                return;
            }
            
            // Update section indicators
            document.querySelectorAll('.section-indicator').forEach((ind, i) => {
                ind.classList.remove('current', 'played');
                if (i < index) ind.classList.add('played');
                if (i === index) ind.classList.add('current');
            });
            
            const section = sectionList[index];
            const config = sections[section];
            const tempo = config.tempo;
            const beatDuration = 60000 / tempo / 4; // 16th note duration
            
            playSection(config, () => {
                playSectionSequence(sectionList, index + 1);
            });
        }
        
        // Play a single section
        function playSection(config, callback) {
            const tempo = config.tempo;
            const measures = config.measures;
            const totalBeats = measures * 16;
            let currentBeat = 0;
            
            function playBeat() {
                if (!isPlaying || currentBeat >= totalBeats) {
                    if (callback) callback();
                    return;
                }
                
                // Update progress
                const progress = (currentBeat / totalBeats) * 100;
                document.getElementById('progress').style.width = progress + '%';
                document.getElementById('progress').textContent = Math.round(progress) + '%';
                
                // Play notes for this beat
                instruments.forEach(inst => {
                    const notes = config.patterns[inst.id];
                    if (notes) {
                        notes.forEach(note => {
                            const noteBeat = note.measure * 16 + note.start;
                            if (noteBeat === currentBeat && note.type !== 'rest') {
                                playNote(note.pitch, note.duration * (60000 / tempo / 4));
                            }
                        });
                    }
                });
                
                currentBeat++;
                currentTimeout = setTimeout(playBeat, 60000 / tempo / 4);
            }
            
            playBeat();
        }
        
        // Play a note
        function playNote(pitch, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            const frequency = getFrequency(pitch);
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }
        
        // Get frequency from note name
        function getFrequency(note) {
            const noteMap = {
                'C': -9, 'C#': -8, 'D': -7, 'D#': -6, 'E': -5, 'F': -4,
                'F#': -3, 'G': -2, 'G#': -1, 'A': 0, 'A#': 1, 'B': 2,
                'Bb': -2, 'Eb': -8, 'Ab': -4, 'Db': -9, 'Gb': -3
            };
            
            const noteName = note.slice(0, -1);
            const octave = parseInt(note.slice(-1));
            const semitonesFromA4 = noteMap[noteName] + (octave - 4) * 12;
            
            return 440 * Math.pow(2, semitonesFromA4 / 12);
        }
        
        // Stop playback
        function stopPlayback() {
            isPlaying = false;
            if (currentTimeout) {
                clearTimeout(currentTimeout);
                currentTimeout = null;
            }
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('progress').style.width = '0%';
            document.getElementById('progress').textContent = '0%';
            
            document.querySelectorAll('.section-indicator').forEach(ind => {
                ind.classList.remove('current', 'played');
            });
        }
        
        // Export to MusicXML
        function exportMusicXML() {
            const structure = document.getElementById('songStructure').value.toUpperCase() || 'AABA';
            const timeSignature = document.getElementById('timeSignature').value;
            const [beats, beatType] = timeSignature.split('/').map(Number);
            
            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
    <work>
        <work-title>Quintet Composition</work-title>
    </work>
    <identification>
        <creator type="composer">Mike Bryant</creator>
        <encoding>
            <software>Quintet V3.4</software>
            <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
        </encoding>
    </identification>
    <part-list>`;
            
            // Add parts
            instruments.forEach((inst, index) => {
                xml += `
        <score-part id="P${index + 1}">
            <part-name>${inst.name}</part-name>
            <score-instrument id="P${index + 1}-I1">
                <instrument-name>${inst.name}</instrument-name>
            </score-instrument>
        </score-part>`;
            });
            
            xml += `
    </part-list>`;
            
            // Add each part's content
            instruments.forEach((inst, instIndex) => {
                xml += `
    <part id="P${instIndex + 1}">`;
                
                let measureNum = 1;
                structure.split('').forEach(sectionName => {
                    const section = sections[sectionName];
                    const notes = section.patterns[inst.id] || [];
                    
                    for (let m = 0; m < section.measures; m++) {
                        xml += `
        <measure number="${measureNum}">`;
                        
                        if (measureNum === 1) {
                            xml += `
            <attributes>
                <divisions>4</divisions>
                <key>
                    <fifths>0</fifths>
                </key>
                <time>
                    <beats>${beats}</beats>
                    <beat-type>${beatType}</beat-type>
                </time>
                <clef>
                    <sign>${inst.clef === 'treble' ? 'G' : inst.clef === 'bass' ? 'F' : 'C'}</sign>
                    <line>${inst.clef === 'treble' ? '2' : inst.clef === 'bass' ? '4' : '3'}</line>
                </clef>
            </attributes>
            <direction placement="above">
                <direction-type>
                    <metronome>
                        <beat-unit>quarter</beat-unit>
                        <per-minute>${section.tempo}</per-minute>
                    </metronome>
                </direction-type>
            </direction>`;
                        }
                        
                        // Add notes for this measure
                        const measureNotes = notes.filter(n => n.measure === m);
                        measureNotes.forEach(note => {
                            if (note.type === 'rest') {
                                xml += `
            <note>
                <rest/>
                <duration>${note.duration}</duration>
                <type>${getDurationType(note.duration)}</type>
            </note>`;
                            } else {
                                const [step, alter, octave] = parseNote(note.pitch);
                                xml += `
            <note>
                <pitch>
                    <step>${step}</step>
                    ${alter !== 0 ? `<alter>${alter}</alter>` : ''}
                    <octave>${octave}</octave>
                </pitch>
                <duration>${note.duration}</duration>
                <type>${getDurationType(note.duration)}</type>
            </note>`;
                            }
                        });
                        
                        // Fill remaining beats with rest if needed
                        const totalDuration = measureNotes.reduce((sum, n) => sum + n.duration, 0);
                        if (totalDuration < 16) {
                            xml += `
            <note>
                <rest/>
                <duration>${16 - totalDuration}</duration>
                <type>whole</type>
            </note>`;
                        }
                        
                        xml += `
        </measure>`;
                        measureNum++;
                    }
                });
                
                xml += `
    </part>`;
            });
            
            xml += `
</score-partwise>`;
            
            downloadXML(xml, 'quintet_composition.musicxml');
        }
        
        // Parse note string
        function parseNote(noteStr) {
            const noteMap = {
                'C': 'C', 'C#': 'C', 'D': 'D', 'D#': 'D', 'E': 'E',
                'F': 'F', 'F#': 'F', 'G': 'G', 'G#': 'G', 'A': 'A',
                'A#': 'A', 'B': 'B', 'Bb': 'B', 'Eb': 'E', 'Ab': 'A',
                'Db': 'D', 'Gb': 'G'
            };
            
            const alterMap = {
                'C#': 1, 'D#': 1, 'F#': 1, 'G#': 1, 'A#': 1,
                'Bb': -1, 'Eb': -1, 'Ab': -1, 'Db': -1, 'Gb': -1
            };
            
            const noteName = noteStr.slice(0, -1);
            const octave = parseInt(noteStr.slice(-1));
            
            return [
                noteMap[noteName] || 'C',
                alterMap[noteName] || 0,
                octave
            ];
        }
        
        // Get duration type
        function getDurationType(duration) {
            const types = {
                16: 'whole',
                8: 'half',
                4: 'quarter',
                2: 'eighth',
                1: 'sixteenth'
            };
            return types[duration] || 'quarter';
        }
        
        // Download XML file
        function downloadXML(content, filename) {
            const blob = new Blob([content], { type: 'application/vnd.recordare.musicxml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Initialize on load
        initializeInstruments();
    </script>
</body>
</html>