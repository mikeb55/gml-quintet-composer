<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer v9.4 - Polyrhythmic Patterns</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { 
            text-align: center; 
            color: #333; 
            margin-bottom: 10px;
            font-size: 28px;
        }
        .version {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .controls { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 30px; 
            justify-content: center; 
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        button { 
            padding: 12px 24px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .pattern-selector {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .pattern-group {
            flex: 1;
            min-width: 200px;
        }
        .pattern-group label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        select {
            width: 100%;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            background: white;
            font-size: 14px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .section h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .instrument-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .instrument-name {
            width: 100px;
            font-weight: 600;
            color: #555;
        }
        .measure-display {
            flex: 1;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .measure {
            padding: 5px 10px;
            background: #e8f5e9;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        #status { 
            padding: 15px; 
            background: #e8f5e9; 
            border-radius: 8px; 
            margin-top: 20px; 
            text-align: center;
            font-weight: 600;
            color: #2e7d32;
        }
        #composition-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        input[type="file"] {
            padding: 10px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¼ Quintet Composer v9.4</h1>
        <div class="version">Polyrhythmic Patterns - Building on v9.3 Foundation</div>
        
        <div class="pattern-selector">
            <div class="pattern-group">
                <label>Left Hand Pattern (Cello/Viola):</label>
                <select id="lhPattern">
                    <option value="quarters">Quarter notes (1 & 3)</option>
                    <option value="halfnotes">Half notes</option>
                    <option value="walking">Walking bass</option>
                    <option value="alberti">Alberti bass</option>
                </select>
            </div>
            <div class="pattern-group">
                <label>Right Hand Pattern (Violins):</label>
                <select id="rhPattern">
                    <option value="eighths">Flowing eighths</option>
                    <option value="quarters">Melodic quarters</option>
                    <option value="syncopated">Syncopated</option>
                    <option value="tremolo">Tremolo</option>
                </select>
            </div>
            <div class="pattern-group">
                <label>Guitar Pattern:</label>
                <select id="guitarPattern">
                    <option value="arpeggios">Arpeggios</option>
                    <option value="strumming">Strumming</option>
                    <option value="fingerstyle">Fingerstyle</option>
                    <option value="mixed">Mixed</option>
                </select>
            </div>
        </div>

        <div class="controls">
            <button onclick="generatePolyrhythmicComposition()">Generate Polyrhythmic Composition</button>
            <button onclick="testPatterns()">Test Pattern Generation</button>
            <button onclick="exportMusicXML()">Export MusicXML</button>
            <input type="file" id="midiFile" accept=".mid,.midi" onchange="loadMidiFile(event)">
        </div>

        <div id="composition-preview"></div>
        <div id="status">Ready - Select patterns and generate composition</div>
    </div>

    <script>
        // Global composition state
        let composition = {
            title: "Quintet Composition v9.4",
            tempo: 120,
            divisions: 256, // 256 divisions per quarter note for fine control
            timeSignature: { numerator: 4, denominator: 4 },
            measures: [],
            instruments: ['Guitar', 'Violin I', 'Violin II', 'Viola', 'Cello']
        };

        // Pattern definitions
        const patterns = {
            lh: {
                quarters: function(scale, octave) {
                    // Quarter notes on beats 1 and 3
                    return [
                        { pitch: scale[0], octave: octave, tick: 0, duration: 512 }, // Half note
                        { pitch: scale[4], octave: octave, tick: 512, duration: 512 }  // Half note
                    ];
                },
                halfnotes: function(scale, octave) {
                    // Two half notes per measure
                    return [
                        { pitch: scale[0], octave: octave, tick: 0, duration: 512 },
                        { pitch: scale[2], octave: octave, tick: 512, duration: 512 }
                    ];
                },
                walking: function(scale, octave) {
                    // Walking bass - quarter notes
                    return [
                        { pitch: scale[0], octave: octave, tick: 0, duration: 256 },
                        { pitch: scale[1], octave: octave, tick: 256, duration: 256 },
                        { pitch: scale[2], octave: octave, tick: 512, duration: 256 },
                        { pitch: scale[3], octave: octave, tick: 768, duration: 256 }
                    ];
                },
                alberti: function(scale, octave) {
                    // Alberti bass pattern - eighth notes
                    return [
                        { pitch: scale[0], octave: octave, tick: 0, duration: 128 },
                        { pitch: scale[2], octave: octave, tick: 128, duration: 128 },
                        { pitch: scale[4], octave: octave, tick: 256, duration: 128 },
                        { pitch: scale[2], octave: octave, tick: 384, duration: 128 },
                        { pitch: scale[0], octave: octave, tick: 512, duration: 128 },
                        { pitch: scale[2], octave: octave, tick: 640, duration: 128 },
                        { pitch: scale[4], octave: octave, tick: 768, duration: 128 },
                        { pitch: scale[2], octave: octave, tick: 896, duration: 128 }
                    ];
                }
            },
            rh: {
                eighths: function(scale, octave) {
                    // Flowing eighth notes
                    const notes = [];
                    for (let i = 0; i < 8; i++) {
                        notes.push({
                            pitch: scale[Math.floor(Math.random() * scale.length)],
                            octave: octave,
                            tick: i * 128,
                            duration: 128
                        });
                    }
                    return notes;
                },
                quarters: function(scale, octave) {
                    // Melodic quarter notes
                    return [
                        { pitch: scale[2], octave: octave, tick: 0, duration: 256 },
                        { pitch: scale[3], octave: octave, tick: 256, duration: 256 },
                        { pitch: scale[4], octave: octave, tick: 512, duration: 256 },
                        { pitch: scale[5], octave: octave, tick: 768, duration: 256 }
                    ];
                },
                syncopated: function(scale, octave) {
                    // Syncopated rhythm
                    return [
                        { pitch: scale[0], octave: octave, tick: 0, duration: 192 },
                        { pitch: scale[2], octave: octave, tick: 192, duration: 192 },
                        { pitch: scale[4], octave: octave, tick: 384, duration: 128 },
                        { pitch: scale[3], octave: octave, tick: 512, duration: 256 },
                        { pitch: scale[1], octave: octave, tick: 768, duration: 256 }
                    ];
                },
                tremolo: function(scale, octave) {
                    // Tremolo - rapid sixteenth notes
                    const notes = [];
                    const pitch1 = scale[0];
                    const pitch2 = scale[2];
                    for (let i = 0; i < 16; i++) {
                        notes.push({
                            pitch: i % 2 === 0 ? pitch1 : pitch2,
                            octave: octave,
                            tick: i * 64,
                            duration: 64
                        });
                    }
                    return notes;
                }
            },
            guitar: {
                arpeggios: function(scale, octave) {
                    // Arpeggio pattern
                    return [
                        { pitch: scale[0], octave: octave, tick: 0, duration: 128 },
                        { pitch: scale[2], octave: octave, tick: 128, duration: 128 },
                        { pitch: scale[4], octave: octave, tick: 256, duration: 128 },
                        { pitch: scale[6], octave: octave, tick: 384, duration: 128 },
                        { pitch: scale[4], octave: octave, tick: 512, duration: 128 },
                        { pitch: scale[2], octave: octave, tick: 640, duration: 128 },
                        { pitch: scale[4], octave: octave, tick: 768, duration: 128 },
                        { pitch: scale[0], octave: octave, tick: 896, duration: 128 }
                    ];
                },
                strumming: function(scale, octave) {
                    // Strumming pattern - quarter notes
                    return [
                        { pitch: scale[0], octave: octave, tick: 0, duration: 256 },
                        { pitch: scale[0], octave: octave, tick: 256, duration: 128 },
                        { pitch: scale[0], octave: octave, tick: 384, duration: 128 },
                        { pitch: scale[0], octave: octave, tick: 512, duration: 256 },
                        { pitch: scale[0], octave: octave, tick: 768, duration: 256 }
                    ];
                },
                fingerstyle: function(scale, octave) {
                    // Fingerstyle pattern
                    return [
                        { pitch: scale[0], octave: octave, tick: 0, duration: 256 },
                        { pitch: scale[4], octave: octave + 1, tick: 128, duration: 128 },
                        { pitch: scale[2], octave: octave + 1, tick: 256, duration: 256 },
                        { pitch: scale[5], octave: octave + 1, tick: 384, duration: 128 },
                        { pitch: scale[0], octave: octave, tick: 512, duration: 256 },
                        { pitch: scale[3], octave: octave + 1, tick: 640, duration: 128 },
                        { pitch: scale[1], octave: octave + 1, tick: 768, duration: 256 }
                    ];
                },
                mixed: function(scale, octave) {
                    // Mixed pattern
                    return [
                        { pitch: scale[0], octave: octave, tick: 0, duration: 512 },
                        { pitch: scale[2], octave: octave + 1, tick: 256, duration: 128 },
                        { pitch: scale[4], octave: octave + 1, tick: 384, duration: 128 },
                        { pitch: scale[0], octave: octave, tick: 512, duration: 256 },
                        { pitch: scale[4], octave: octave, tick: 768, duration: 256 }
                    ];
                }
            }
        };

        // Scales
        const SCALES = {
            'C': ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
            'G': ['G', 'A', 'B', 'C', 'D', 'E', 'F#']
        };

        function generatePolyrhythmicComposition() {
            composition.measures = [];
            
            const lhPatternType = document.getElementById('lhPattern').value;
            const rhPatternType = document.getElementById('rhPattern').value;
            const guitarPatternType = document.getElementById('guitarPattern').value;
            
            const scale = SCALES['C'];
            
            // Generate 32 measures
            for (let m = 1; m <= 32; m++) {
                const measure = {
                    number: m,
                    instruments: {}
                };
                
                // Guitar
                measure.instruments['Guitar'] = patterns.guitar[guitarPatternType](scale, 3);
                
                // Violin I - RH pattern
                measure.instruments['Violin I'] = patterns.rh[rhPatternType](scale, 4);
                
                // Violin II - Variation of RH pattern
                const violin2Notes = patterns.rh[rhPatternType](scale, 4);
                // Shift pitches for harmony
                violin2Notes.forEach(note => {
                    const idx = scale.indexOf(note.pitch);
                    note.pitch = scale[(idx + 2) % scale.length]; // Third harmony
                });
                measure.instruments['Violin II'] = violin2Notes;
                
                // Viola - LH pattern
                measure.instruments['Viola'] = patterns.lh[lhPatternType](scale, 3);
                
                // Cello - LH pattern (octave lower)
                measure.instruments['Cello'] = patterns.lh[lhPatternType](scale, 2);
                
                composition.measures.push(measure);
            }
            
            displayComposition();
            updateStatus('Polyrhythmic composition generated successfully!');
        }

        function displayComposition() {
            const preview = document.getElementById('composition-preview');
            let html = '<h3>Composition Preview</h3>';
            
            // Show first 4 measures as preview
            const sections = [
                { name: 'Intro', start: 0, end: 4 },
                { name: 'Verse (excerpt)', start: 4, end: 8 }
            ];
            
            sections.forEach(section => {
                html += `<div class="section">`;
                html += `<h3>${section.name}</h3>`;
                
                composition.instruments.forEach(inst => {
                    html += `<div class="instrument-row">`;
                    html += `<div class="instrument-name">${inst}:</div>`;
                    html += `<div class="measure-display">`;
                    
                    for (let m = section.start; m < section.end && m < composition.measures.length; m++) {
                        const notes = composition.measures[m].instruments[inst];
                        const noteStr = notes.map(n => n.pitch).join(' ');
                        html += `<div class="measure">M${m + 1}: ${noteStr}</div>`;
                    }
                    
                    html += `</div></div>`;
                });
                
                html += `</div>`;
            });
            
            preview.innerHTML = html;
        }

        function testPatterns() {
            // Test each pattern type to ensure they generate valid notes
            const scale = SCALES['C'];
            let allValid = true;
            let results = [];
            
            // Test LH patterns
            for (let pattern in patterns.lh) {
                try {
                    const notes = patterns.lh[pattern](scale, 2);
                    const valid = notes.every(n => n.pitch && n.octave && n.tick !== undefined && n.duration);
                    results.push(`LH ${pattern}: ${valid ? 'PASS' : 'FAIL'}`);
                    if (!valid) allValid = false;
                } catch (e) {
                    results.push(`LH ${pattern}: ERROR - ${e.message}`);
                    allValid = false;
                }
            }
            
            // Test RH patterns
            for (let pattern in patterns.rh) {
                try {
                    const notes = patterns.rh[pattern](scale, 4);
                    const valid = notes.every(n => n.pitch && n.octave && n.tick !== undefined && n.duration);
                    results.push(`RH ${pattern}: ${valid ? 'PASS' : 'FAIL'}`);
                    if (!valid) allValid = false;
                } catch (e) {
                    results.push(`RH ${pattern}: ERROR - ${e.message}`);
                    allValid = false;
                }
            }
            
            // Test Guitar patterns
            for (let pattern in patterns.guitar) {
                try {
                    const notes = patterns.guitar[pattern](scale, 3);
                    const valid = notes.every(n => n.pitch && n.octave && n.tick !== undefined && n.duration);
                    results.push(`Guitar ${pattern}: ${valid ? 'PASS' : 'FAIL'}`);
                    if (!valid) allValid = false;
                } catch (e) {
                    results.push(`Guitar ${pattern}: ERROR - ${e.message}`);
                    allValid = false;
                }
            }
            
            updateStatus(`Pattern tests: ${allValid ? 'ALL PASSED' : 'SOME FAILED'}\n${results.join(', ')}`);
        }

        function generateMusicXML() {
            let xml = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
            xml += '<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">\n';
            xml += '<score-partwise version="3.0">\n';
            
            // Work title
            xml += '  <work>\n';
            xml += `    <work-title>${composition.title}</work-title>\n`;
            xml += '  </work>\n';
            
            // Identification
            xml += '  <identification>\n';
            xml += '    <encoding>\n';
            xml += '      <software>Quintet Composer v9.4</software>\n';
            xml += `      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>\n`;
            xml += '    </encoding>\n';
            xml += '  </identification>\n';
            
            // Part list
            xml += '  <part-list>\n';
            composition.instruments.forEach((inst, idx) => {
                xml += `    <score-part id="P${idx + 1}">\n`;
                xml += `      <part-name>${inst}</part-name>\n`;
                xml += '    </score-part>\n';
            });
            xml += '  </part-list>\n';
            
            // Generate parts
            composition.instruments.forEach((inst, partIdx) => {
                xml += `  <part id="P${partIdx + 1}">\n`;
                
                composition.measures.forEach((measure, mIdx) => {
                    xml += `    <measure number="${measure.number}">\n`;
                    
                    // Add attributes to first measure
                    if (mIdx === 0) {
                        xml += '      <attributes>\n';
                        xml += `        <divisions>${composition.divisions}</divisions>\n`;
                        xml += '        <key>\n';
                        xml += '          <fifths>0</fifths>\n';
                        xml += '        </key>\n';
                        xml += '        <time>\n';
                        xml += `          <beats>${composition.timeSignature.numerator}</beats>\n`;
                        xml += `          <beat-type>${composition.timeSignature.denominator}</beat-type>\n`;
                        xml += '        </time>\n';
                        
                        // Clef based on instrument
                        if (inst === 'Cello') {
                            xml += '        <clef>\n';
                            xml += '          <sign>F</sign>\n';
                            xml += '          <line>4</line>\n';
                            xml += '        </clef>\n';
                        } else if (inst === 'Viola') {
                            xml += '        <clef>\n';
                            xml += '          <sign>C</sign>\n';
                            xml += '          <line>3</line>\n';
                            xml += '        </clef>\n';
                        } else {
                            xml += '        <clef>\n';
                            xml += '          <sign>G</sign>\n';
                            xml += '          <line>2</line>\n';
                            xml += '        </clef>\n';
                        }
                        xml += '      </attributes>\n';
                    }
                    
                    // Add notes - sort by tick time
                    const notes = measure.instruments[inst].sort((a, b) => a.tick - b.tick);
                    notes.forEach(note => {
                        xml += '      <note>\n';
                        xml += '        <pitch>\n';
                        xml += `          <step>${note.pitch.charAt(0)}</step>\n`;
                        if (note.pitch.includes('#')) {
                            xml += '          <alter>1</alter>\n';
                        }
                        xml += `          <octave>${note.octave}</octave>\n`;
                        xml += '        </pitch>\n';
                        xml += `        <duration>${note.duration}</duration>\n`;
                        
                        // Determine note type from duration
                        let noteType = 'quarter';
                        if (note.duration === 1024) noteType = 'whole';
                        else if (note.duration === 512) noteType = 'half';
                        else if (note.duration === 256) noteType = 'quarter';
                        else if (note.duration === 128) noteType = 'eighth';
                        else if (note.duration === 64) noteType = '16th';
                        
                        xml += `        <type>${noteType}</type>\n`;
                        xml += '      </note>\n';
                    });
                    
                    xml += '    </measure>\n';
                });
                
                xml += '  </part>\n';
            });
            
            xml += '</score-partwise>';
            return xml;
        }

        function exportMusicXML() {
            if (composition.measures.length === 0) {
                updateStatus('Generate a composition first!');
                return;
            }
            
            const xml = generateMusicXML();
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quintet_v9.4_polyrhythmic.musicxml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateStatus('MusicXML exported with polyrhythmic patterns!');
        }

        function loadMidiFile(event) {
            const file = event.target.files[0];
            if (file) {
                updateStatus(`MIDI file loaded: ${file.name} - Parser coming in v10.0`);
            }
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Generate default composition on load
        window.onload = function() {
            generatePolyrhythmicComposition();
        };
    </script>
</body>
</html>