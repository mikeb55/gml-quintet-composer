<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéº Quartet Engine v1.0 - String Quartet Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4ade80;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-container {
            flex: 1;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 30px;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            opacity: 0.9;
        }

        select, input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        /* Fix dropdown options visibility */
        select option {
            background: #2d2d3d;
            color: #fff;
            padding: 5px;
        }

        select option:hover {
            background: #667eea;
        }

        select:focus, input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: #667eea;
        }

        /* Ensure select dropdown is visible */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            padding-right: 40px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-export {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }

        .visualization {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }

        .staff-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .instrument-staff {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid;
        }

        .violin1-staff { border-left-color: #667eea; }
        .violin2-staff { border-left-color: #764ba2; }
        .viola-staff { border-left-color: #a855f7; }
        .cello-staff { border-left-color: #6366f1; }

        .instrument-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-display {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            min-height: 60px;
            white-space: pre-wrap;
            font-size: 12px;
            line-height: 1.6;
        }

        .voice-leading-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .voice-leading-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #667eea;
        }

        .rule-check {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
            font-size: 14px;
        }

        .rule-check.valid {
            color: #4ade80;
        }

        .rule-check.warning {
            color: #fbbf24;
        }

        .rule-check.error {
            color: #f87171;
        }

        .pattern-list {
            display: grid;
            gap: 8px;
        }

        .pattern-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .pattern-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .pattern-item.selected {
            background: rgba(102, 126, 234, 0.3);
            border: 1px solid #667eea;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Section Configuration Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .section-config {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .section-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .section-indicator {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üéº</div>
                <div>
                    <h1 style="font-size: 24px;">Quartet Engine</h1>
                    <p style="font-size: 12px; opacity: 0.8;">4-Part String Quartet Generator v1.0</p>
                </div>
            </div>
            <div class="connection-status">
                <div id="connectionDot" class="status-dot"></div>
                <span id="connectionText">Standalone Mode</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Left Panel - Controls -->
        <div class="panel">
            <h2 class="panel-title">üéõÔ∏è Controls</h2>
            
            <div class="control-group">
                <label class="control-label">Harmony Source</label>
                <select id="harmonySource">
                    <option value="manual">Manual Input</option>
                    <option value="triadgen">From TriadGen</option>
                    <option value="generate">Auto Generate</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Key Center</label>
                <select id="keyCenter">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="E">E Major</option>
                    <option value="F">F Major</option>
                    <option value="Bb">B‚ô≠ Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                    <option value="Dm">D Minor</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Voicing Style</label>
                <select id="voicingStyle">
                    <option value="close">Close Position</option>
                    <option value="open">Open Position</option>
                    <option value="mixed">Mixed Voicing</option>
                    <option value="classical">Classical Rules</option>
                    <option value="modern">Modern Freedom</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Texture</label>
                <select id="texture">
                    <option value="homophonic">Homophonic</option>
                    <option value="polyphonic">Polyphonic</option>
                    <option value="melody-accomp">Melody + Accompaniment</option>
                    <option value="fugal">Fugal</option>
                    <option value="chorale">Chorale Style</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Measures</label>
                <input type="number" id="measures" min="1" max="32" value="8">
            </div>

            <div class="control-group">
                <label class="control-label">Tempo (BPM)</label>
                <input type="number" id="tempo" min="40" max="200" value="90">
            </div>

            <div class="control-group">
                <label class="control-label">Form Structure</label>
                <select id="formStructure">
                    <option value="single">Single Section</option>
                    <option value="AB">A-B (Binary)</option>
                    <option value="ABA">A-B-A (Ternary)</option>
                    <option value="ABAB">A-B-A-B</option>
                    <option value="ABCD">A-B-C-D</option>
                    <option value="custom">Custom Sections</option>
                </select>
            </div>

            <button id="generateBtn">üéµ Generate Quartet</button>
            <button id="sectionBtn" class="btn-secondary">üìä Configure Sections</button>
            <button id="harmonizeBtn" class="btn-secondary">üéπ Harmonize Chord</button>
            <button id="clearBtn" class="btn-secondary">üîÑ Clear All</button>
        </div>

        <!-- Center Panel - Visualization -->
        <div class="panel">
            <h2 class="panel-title">üéª String Quartet Visualization</h2>
            <div class="visualization">
                <div class="staff-container">
                    <div class="instrument-staff violin1-staff">
                        <div class="instrument-label">
                            <span>Violin I</span>
                            <span style="font-size: 12px; opacity: 0.7;">Soprano</span>
                        </div>
                        <div id="violin1Notes" class="notes-display">Waiting for generation...</div>
                    </div>
                    
                    <div class="instrument-staff violin2-staff">
                        <div class="instrument-label">
                            <span>Violin II</span>
                            <span style="font-size: 12px; opacity: 0.7;">Alto</span>
                        </div>
                        <div id="violin2Notes" class="notes-display">Waiting for generation...</div>
                    </div>
                    
                    <div class="instrument-staff viola-staff">
                        <div class="instrument-label">
                            <span>Viola</span>
                            <span style="font-size: 12px; opacity: 0.7;">Tenor</span>
                        </div>
                        <div id="violaNotes" class="notes-display">Waiting for generation...</div>
                    </div>
                    
                    <div class="instrument-staff cello-staff">
                        <div class="instrument-label">
                            <span>Cello</span>
                            <span style="font-size: 12px; opacity: 0.7;">Bass</span>
                        </div>
                        <div id="celloNotes" class="notes-display">Waiting for generation...</div>
                    </div>
                </div>

                <div class="voice-leading-info">
                    <div class="voice-leading-title">Voice Leading Analysis</div>
                    <div id="voiceLeadingChecks">
                        <div class="rule-check valid">‚úì No parallel fifths</div>
                        <div class="rule-check valid">‚úì No parallel octaves</div>
                        <div class="rule-check valid">‚úì Smooth voice leading</div>
                        <div class="rule-check valid">‚úì Proper range for each instrument</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Patterns & Export -->
        <div class="panel">
            <h2 class="panel-title">üìã Patterns & Export</h2>
            
            <div class="control-group">
                <label class="control-label">Preset Patterns</label>
                <div class="pattern-list">
                    <div class="pattern-item" data-pattern="classical">Classical Chorale</div>
                    <div class="pattern-item" data-pattern="romantic">Romantic Lush</div>
                    <div class="pattern-item" data-pattern="minimalist">Minimalist</div>
                    <div class="pattern-item" data-pattern="baroque">Baroque Counterpoint</div>
                    <div class="pattern-item" data-pattern="modern">Modern Dissonance</div>
                    <div class="pattern-item" data-pattern="folk">Folk Harmony</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="measureCount">0</div>
                    <div class="stat-label">Measures</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="chordCount">0</div>
                    <div class="stat-label">Chords</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="noteCount">0</div>
                    <div class="stat-label">Total Notes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="voiceErrors">0</div>
                    <div class="stat-label">Voice Errors</div>
                </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 16px;">Export Options</h3>
            <button id="exportMusicXMLBtn" class="btn-export">üìÑ Export MusicXML</button>
            <button id="exportMIDIBtn" class="btn-export">üéπ Export MIDI</button>
            <button id="exportJSONBtn" class="btn-export">üìä Export JSON</button>
            <button id="sendToQuintetBtn" class="btn-export">üé∏ Send to Quintet</button>
        </div>
    </div>

    <!-- Section Configuration Modal -->
    <div id="sectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configure Sections</h2>
                <button class="modal-close" onclick="closeSectionModal()">‚úï</button>
            </div>
            <div id="sectionConfigs">
                <!-- Section configurations will be added dynamically -->
            </div>
            <button onclick="applySections()" style="width: 100%; margin-top: 20px;">Apply Section Settings</button>
        </div>
    </div>

    <script>
        class QuartetEngine {
            constructor() {
                this.version = '1.3.0';
                this.state = {
                    parts: {
                        violin1: [],
                        violin2: [],
                        viola: [],
                        cello: []
                    },
                    sections: [],
                    formStructure: 'single',
                    harmony: [],
                    key: 'C',
                    tempo: 90,
                    timeSignature: '4/4',
                    measures: 8,
                    voicingStyle: 'classical',
                    texture: 'homophonic'
                };

                // Section templates for quick setup
                this.sectionTemplates = {
                    intro: { 
                        key: 'C', 
                        voicing: 'open', 
                        texture: 'homophonic', 
                        dynamics: 'p',
                        measures: 4,
                        name: 'Intro'
                    },
                    verse: { 
                        key: 'C', 
                        voicing: 'classical', 
                        texture: 'melody-accomp', 
                        dynamics: 'mf',
                        measures: 8,
                        name: 'Verse'
                    },
                    chorus: { 
                        key: 'G', 
                        voicing: 'open', 
                        texture: 'homophonic', 
                        dynamics: 'f',
                        measures: 8,
                        name: 'Chorus'
                    },
                    bridge: { 
                        key: 'F', 
                        voicing: 'mixed', 
                        texture: 'polyphonic', 
                        dynamics: 'mp',
                        measures: 4,
                        name: 'Bridge'
                    },
                    development: { 
                        key: 'Am', 
                        voicing: 'modern', 
                        texture: 'fugal', 
                        dynamics: 'ff',
                        measures: 8,
                        name: 'Development'
                    },
                    recapitulation: { 
                        key: 'C', 
                        voicing: 'classical', 
                        texture: 'chorale', 
                        dynamics: 'mf',
                        measures: 8,
                        name: 'Recapitulation'
                    },
                    coda: { 
                        key: 'C', 
                        voicing: 'open', 
                        texture: 'homophonic', 
                        dynamics: 'pp',
                        measures: 4,
                        name: 'Coda'
                    }
                };

                this.savedTemplates = [];
                this.loadSavedTemplates();

                // Instrument ranges (MIDI note numbers)
                this.ranges = {
                    violin1: { min: 55, max: 93 },  // G3 to A6
                    violin2: { min: 55, max: 88 },  // G3 to E6
                    viola: { min: 48, max: 81 },    // C3 to A5
                    cello: { min: 36, max: 69 }     // C2 to A4
                };

                // Voice leading rules
                this.voiceLeadingRules = {
                    maxLeap: 8,  // Maximum interval leap in semitones
                    preferredLeap: 4,  // Preferred maximum leap
                    avoidParallelFifths: true,
                    avoidParallelOctaves: true,
                    smoothVoiceLeading: true
                };

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkDashboardConnection();
                this.loadPreferences();
                console.log('Quartet Engine v1.0 initialized');
            }

            setupEventListeners() {
                // Main controls
                document.getElementById('generateBtn').addEventListener('click', () => this.generate());
                document.getElementById('harmonizeBtn').addEventListener('click', () => this.harmonizeChord());
                document.getElementById('clearBtn').addEventListener('click', () => this.clear());
                document.getElementById('sectionBtn').addEventListener('click', () => this.openSectionModal());

                // Export buttons
                document.getElementById('exportMusicXMLBtn').addEventListener('click', () => this.exportMusicXML());
                document.getElementById('exportMIDIBtn').addEventListener('click', () => this.exportMIDI());
                document.getElementById('exportJSONBtn').addEventListener('click', () => this.exportJSON());
                document.getElementById('sendToQuintetBtn').addEventListener('click', () => this.sendToQuintet());

                // Pattern selection
                document.querySelectorAll('.pattern-item').forEach(item => {
                    item.addEventListener('click', (e) => this.applyPattern(e.target.dataset.pattern));
                });

                // Parameter changes
                ['keyCenter', 'voicingStyle', 'texture', 'measures', 'tempo', 'formStructure'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', () => this.updateParameters());
                    }
                });

                // Form structure change
                document.getElementById('formStructure').addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        this.openSectionModal();
                    }
                });

                // Message listener for integration
                window.addEventListener('message', (e) => this.handleMessage(e));
            }

            checkDashboardConnection() {
                // Check if opened from Dashboard or another app
                if (window.opener || window.parent !== window) {
                    this.updateConnectionStatus(true);
                    // Send handshake
                    const target = window.opener || window.parent;
                    target.postMessage({
                        type: 'HANDSHAKE',
                        source: 'quartet-engine',
                        version: this.version
                    }, '*');
                }
            }

            updateConnectionStatus(connected) {
                const dot = document.getElementById('connectionDot');
                const text = document.getElementById('connectionText');
                if (dot) {
                    dot.classList.toggle('connected', connected);
                }
                if (text) {
                    text.textContent = connected ? 'Connected to Dashboard' : 'Standalone Mode';
                }
            }

            handleMessage(event) {
                const { type, data } = event.data;
                
                switch(type) {
                    case 'HANDSHAKE':
                        this.updateConnectionStatus(true);
                        event.source.postMessage({
                            type: 'HANDSHAKE_RESPONSE',
                            source: 'quartet-engine'
                        }, event.origin);
                        break;
                        
                    case 'HARMONY_INPUT':
                        this.receiveHarmony(data);
                        break;
                        
                    case 'GENERATE_REQUEST':
                        this.generate();
                        break;
                        
                    case 'EXPORT_REQUEST':
                        this.handleExportRequest(data.format);
                        break;
                        
                    case 'PARAMETER_UPDATE':
                        this.updateFromExternal(data);
                        break;
                }
            }

            generate() {
                console.log('Generating quartet arrangement...');
                
                const formStructure = document.getElementById('formStructure').value;
                const totalMeasures = parseInt(document.getElementById('measures').value);
                
                // Clear previous
                this.state.parts = {
                    violin1: [],
                    violin2: [],
                    viola: [],
                    cello: []
                };

                // Setup sections based on form structure
                this.setupSections(formStructure, totalMeasures);

                // Generate each section
                let currentMeasure = 0;
                this.state.sections.forEach((section, sectionIndex) => {
                    console.log(`Generating ${section.name}: ${section.measures} measures, ${section.texture} texture`);
                    
                    // Generate chord progression for this section
                    const progression = this.generateProgression(section.key, section.measures);
                    
                    // Generate measures for this section
                    for (let m = 0; m < section.measures; m++) {
                        const chord = progression[m % progression.length];
                        const voicing = this.voiceChord(chord, section.voicing, section.texture);
                        const rhythm = this.generateRhythm(section.texture);
                        
                        // Apply to each part
                        Object.keys(this.state.parts).forEach(part => {
                            this.state.parts[part].push({
                                measure: currentMeasure + 1,
                                section: section.name,
                                notes: voicing[part],
                                rhythm: rhythm[part],
                                dynamics: section.dynamics || this.generateDynamics(m, section.measures)
                            });
                        });
                        
                        currentMeasure++;
                    }
                });

                this.updateDisplay();
                this.analyzeVoiceLeading();
                this.showNotification(`Quartet generated: ${this.state.formStructure} form with ${this.state.sections.length} sections`);
            }

            setupSections(formStructure, totalMeasures) {
                this.state.formStructure = formStructure;
                this.state.sections = [];
                
                switch(formStructure) {
                    case 'single':
                        this.state.sections.push({
                            ...this.sectionTemplates.A,
                            measures: totalMeasures,
                            key: document.getElementById('keyCenter').value,
                            voicing: document.getElementById('voicingStyle').value,
                            texture: document.getElementById('texture').value,
                            rehearsalMark: 'A'
                        });
                        break;
                        
                    case 'AB':
                        const halfMeasures = Math.floor(totalMeasures / 2);
                        this.state.sections.push(
                            { ...this.sectionTemplates.A, measures: halfMeasures, rehearsalMark: 'A' },
                            { ...this.sectionTemplates.B, measures: totalMeasures - halfMeasures, rehearsalMark: 'B' }
                        );
                        break;
                        
                    case 'ABA':
                        const thirdMeasures = Math.floor(totalMeasures / 3);
                        this.state.sections.push(
                            { ...this.sectionTemplates.A, measures: thirdMeasures, rehearsalMark: 'A' },
                            { ...this.sectionTemplates.B, measures: thirdMeasures, rehearsalMark: 'B' },
                            { ...this.sectionTemplates.A, measures: totalMeasures - (thirdMeasures * 2), rehearsalMark: 'A\'' }
                        );
                        break;
                        
                    case 'ABAB':
                        const quarterMeasures = Math.floor(totalMeasures / 4);
                        this.state.sections.push(
                            { ...this.sectionTemplates.A, measures: quarterMeasures, rehearsalMark: 'A' },
                            { ...this.sectionTemplates.B, measures: quarterMeasures, rehearsalMark: 'B' },
                            { ...this.sectionTemplates.A, measures: quarterMeasures, rehearsalMark: 'A\'' },
                            { ...this.sectionTemplates.B, measures: totalMeasures - (quarterMeasures * 3), rehearsalMark: 'B\'' }
                        );
                        break;
                        
                    case 'ABCD':
                        const fourthMeasures = Math.floor(totalMeasures / 4);
                        this.state.sections.push(
                            { ...this.sectionTemplates.A, measures: fourthMeasures, rehearsalMark: 'A' },
                            { ...this.sectionTemplates.B, measures: fourthMeasures, rehearsalMark: 'B' },
                            { ...this.sectionTemplates.C, measures: fourthMeasures, rehearsalMark: 'C' },
                            { ...this.sectionTemplates.D, measures: totalMeasures - (fourthMeasures * 3), rehearsalMark: 'D' }
                        );
                        break;
                        
                    case 'custom':
                        // Will be configured via modal
                        if (this.state.sections.length === 0) {
                            this.setupSections('single', totalMeasures);
                        }
                        break;
                }
            }

            openSectionModal() {
                const modal = document.getElementById('sectionModal');
                const container = document.getElementById('sectionConfigs');
                
                // Clear existing content
                container.innerHTML = '';
                
                // Get current sections or create default
                if (this.state.sections.length === 0) {
                    this.state.sections.push({
                        name: 'Opening',
                        rehearsalMark: 'A',
                        measures: 4,
                        key: 'C',
                        voicing: 'classical',
                        texture: 'homophonic',
                        dynamics: 'mf'
                    });
                }
                
                // Add controls header with template options
                const controlsDiv = document.createElement('div');
                controlsDiv.style.marginBottom = '20px';
                controlsDiv.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="window.quartetEngine.addNewSection()" 
                                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            ‚ûï Add Section
                        </button>
                        <select onchange="if(this.value) window.quartetEngine.addTemplateSection(this.value); this.value='';"
                                style="background: rgba(255, 255, 255, 0.1); padding: 10px;">
                            <option value="">Add from template...</option>
                            <option value="intro">Intro</option>
                            <option value="verse">Verse</option>
                            <option value="chorus">Chorus</option>
                            <option value="bridge">Bridge</option>
                            <option value="development">Development</option>
                            <option value="recapitulation">Recapitulation</option>
                            <option value="coda">Coda</option>
                        </select>
                        <button onclick="window.quartetEngine.saveAsTemplate()" 
                                style="background: rgba(102, 126, 234, 0.3);">
                            üíæ Save as Template
                        </button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="opacity: 0.7; font-size: 14px;">
                            Total: ${this.state.sections.length} section${this.state.sections.length !== 1 ? 's' : ''}
                            (${this.state.sections.reduce((sum, s) => sum + s.measures, 0)} measures)
                        </span>
                        ${this.savedTemplates.length > 0 ? `
                        <select onchange="if(this.value) window.quartetEngine.loadTemplate(this.value); this.value='';"
                                style="background: rgba(255, 255, 255, 0.1); padding: 5px; font-size: 12px;">
                            <option value="">Load saved template...</option>
                            ${this.savedTemplates.map(t => `<option value="${t.name}">${t.name}</option>`).join('')}
                        </select>` : ''}
                    </div>
                `;
                container.appendChild(controlsDiv);
                
                // Create scrollable container for sections if more than 5
                const sectionsContainer = document.createElement('div');
                if (this.state.sections.length > 5) {
                    sectionsContainer.style.maxHeight = '400px';
                    sectionsContainer.style.overflowY = 'auto';
                    sectionsContainer.style.paddingRight = '10px';
                }
                
                // Create configuration for each section
                this.state.sections.forEach((section, index) => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'section-config';
                    sectionDiv.innerHTML = `
                        <div class="section-header">
                            <span class="section-title">${section.name} [${section.rehearsalMark}]</span>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <span class="section-indicator">${section.measures} measures</span>
                                ${this.state.sections.length > 1 ? `
                                <button onclick="window.quartetEngine.moveSection(${index}, ${index-1})" 
                                        ${index === 0 ? 'disabled' : ''}
                                        style="background: rgba(102, 126, 234, 0.2); 
                                               padding: 2px 6px; 
                                               border-radius: 4px;
                                               opacity: ${index === 0 ? '0.3' : '1'};">‚Üë</button>
                                <button onclick="window.quartetEngine.moveSection(${index}, ${index+1})" 
                                        ${index === this.state.sections.length - 1 ? 'disabled' : ''}
                                        style="background: rgba(102, 126, 234, 0.2); 
                                               padding: 2px 6px; 
                                               border-radius: 4px;
                                               opacity: ${index === this.state.sections.length - 1 ? '0.3' : '1'};">‚Üì</button>
                                <button onclick="window.quartetEngine.removeSection(${index})" 
                                        style="background: rgba(239, 68, 68, 0.2); 
                                               padding: 4px 8px; 
                                               margin-left: 10px; 
                                               border-radius: 4px;">‚úï</button>` : ''}
                            </div>
                        </div>
                        <div class="section-controls">
                            <div class="control-group">
                                <label class="control-label">Section Name</label>
                                <input type="text" value="${section.name}" 
                                       data-section="${index}" data-field="name" class="section-input">
                            </div>
                            <div class="control-group">
                                <label class="control-label">Rehearsal Mark</label>
                                <input type="text" value="${section.rehearsalMark}" maxlength="5"
                                       data-section="${index}" data-field="rehearsalMark" class="section-input"
                                       placeholder="A, B, C, AA, etc.">
                            </div>
                            <div class="control-group">
                                <label class="control-label">Measures</label>
                                <input type="number" min="1" max="64" value="${section.measures}" 
                                       data-section="${index}" data-field="measures" class="section-input">
                            </div>
                            <div class="control-group">
                                <label class="control-label">Key</label>
                                <select data-section="${index}" data-field="key" class="section-input">
                                    <option value="C" ${section.key === 'C' ? 'selected' : ''}>C Major</option>
                                    <option value="G" ${section.key === 'G' ? 'selected' : ''}>G Major</option>
                                    <option value="D" ${section.key === 'D' ? 'selected' : ''}>D Major</option>
                                    <option value="A" ${section.key === 'A' ? 'selected' : ''}>A Major</option>
                                    <option value="E" ${section.key === 'E' ? 'selected' : ''}>E Major</option>
                                    <option value="B" ${section.key === 'B' ? 'selected' : ''}>B Major</option>
                                    <option value="F" ${section.key === 'F' ? 'selected' : ''}>F Major</option>
                                    <option value="Bb" ${section.key === 'Bb' ? 'selected' : ''}>B‚ô≠ Major</option>
                                    <option value="Eb" ${section.key === 'Eb' ? 'selected' : ''}>E‚ô≠ Major</option>
                                    <option value="Ab" ${section.key === 'Ab' ? 'selected' : ''}>A‚ô≠ Major</option>
                                    <option value="Am" ${section.key === 'Am' ? 'selected' : ''}>A Minor</option>
                                    <option value="Em" ${section.key === 'Em' ? 'selected' : ''}>E Minor</option>
                                    <option value="Bm" ${section.key === 'Bm' ? 'selected' : ''}>B Minor</option>
                                    <option value="Dm" ${section.key === 'Dm' ? 'selected' : ''}>D Minor</option>
                                    <option value="Gm" ${section.key === 'Gm' ? 'selected' : ''}>G Minor</option>
                                    <option value="Cm" ${section.key === 'Cm' ? 'selected' : ''}>C Minor</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label class="control-label">Voicing</label>
                                <select data-section="${index}" data-field="voicing" class="section-input">
                                    <option value="classical" ${section.voicing === 'classical' ? 'selected' : ''}>Classical</option>
                                    <option value="open" ${section.voicing === 'open' ? 'selected' : ''}>Open</option>
                                    <option value="mixed" ${section.voicing === 'mixed' ? 'selected' : ''}>Mixed</option>
                                    <option value="modern" ${section.voicing === 'modern' ? 'selected' : ''}>Modern</option>
                                    <option value="close" ${section.voicing === 'close' ? 'selected' : ''}>Close</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label class="control-label">Texture</label>
                                <select data-section="${index}" data-field="texture" class="section-input">
                                    <option value="homophonic" ${section.texture === 'homophonic' ? 'selected' : ''}>Homophonic</option>
                                    <option value="polyphonic" ${section.texture === 'polyphonic' ? 'selected' : ''}>Polyphonic</option>
                                    <option value="melody-accomp" ${section.texture === 'melody-accomp' ? 'selected' : ''}>Melody + Accompaniment</option>
                                    <option value="fugal" ${section.texture === 'fugal' ? 'selected' : ''}>Fugal</option>
                                    <option value="chorale" ${section.texture === 'chorale' ? 'selected' : ''}>Chorale</option>
                                    <option value="canon" ${section.texture === 'canon' ? 'selected' : ''}>Canon</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label class="control-label">Dynamics</label>
                                <select data-section="${index}" data-field="dynamics" class="section-input">
                                    <option value="pp" ${section.dynamics === 'pp' ? 'selected' : ''}>pp (pianissimo)</option>
                                    <option value="p" ${section.dynamics === 'p' ? 'selected' : ''}>p (piano)</option>
                                    <option value="mp" ${section.dynamics === 'mp' ? 'selected' : ''}>mp (mezzo-piano)</option>
                                    <option value="mf" ${section.dynamics === 'mf' ? 'selected' : ''}>mf (mezzo-forte)</option>
                                    <option value="f" ${section.dynamics === 'f' ? 'selected' : ''}>f (forte)</option>
                                    <option value="ff" ${section.dynamics === 'ff' ? 'selected' : ''}>ff (fortissimo)</option>
                                </select>
                            </div>
                        </div>
                    `;
                    sectionsContainer.appendChild(sectionDiv);
                });
                
                container.appendChild(sectionsContainer);
                modal.classList.add('active');
            }

            addNewSection() {
                // Generate rehearsal mark automatically (A, B, C... AA, BB, CC... AAA, BBB, etc.)
                const rehearsalMark = this.generateRehearsalMark(this.state.sections.length);
                
                const newSection = {
                    name: `Section ${this.state.sections.length + 1}`,
                    rehearsalMark: rehearsalMark,
                    measures: 4,
                    key: 'C',
                    voicing: 'classical',
                    texture: 'homophonic',
                    dynamics: 'mf'
                };
                this.state.sections.push(newSection);
                this.openSectionModal(); // Refresh modal
                this.showNotification(`Added ${newSection.name} [${rehearsalMark}]`);
            }

            generateRehearsalMark(index) {
                // Generate marks: A-Z, then AA-ZZ, then AAA-ZZZ, etc.
                if (index < 26) {
                    return String.fromCharCode(65 + index);
                } else if (index < 702) { // 26 + (26*26)
                    const firstLetter = Math.floor((index - 26) / 26);
                    const secondLetter = (index - 26) % 26;
                    return String.fromCharCode(65 + firstLetter) + String.fromCharCode(65 + secondLetter);
                } else { // AAA-ZZZ and beyond
                    const adjusted = index - 702;
                    const firstLetter = Math.floor(adjusted / 676);
                    const secondLetter = Math.floor((adjusted % 676) / 26);
                    const thirdLetter = adjusted % 26;
                    return String.fromCharCode(65 + firstLetter) + 
                           String.fromCharCode(65 + secondLetter) + 
                           String.fromCharCode(65 + thirdLetter);
                }
            }

            addTemplateSection(templateName) {
                const template = this.sectionTemplates[templateName];
                if (template) {
                    const rehearsalMark = this.generateRehearsalMark(this.state.sections.length);
                    const newSection = {
                        ...template,
                        rehearsalMark: rehearsalMark
                    };
                    this.state.sections.push(newSection);
                    this.openSectionModal();
                    this.showNotification(`Added ${template.name} section`);
                }
            }

            saveAsTemplate() {
                const name = prompt('Enter a name for this section template:');
                if (name && this.state.sections.length > 0) {
                    const template = {
                        name: name,
                        sections: JSON.parse(JSON.stringify(this.state.sections))
                    };
                    this.savedTemplates.push(template);
                    localStorage.setItem('quartetSectionTemplates', JSON.stringify(this.savedTemplates));
                    this.showNotification(`Template "${name}" saved!`);
                }
            }

            loadSavedTemplates() {
                const saved = localStorage.getItem('quartetSectionTemplates');
                if (saved) {
                    this.savedTemplates = JSON.parse(saved);
                }
            }

            loadTemplate(templateName) {
                const template = this.savedTemplates.find(t => t.name === templateName);
                if (template) {
                    this.state.sections = JSON.parse(JSON.stringify(template.sections));
                    this.openSectionModal();
                    this.showNotification(`Template "${templateName}" loaded!`);
                }
            }

            removeSection(index) {
                if (this.state.sections.length > 1) {
                    const removed = this.state.sections.splice(index, 1)[0];
                    // Regenerate rehearsal marks for remaining sections
                    this.state.sections.forEach((section, i) => {
                        section.rehearsalMark = this.generateRehearsalMark(i);
                    });
                    this.openSectionModal(); // Refresh modal
                    this.showNotification(`Removed ${removed.name}`);
                }
            }

            moveSection(fromIndex, toIndex) {
                if (fromIndex !== toIndex && fromIndex >= 0 && toIndex >= 0 && 
                    fromIndex < this.state.sections.length && toIndex < this.state.sections.length) {
                    const [removed] = this.state.sections.splice(fromIndex, 1);
                    this.state.sections.splice(toIndex, 0, removed);
                    // Regenerate rehearsal marks after reordering
                    this.state.sections.forEach((section, i) => {
                        section.rehearsalMark = this.generateRehearsalMark(i);
                    });
                    this.openSectionModal();
                }
            }

            generateProgression(key, measures) {
                // Generate a chord progression based on key
                const progressions = {
                    'C': ['C', 'Am', 'F', 'G', 'C', 'F', 'G', 'C'],
                    'G': ['G', 'Em', 'C', 'D', 'G', 'C', 'D', 'G'],
                    'D': ['D', 'Bm', 'G', 'A', 'D', 'G', 'A', 'D'],
                    'Am': ['Am', 'Dm', 'G', 'C', 'F', 'E', 'Am', 'E']
                };
                
                return progressions[key] || progressions['C'];
            }

            voiceChord(chord, style, texture) {
                // Generate 4-part voicing for the chord
                const notes = this.getChordNotes(chord);
                const voicing = {};
                
                if (style === 'classical') {
                    // Classical voice leading rules
                    voicing.cello = [notes.root - 12];  // Bass in octave below
                    voicing.viola = [notes.third];
                    voicing.violin2 = [notes.fifth];
                    voicing.violin1 = [notes.root + 12];  // Soprano doubles root
                } else if (style === 'open') {
                    // Open voicing
                    voicing.cello = [notes.root - 12];
                    voicing.viola = [notes.fifth];
                    voicing.violin2 = [notes.third + 12];
                    voicing.violin1 = [notes.root + 24];
                } else {
                    // Mixed voicing
                    voicing.cello = [notes.root - 12];
                    voicing.viola = [notes.third];
                    voicing.violin2 = [notes.root];
                    voicing.violin1 = [notes.fifth + 12];
                }
                
                // Apply texture variations
                if (texture === 'polyphonic') {
                    // Add passing tones and movement
                    Object.keys(voicing).forEach(part => {
                        if (Math.random() > 0.5) {
                            voicing[part].push(voicing[part][0] + 2);
                        }
                    });
                }
                
                return voicing;
            }

            getChordNotes(chordName) {
                // Convert chord name to MIDI notes
                const roots = { 'C': 60, 'D': 62, 'E': 64, 'F': 65, 'G': 67, 'A': 69, 'B': 71 };
                const root = roots[chordName[0]] || 60;
                
                // Major/minor thirds
                const isMinor = chordName.includes('m');
                const third = root + (isMinor ? 3 : 4);
                const fifth = root + 7;
                
                return { root, third, fifth };
            }

            generateRhythm(texture) {
                // Generate rhythm patterns for each part
                const patterns = {
                    homophonic: {
                        violin1: [256, 256, 256, 256],  // Quarter notes
                        violin2: [256, 256, 256, 256],
                        viola: [512, 512],  // Half notes
                        cello: [1024]  // Whole note
                    },
                    polyphonic: {
                        violin1: [128, 128, 256, 256, 128, 128],
                        violin2: [256, 128, 128, 256, 256],
                        viola: [256, 256, 256, 256],
                        cello: [512, 256, 256]
                    },
                    'melody-accomp': {
                        violin1: [256, 128, 128, 256, 128, 128, 256],
                        violin2: [128, 128, 128, 128, 128, 128, 128, 128],
                        viola: [128, 128, 128, 128, 128, 128, 128, 128],
                        cello: [512, 512]
                    }
                };
                
                return patterns[texture] || patterns.homophonic;
            }

            generateDynamics(measure, totalMeasures) {
                // Generate dynamic markings
                const progress = measure / totalMeasures;
                if (progress < 0.25) return 'mp';
                if (progress < 0.5) return 'mf';
                if (progress < 0.75) return 'f';
                return 'mf';
            }

            analyzeVoiceLeading() {
                // Analyze voice leading for errors
                const checks = [];
                let errorCount = 0;
                
                // Check for parallel fifths/octaves
                // Check for large leaps
                // Check for voice crossing
                
                // Update display
                document.getElementById('voiceErrors').textContent = errorCount;
            }

            updateDisplay() {
                // Update the visual display with section indicators
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                Object.keys(this.state.parts).forEach(part => {
                    const element = document.getElementById(part.replace('violin', 'violin') + 'Notes');
                    if (element && this.state.parts[part].length > 0) {
                        let currentSection = '';
                        const measures = this.state.parts[part].map(m => {
                            let sectionMarker = '';
                            if (m.section && m.section !== currentSection) {
                                currentSection = m.section;
                                sectionMarker = `[${m.section}] `;
                            }
                            const notes = m.notes.map(n => {
                                const octave = Math.floor(n / 12) - 1;
                                const noteName = noteNames[n % 12];
                                return noteName + octave;
                            }).join(' ');
                            return `${sectionMarker}M${m.measure}: ${notes}`;
                        }).join(' | ');
                        element.textContent = measures;
                    }
                });
                
                // Update stats
                document.getElementById('measureCount').textContent = this.state.parts.violin1.length;
                document.getElementById('chordCount').textContent = this.state.parts.violin1.length * 2;
                document.getElementById('noteCount').textContent = 
                    Object.values(this.state.parts).reduce((sum, part) => 
                        sum + part.reduce((s, m) => s + m.notes.length, 0), 0);
                
                // Show section structure in stats
                if (this.state.sections.length > 0) {
                    const sectionInfo = this.state.sections.map(s => 
                        `${s.name}(${s.measures}m)`
                    ).join(' ');
                    document.getElementById('voiceErrors').parentElement.innerHTML = `
                        <div class="stat-value" style="font-size: 14px;">${this.state.formStructure}</div>
                        <div class="stat-label">${sectionInfo}</div>
                    `;
                }
            }

            exportMusicXML() {
                const measures = parseInt(document.getElementById('measures').value);
                const xml = this.generateMusicXML(measures);
                const blob = new Blob([xml], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quartet_${Date.now()}.musicxml`;
                a.click();
                this.showNotification('MusicXML exported successfully!');
            }

            generateMusicXML(measureCount) {
                // Generate proper MusicXML with 4 parts
                const xml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <work>
    <work-title>String Quartet - Generated by Quartet Engine</work-title>
  </work>
  <part-list>
    <score-part id="P1">
      <part-name>Violin I</part-name>
    </score-part>
    <score-part id="P2">
      <part-name>Violin II</part-name>
    </score-part>
    <score-part id="P3">
      <part-name>Viola</part-name>
    </score-part>
    <score-part id="P4">
      <part-name>Violoncello</part-name>
    </score-part>
  </part-list>
  ${this.generateParts(measureCount)}
</score-partwise>`;
                return xml;
            }

            generateParts(measureCount) {
                let partsXML = '';
                const partNames = ['P1', 'P2', 'P3', 'P4'];
                const instruments = ['violin1', 'violin2', 'viola', 'cello'];
                
                partNames.forEach((partId, index) => {
                    partsXML += `<part id="${partId}">`;
                    for (let m = 1; m <= measureCount; m++) {
                        partsXML += this.generateMeasure(m, instruments[index]);
                    }
                    partsXML += '</part>';
                });
                
                return partsXML;
            }

            generateMeasure(measureNum, instrument) {
                const pitches = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                const octaves = { 'violin1': 5, 'violin2': 4, 'viola': 4, 'cello': 3 };
                const rhythms = [256, 256, 128, 128, 128, 128];
                
                let measureXML = `<measure number="${measureNum}">`;
                
                // Add rehearsal mark at the start of each section (only in first instrument)
                if (instrument === 'violin1' && measureNum === 1) {
                    measureXML += '<attributes><divisions>256</divisions><key><fifths>0</fifths></key><time><beats>4</beats><beat-type>4</beat-type></time></attributes>';
                }
                
                // Check if this is the start of a new section
                let currentMeasureCount = 0;
                let sectionIndex = -1;
                for (let i = 0; i < this.state.sections.length; i++) {
                    if (measureNum === currentMeasureCount + 1 && instrument === 'violin1') {
                        // Add rehearsal mark
                        measureXML += `
                        <direction placement="above">
                            <direction-type>
                                <rehearsal font-weight="bold" font-size="14">${this.state.sections[i].rehearsalMark}</rehearsal>
                            </direction-type>
                        </direction>`;
                        break;
                    }
                    currentMeasureCount += this.state.sections[i].measures;
                    if (currentMeasureCount >= measureNum) break;
                }
                
                let durationSum = 0;
                rhythms.forEach((duration, i) => {
                    if (durationSum + duration <= 1024) {  // Don't exceed measure length
                        const pitch = pitches[Math.floor(Math.random() * pitches.length)];
                        const octave = octaves[instrument];
                        measureXML += `
                        <note>
                            <pitch>
                                <step>${pitch}</step>
                                <octave>${octave}</octave>
                            </pitch>
                            <duration>${duration}</duration>
                            <type>${duration === 256 ? 'quarter' : duration === 128 ? 'eighth' : 'half'}</type>
                        </note>`;
                        durationSum += duration;
                    }
                });
                
                measureXML += '</measure>';
                return measureXML;
            }

            exportMIDI() {
                // Export as MIDI
                const data = this.formatForMIDI();
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quartet_${Date.now()}.json`;
                a.click();
                this.showNotification('MIDI data exported as JSON!');
            }

            exportJSON() {
                const data = {
                    type: 'quartet',
                    version: this.version,
                    timestamp: Date.now(),
                    parts: this.state.parts,
                    parameters: {
                        key: this.state.key,
                        tempo: this.state.tempo,
                        measures: this.state.measures,
                        voicingStyle: this.state.voicingStyle,
                        texture: this.state.texture
                    }
                };
                
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quartet_${Date.now()}.json`;
                a.click();
                this.showNotification('JSON exported successfully!');
            }

            sendToQuintet() {
                // Send quartet data to QuintetComposer
                const data = {
                    type: 'QUARTET_DATA',
                    source: 'quartet-engine',
                    data: {
                        parts: this.state.parts,
                        key: this.state.key,
                        tempo: this.state.tempo,
                        measures: this.state.measures
                    }
                };
                
                // Send to parent/opener
                if (window.opener) {
                    window.opener.postMessage(data, '*');
                } else if (window.parent !== window) {
                    window.parent.postMessage(data, '*');
                } else {
                    // Broadcast
                    window.postMessage(data, '*');
                }
                
                this.showNotification('Quartet sent to QuintetComposer!');
            }

            formatForMIDI() {
                return {
                    format: 'midi',
                    tracks: Object.keys(this.state.parts).map((part, index) => ({
                        name: part,
                        channel: index + 1,
                        program: index < 2 ? 40 : index === 2 ? 41 : 42, // String instruments
                        notes: this.state.parts[part]
                    }))
                };
            }

            applyPattern(patternName) {
                console.log('Applying pattern:', patternName);
                // Clear selected state
                document.querySelectorAll('.pattern-item').forEach(item => {
                    item.classList.remove('selected');
                });
                // Add selected state
                document.querySelector(`[data-pattern="${patternName}"]`).classList.add('selected');
                
                // Apply pattern settings
                const patterns = {
                    classical: { voicing: 'classical', texture: 'chorale' },
                    romantic: { voicing: 'open', texture: 'homophonic' },
                    minimalist: { voicing: 'close', texture: 'polyphonic' },
                    baroque: { voicing: 'classical', texture: 'fugal' },
                    modern: { voicing: 'modern', texture: 'polyphonic' },
                    folk: { voicing: 'mixed', texture: 'melody-accomp' }
                };
                
                const pattern = patterns[patternName];
                if (pattern) {
                    document.getElementById('voicingStyle').value = pattern.voicing;
                    document.getElementById('texture').value = pattern.texture;
                    this.generate();
                }
            }

            harmonizeChord() {
                // Harmonize a single chord for testing
                const chord = prompt('Enter chord (e.g., Cmaj7, Dm, G7):', 'Cmaj7');
                if (chord) {
                    const voicing = this.voiceChord(chord, 'classical', 'homophonic');
                    console.log('Chord voicing:', voicing);
                    this.showNotification(`Harmonized ${chord}`);
                }
            }

            clear() {
                this.state.parts = {
                    violin1: [],
                    violin2: [],
                    viola: [],
                    cello: []
                };
                this.updateDisplay();
                this.showNotification('Cleared all parts');
            }

            updateParameters() {
                this.state.key = document.getElementById('keyCenter').value;
                this.state.tempo = parseInt(document.getElementById('tempo').value);
                this.state.measures = parseInt(document.getElementById('measures').value);
                this.state.voicingStyle = document.getElementById('voicingStyle').value;
                this.state.texture = document.getElementById('texture').value;
            }

            receiveHarmony(data) {
                // Receive harmony from TriadGen
                console.log('Received harmony:', data);
                this.state.harmony = data.chords;
                this.generate();
            }

            loadPreferences() {
                // Load saved preferences
                const saved = localStorage.getItem('quartetEnginePrefs');
                if (saved) {
                    const prefs = JSON.parse(saved);
                    Object.keys(prefs).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = prefs[key];
                        }
                    });
                }
            }

            savePreferences() {
                const prefs = {
                    keyCenter: document.getElementById('keyCenter').value,
                    voicingStyle: document.getElementById('voicingStyle').value,
                    texture: document.getElementById('texture').value,
                    tempo: document.getElementById('tempo').value,
                    measures: document.getElementById('measures').value
                };
                localStorage.setItem('quartetEnginePrefs', JSON.stringify(prefs));
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            handleExportRequest(format) {
                switch(format) {
                    case 'musicxml':
                        this.exportMusicXML();
                        break;
                    case 'midi':
                        this.exportMIDI();
                        break;
                    case 'json':
                        this.exportJSON();
                        break;
                }
            }

            updateFromExternal(data) {
                // Update parameters from external source
                if (data.key) this.state.key = data.key;
                if (data.tempo) this.state.tempo = data.tempo;
                if (data.measures) this.state.measures = data.measures;
                this.updateDisplay();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            window.quartetEngine = new QuartetEngine();
        });

        // Modal control functions
        function closeSectionModal() {
            document.getElementById('sectionModal').classList.remove('active');
        }

        function applySections() {
            // Update section configurations from inputs
            const inputs = document.querySelectorAll('.section-input');
            inputs.forEach(input => {
                const sectionIndex = parseInt(input.dataset.section);
                const field = input.dataset.field;
                const value = input.type === 'number' ? parseInt(input.value) : input.value;
                
                if (window.quartetEngine.state.sections[sectionIndex]) {
                    window.quartetEngine.state.sections[sectionIndex][field] = value;
                }
            });
            
            closeSectionModal();
            window.quartetEngine.showNotification('Section settings applied!');
        }
    </script>
</body>
</html>