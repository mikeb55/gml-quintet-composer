<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer v64 - FINAL FIX</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .version {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        select, input, button {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        #output {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº String Quintet Composer üéª</h1>
        <div class="version">v64 - FINAL FIX (Guitar octave DEFINITELY -1)</div>
        
        <div class="controls">
            <div class="control-group">
                <label for="key">Key:</label>
                <select id="key">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D" selected>D Major</option>
                    <option value="A">A Major</option>
                    <option value="F">F Major</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="measures">Measures:</label>
                <input type="number" id="measures" min="8" max="32" value="16">
            </div>
            
            <div class="control-group">
                <label for="guitarPattern">Guitar Pattern:</label>
                <select id="guitarPattern">
                    <option value="block">Block Chords</option>
                    <option value="arpeggiated">Arpeggiated</option>
                    <option value="fingerstyle">Fingerstyle</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="seed">Random Seed:</label>
                <input type="number" id="seed" min="1" max="999999" value="42">
            </div>
        </div>
        
        <div class="button-group">
            <button onclick="generateComposition()">üéµ Generate Composition</button>
            <button onclick="exportMusicXML()" id="exportBtn" disabled>üíæ Export MusicXML</button>
            <button onclick="playComposition()" id="playBtn" disabled>‚ñ∂Ô∏è Play</button>
            <button onclick="stopPlayback()" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
        </div>
        
        <div id="output"></div>
    </div>

    <script>
        // Musical constants
        const KEYS = {
            'C': { tonic: 0, notes: [0, 2, 4, 5, 7, 9, 11], sharps: 0 },
            'G': { tonic: 7, notes: [7, 9, 11, 0, 2, 4, 6], sharps: 1 },
            'D': { tonic: 2, notes: [2, 4, 6, 7, 9, 11, 1], sharps: 2 },
            'A': { tonic: 9, notes: [9, 11, 1, 2, 4, 6, 8], sharps: 3 },
            'F': { tonic: 5, notes: [5, 7, 9, 10, 0, 2, 4], sharps: -1 }
        };

        // Note names for display
        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        let compositionData = null;
        let audioContext = null;

        class RandomGenerator {
            constructor(seed) {
                this.seed = seed;
            }
            
            next() {
                this.seed = (this.seed * 1664525 + 1013904223) % 2147483647;
                return this.seed / 2147483647;
            }
            
            nextInt(min, max) {
                return Math.floor(this.next() * (max - min + 1)) + min;
            }
            
            choice(array) {
                return array[this.nextInt(0, array.length - 1)];
            }
        }

        class QuintetComposer {
            constructor(key, measures, guitarPattern, seed) {
                this.key = key;
                this.keyData = KEYS[key];
                this.measures = measures;
                this.guitarPattern = guitarPattern;
                this.rng = new RandomGenerator(seed);
                this.divisions = 256;
            }
            
            getChordProgression() {
                const progressions = [
                    [1, 5, 6, 4],  // I-V-vi-IV
                    [1, 4, 5, 1],  // I-IV-V-I
                    [1, 6, 4, 5],  // I-vi-IV-V
                    [1, 4, 1, 5],  // I-IV-I-V
                    [1, 5, 4, 5]   // I-V-IV-V
                ];
                return this.rng.choice(progressions);
            }
            
            buildChord(degree) {
                const scale = this.keyData.notes;
                const root = scale[degree - 1];
                const third = scale[(degree + 1) % 7];
                const fifth = scale[(degree + 3) % 7];
                const seventh = scale[(degree + 5) % 7];
                
                // Adjust octaves for proper chord voicing
                let chordNotes = [root, third, fifth, seventh].map(note => {
                    let midiNote = note + 48; // Start in octave 4
                    if (note < root) midiNote += 12;
                    return midiNote;
                });
                
                return chordNotes;
            }
            
            generateGuitarBar(chordNotes, barNumber) {
                const notes = [];
                
                // Generate guitar in ACTUAL guitar range (E2-E4)
                const guitarChord = chordNotes.map((note, idx) => {
                    let guitarNote = note - 12; // Move down 1 octave from chord (which is in octave 4)
                    // Guitar range is E2 (40) to E6 (88) but we want chords in lower-mid range
                    while (guitarNote > 64) guitarNote -= 12; // Max E4 for chords
                    while (guitarNote < 40) guitarNote += 12; // Min E2
                    return guitarNote;
                });
                
                switch(this.guitarPattern) {
                    case 'block':
                        // Block chords - twice per measure
                        notes.push({
                            pitch: guitarChord,
                            duration: this.divisions * 2,
                            type: 'half',
                            chord: true
                        });
                        notes.push({
                            pitch: guitarChord,
                            duration: this.divisions * 2,
                            type: 'half',
                            chord: true
                        });
                        break;
                        
                    case 'arpeggiated':
                        // Arpeggiated pattern
                        guitarChord.forEach(note => {
                            notes.push({
                                pitch: note,
                                duration: this.divisions,
                                type: 'quarter'
                            });
                        });
                        break;
                        
                    case 'fingerstyle':
                        // Bass note + chord pattern
                        notes.push({
                            pitch: guitarChord[0],
                            duration: this.divisions,
                            type: 'quarter'
                        });
                        notes.push({
                            pitch: guitarChord.slice(1),
                            duration: this.divisions,
                            type: 'quarter',
                            chord: true
                        });
                        notes.push({
                            pitch: guitarChord[2],
                            duration: this.divisions,
                            type: 'quarter'
                        });
                        notes.push({
                            pitch: guitarChord.slice(1),
                            duration: this.divisions,
                            type: 'quarter',
                            chord: true
                        });
                        break;
                }
                
                return notes;
            }
            
            generateViolinIMelody(chordNotes, barNumber) {
                const notes = [];
                const scale = this.keyData.notes.map(n => n + 60); // Octave 5
                
                // Create actual melodic phrases
                const rhythmPattern = this.rng.choice([
                    [2, 1, 1, 2], // half, quarter, quarter, half
                    [1, 1, 0.5, 0.5, 1, 2], // varied rhythm
                    [1, 1, 1, 1], // all quarters
                    [0.5, 0.5, 1, 2, 1] // eighth, eighth, quarter, half, quarter
                ]);
                
                let remainingDuration = 4;
                rhythmPattern.forEach(duration => {
                    if (remainingDuration >= duration) {
                        const noteIndex = this.rng.nextInt(0, scale.length - 1);
                        notes.push({
                            pitch: scale[noteIndex],
                            duration: this.divisions * duration,
                            type: duration === 2 ? 'half' : duration === 1 ? 'quarter' : 'eighth'
                        });
                        remainingDuration -= duration;
                    }
                });
                
                return notes;
            }
            
            generateViolinIIHarmony(chordNotes, barNumber, violin1Notes) {
                const notes = [];
                
                // Put Violin II in proper range (G3-E6, mostly around A4-E5)
                const violinIINotes = chordNotes.map(n => {
                    let note = n; // Already in octave 4
                    if (barNumber % 3 === 0) note += 12; // Sometimes go higher
                    return note;
                });
                
                // More interesting patterns
                const patterns = [
                    // Pattern 1: Contrary motion to violin I
                    () => {
                        notes.push({
                            pitch: violinIINotes[2],
                            duration: this.divisions,
                            type: 'quarter'
                        });
                        notes.push({
                            pitch: violinIINotes[1],
                            duration: this.divisions,
                            type: 'quarter'
                        });
                        notes.push({
                            pitch: violinIINotes[0],
                            duration: this.divisions * 2,
                            type: 'half'
                        });
                    },
                    // Pattern 2: Rhythmic complement
                    () => {
                        notes.push({
                            pitch: violinIINotes[0],
                            duration: this.divisions * 2,
                            type: 'half'
                        });
                        notes.push({
                            pitch: violinIINotes[2],
                            duration: this.divisions,
                            type: 'quarter'
                        });
                        notes.push({
                            pitch: violinIINotes[1],
                            duration: this.divisions,
                            type: 'quarter'
                        });
                    },
                    // Pattern 3: Syncopated
                    () => {
                        notes.push({
                            pitch: violinIINotes[1],
                            duration: this.divisions / 2,
                            type: 'eighth'
                        });
                        notes.push({
                            pitch: violinIINotes[2],
                            duration: this.divisions / 2,
                            type: 'eighth'
                        });
                        notes.push({
                            pitch: violinIINotes[0],
                            duration: this.divisions,
                            type: 'quarter'
                        });
                        notes.push({
                            pitch: violinIINotes[1],
                            duration: this.divisions * 2,
                            type: 'half'
                        });
                    }
                ];
                
                const pattern = patterns[barNumber % patterns.length];
                pattern();
                
                return notes;
            }
            
            generateViolaBar(chordNotes, barNumber) {
                const notes = [];
                
                // Keep viola in proper range C3-E6, mostly G3-A4
                const violaNotes = chordNotes.map(n => {
                    let note = n - 12; // Put in viola range (octave 3)
                    while (note < 48) note += 12; // C3 minimum
                    while (note > 67) note -= 12; // G4 maximum
                    return note;
                });
                
                // Varied patterns that work musically
                if (barNumber % 3 === 0) {
                    // Pattern 1: Flowing
                    notes.push({
                        pitch: violaNotes[0],
                        duration: this.divisions,
                        type: 'quarter'
                    });
                    notes.push({
                        pitch: violaNotes[1],
                        duration: this.divisions,
                        type: 'quarter'
                    });
                    notes.push({
                        pitch: violaNotes[2],
                        duration: this.divisions,
                        type: 'quarter'
                    });
                    notes.push({
                        pitch: violaNotes[0],
                        duration: this.divisions,
                        type: 'quarter'
                    });
                } else if (barNumber % 3 === 1) {
                    // Pattern 2: Rhythmic
                    notes.push({
                        pitch: violaNotes[2],
                        duration: this.divisions * 2,
                        type: 'half'
                    });
                    notes.push({
                        pitch: violaNotes[1],
                        duration: this.divisions,
                        type: 'quarter'
                    });
                    notes.push({
                        pitch: violaNotes[0],
                        duration: this.divisions,
                        type: 'quarter'
                    });
                } else {
                    // Pattern 3: Sustained with movement
                    notes.push({
                        pitch: violaNotes[1],
                        duration: this.divisions / 2,
                        type: 'eighth'
                    });
                    notes.push({
                        pitch: violaNotes[2],
                        duration: this.divisions / 2,
                        type: 'eighth'
                    });
                    notes.push({
                        pitch: violaNotes[1],
                        duration: this.divisions * 3,
                        type: 'half'
                    });
                }
                
                return notes;
            }
            
            generateCelloBar(chordNotes, barNumber) {
                const notes = [];
                
                // Cello in proper range C2-A4 (36-69)
                const root = chordNotes[0] - 12; // One octave down from chord root
                const fifth = chordNotes[2] - 12;
                
                // Ensure we're in cello range
                let bassRoot = root;
                let bassFifth = fifth;
                while (bassRoot < 36) bassRoot += 12; // C2 minimum
                while (bassRoot > 48) bassRoot -= 12; // Keep in lower register
                while (bassFifth < 36) bassFifth += 12;
                while (bassFifth > 52) bassFifth -= 12;
                
                // Walking bass pattern
                notes.push({
                    pitch: bassRoot,
                    duration: this.divisions * 2,
                    type: 'half'
                });
                notes.push({
                    pitch: bassFifth,
                    duration: this.divisions * 2,
                    type: 'half'
                });
                
                return notes;
            }
            
            compose() {
                const progression = this.getChordProgression();
                const parts = {
                    guitar: [],
                    violin1: [],
                    violin2: [],
                    viola: [],
                    cello: []
                };
                
                let output = "üéº COMPOSITION GENERATED - v64 FINAL\n";
                output += `Key: ${this.key} Major | Measures: ${this.measures}\n`;
                output += `Guitar Pattern: ${this.guitarPattern}\n`;
                output += `Progression: ${progression.map(d => ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii¬∞'][d-1]).join('-')}\n\n`;
                
                for (let measure = 0; measure < this.measures; measure++) {
                    const chordDegree = progression[measure % progression.length];
                    const chordNotes = this.buildChord(chordDegree);
                    
                    // Generate each part
                    const guitarBar = this.generateGuitarBar(chordNotes, measure);
                    const violin1Bar = this.generateViolinIMelody(chordNotes, measure);
                    const violin2Bar = this.generateViolinIIHarmony(chordNotes, measure, violin1Bar);
                    const violaBar = this.generateViolaBar(chordNotes, measure);
                    const celloBar = this.generateCelloBar(chordNotes, measure);
                    
                    // Store the data
                    parts.guitar.push(guitarBar);
                    parts.violin1.push(violin1Bar);
                    parts.violin2.push(violin2Bar);
                    parts.viola.push(violaBar);
                    parts.cello.push(celloBar);
                    
                    // Debug output
                    output += `Measure ${measure + 1}: ${['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii¬∞'][chordDegree-1]} chord\n`;
                    output += `  Guitar: ${guitarBar.map(n => Array.isArray(n.pitch) ? 'chord' : `${NOTE_NAMES[n.pitch % 12]}${Math.floor(n.pitch / 12)}`).join('-')}\n`;
                    output += `  Violin II: ${violin2Bar.map(n => `${NOTE_NAMES[n.pitch % 12]}${Math.floor(n.pitch / 12)}`).join('-')}\n`;
                    output += `  Viola: ${violaBar.map(n => `${NOTE_NAMES[n.pitch % 12]}${Math.floor(n.pitch / 12)}`).join('-')}\n`;
                    output += `  Cello: ${celloBar.map(n => `${NOTE_NAMES[n.pitch % 12]}${Math.floor(n.pitch / 12)}`).join('-')}\n`;
                }
                
                output += "\n‚úÖ v64 FINAL FIXES:\n";
                output += "‚Ä¢ Guitar: DEFINITELY using octave-change -1 (not -2)\n";
                output += "‚Ä¢ Guitar range: E2-E4 for chords\n";
                output += "‚Ä¢ Cello: C2-C3 range\n";
                output += "‚Ä¢ Viola: Varied patterns\n";
                output += "‚Ä¢ Violin II: Proper register\n";
                
                compositionData = {
                    key: this.key,
                    measures: this.measures,
                    parts: parts,
                    progression: progression
                };
                
                return output;
            }
        }
        
        function generateComposition() {
            const key = document.getElementById('key').value;
            const measures = parseInt(document.getElementById('measures').value);
            const guitarPattern = document.getElementById('guitarPattern').value;
            const seed = parseInt(document.getElementById('seed').value);
            
            const composer = new QuintetComposer(key, measures, guitarPattern, seed);
            const output = composer.compose();
            
            document.getElementById('output').innerText = output;
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('playBtn').disabled = false;
        }
        
        function exportMusicXML() {
            if (!compositionData) return;
            
            const xml = generateMusicXML(compositionData);
            downloadFile(xml, 'quintet_composition.musicxml');
        }
        
        function generateMusicXML(data) {
            const keyData = KEYS[data.key];
            let xml = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
            xml += '<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">\n';
            xml += '<score-partwise version="3.0">\n';
            xml += '  <work><work-title>String Quintet Composition</work-title></work>\n';
            xml += '  <part-list>\n';
            
            // Define parts - Guitar MUST have transpose -1 octave, not -2!
            const partInfo = [
                { id: 'P1', name: 'Guitar', clef: 'G', line: 2, transpose: true },
                { id: 'P2', name: 'Violin I', clef: 'G', line: 2, transpose: false },
                { id: 'P3', name: 'Violin II', clef: 'G', line: 2, transpose: false },
                { id: 'P4', name: 'Viola', clef: 'C', line: 3, transpose: false },
                { id: 'P5', name: 'Cello', clef: 'F', line: 4, transpose: false }
            ];
            
            partInfo.forEach(part => {
                xml += `    <score-part id="${part.id}">\n`;
                xml += `      <part-name>${part.name}</part-name>\n`;
                xml += `    </score-part>\n`;
            });
            
            xml += '  </part-list>\n';
            
            // Generate each part
            const partNames = ['guitar', 'violin1', 'violin2', 'viola', 'cello'];
            
            partInfo.forEach((partMeta, partIndex) => {
                xml += `  <part id="${partMeta.id}">\n`;
                
                const partData = data.parts[partNames[partIndex]];
                
                partData.forEach((measure, measureNum) => {
                    xml += `    <measure number="${measureNum + 1}">\n`;
                    
                    // First measure includes attributes
                    if (measureNum === 0) {
                        xml += '      <attributes>\n';
                        xml += '        <divisions>256</divisions>\n';
                        xml += `        <key><fifths>${keyData.sharps}</fifths></key>\n`;
                        xml += '        <time><beats>4</beats><beat-type>4</beat-type></time>\n';
                        xml += `        <clef><sign>${partMeta.clef}</sign><line>${partMeta.line}</line></clef>\n`;
                        
                        // CRITICAL FIX: Guitar gets octave-change -1, NOT -2!
                        if (partMeta.transpose && partMeta.name === 'Guitar') {
                            xml += '        <transpose>\n';
                            xml += '          <diatonic>0</diatonic>\n';
                            xml += '          <chromatic>0</chromatic>\n';
                            xml += '          <octave-change>-1</octave-change>\n'; // THIS IS THE KEY LINE!
                            xml += '        </transpose>\n';
                        }
                        
                        xml += '      </attributes>\n';
                    }
                    
                    // Generate notes for this measure
                    measure.forEach(note => {
                        if (Array.isArray(note.pitch)) {
                            // Chord
                            note.pitch.forEach((pitch, idx) => {
                                xml += '      <note>\n';
                                if (idx > 0) xml += '        <chord/>\n';
                                
                                // Guitar notes written one octave higher than they sound
                                const displayPitch = (partMeta.transpose && partMeta.name === 'Guitar') ? pitch + 12 : pitch;
                                xml += `        ${midiToPitchXML(displayPitch)}\n`;
                                xml += `        <duration>${note.duration}</duration>\n`;
                                xml += `        <type>${note.type}</type>\n`;
                                xml += '      </note>\n';
                            });
                        } else {
                            // Single note
                            xml += '      <note>\n';
                            
                            // Guitar notes written one octave higher than they sound
                            const displayPitch = (partMeta.transpose && partMeta.name === 'Guitar') ? note.pitch + 12 : note.pitch;
                            xml += `        ${midiToPitchXML(displayPitch)}\n`;
                            xml += `        <duration>${note.duration}</duration>\n`;
                            xml += `        <type>${note.type}</type>\n`;
                            xml += '      </note>\n';
                        }
                    });
                    
                    xml += '    </measure>\n';
                });
                
                xml += '  </part>\n';
            });
            
            xml += '</score-partwise>';
            return xml;
        }
        
        function midiToPitchXML(midi) {
            const noteNames = ['C', 'C', 'D', 'D', 'E', 'F', 'F', 'G', 'G', 'A', 'A', 'B'];
            const alterations = [0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0];
            
            const octave = Math.floor(midi / 12) - 1;
            const noteIndex = midi % 12;
            
            let xml = '<pitch>';
            xml += `<step>${noteNames[noteIndex]}</step>`;
            if (alterations[noteIndex]) xml += '<alter>1</alter>';
            xml += `<octave>${octave}</octave>`;
            xml += '</pitch>';
            
            return xml;
        }
        
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function playComposition() {
            // Simple playback stub
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('output').innerText += '\n\nüéµ Playing... (audio not implemented yet)';
        }
        
        function stopPlayback() {
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }
    </script>
</body>
</html>