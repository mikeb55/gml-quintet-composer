<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>String Quintet Composer v22 - Full Features</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2d3436;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .version {
            text-align: center;
            color: #636e72;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .success-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-left: 10px;
        }
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3436;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .control-group select,
        .control-group input {
            padding: 10px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .stops-section {
            grid-column: 1 / -1;
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ffc107;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        button:disabled {
            background: #b2bec3;
            cursor: not-allowed;
            opacity: 0.6;
        }
        button.success {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        }
        button.danger {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #d1f2eb;
            border: 1px solid #00b894;
            color: #00695c;
            display: none;
            font-weight: 600;
        }
        .status.active {
            display: block;
        }
        .error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        .preview-area {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .instrument-block {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .instrument-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d3436;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        .measure-display {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 5px 0;
        }
        .note-stop {
            color: #ff6b6b;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº String Quintet Composer <span class="success-badge">v22 FULL</span></h1>
        <div class="version">Version 22.0 - Full Features with Proven Correct Ranges</div>
        
        <div class="control-panel">
            <div class="control-group">
                <label for="measures">Number of Measures</label>
                <input type="number" id="measures" min="4" max="32" value="8">
            </div>
            
            <div class="control-group">
                <label for="key">Key Signature</label>
                <select id="key">
                    <option value="C,0">C Major</option>
                    <option value="G,1" selected>G Major</option>
                    <option value="D,2">D Major</option>
                    <option value="A,3">A Major</option>
                    <option value="E,4">E Major</option>
                    <option value="B,5">B Major</option>
                    <option value="F,-1">F Major</option>
                    <option value="Bb,-2">Bb Major</option>
                    <option value="Eb,-3">Eb Major</option>
                    <option value="Ab,-4">Ab Major</option>
                    <option value="Db,-5">Db Major</option>
                    <option value="Am,0">A Minor</option>
                    <option value="Em,1">E Minor</option>
                    <option value="Bm,2">B Minor</option>
                    <option value="Dm,-1">D Minor</option>
                    <option value="Gm,-2">G Minor</option>
                    <option value="Cm,-3">C Minor</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="tempo">Tempo (BPM)</label>
                <input type="number" id="tempo" min="60" max="200" value="120">
            </div>
            
            <div class="control-group">
                <label for="timeSignature">Time Signature</label>
                <select id="timeSignature">
                    <option value="4/4" selected>4/4 Common Time</option>
                    <option value="3/4">3/4 Waltz</option>
                    <option value="2/4">2/4 March</option>
                    <option value="6/8">6/8 Compound</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="rhythmPattern">Rhythm Pattern</label>
                <select id="rhythmPattern">
                    <option value="whole">Whole Notes</option>
                    <option value="half">Half Notes</option>
                    <option value="quarter" selected>Quarter Notes</option>
                    <option value="mixed">Mixed Rhythms</option>
                    <option value="complex">Complex (8ths & 16ths)</option>
                </select>
            </div>
            
            <div class="stops-section">
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="enableStops" checked> Enable Multiple Stops
                    </label>
                </div>
                <div class="control-group">
                    <label for="doubleStops">Double Stops %</label>
                    <input type="number" id="doubleStops" min="0" max="30" value="10">
                </div>
                <div class="control-group">
                    <label for="tripleStops">Triple Stops %</label>
                    <input type="number" id="tripleStops" min="0" max="20" value="5">
                </div>
                <div class="control-group">
                    <label for="quadStops">Quad Stops %</label>
                    <input type="number" id="quadStops" min="0" max="10" value="2">
                </div>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button onclick="generateFullComposition()">üéµ Generate Full Composition</button>
            <button onclick="exportFullXML()" id="exportBtn" disabled>üìÑ Export MusicXML</button>
            <button onclick="clearAll()" class="danger">üóëÔ∏è Clear</button>
        </div>
        
        <div id="status" class="status"></div>
        <div id="preview" class="preview-area"></div>
    </div>

    <script>
    // v22 - Full features with PROVEN correct ranges from v21
    const VERSION = '22.0';
    let composition = null;
    
    // PROVEN CORRECT RANGES from v21
    const INSTRUMENT_RANGES = {
        guitar: {
            name: 'Classical Guitar',
            lowest: { note: 'E', octave: 3 },
            highest: { note: 'B', octave: 5 },
            comfortable: { minOct: 3, maxOct: 4 },
            clef: { sign: 'G', line: 2 },
            canPlayStops: false
        },
        violin1: {
            name: 'Violin I',
            lowest: { note: 'G', octave: 3 },
            highest: { note: 'E', octave: 7 },
            comfortable: { minOct: 4, maxOct: 5 },
            clef: { sign: 'G', line: 2 },
            canPlayStops: true
        },
        violin2: {
            name: 'Violin II',
            lowest: { note: 'G', octave: 3 },
            highest: { note: 'E', octave: 7 },
            comfortable: { minOct: 4, maxOct: 5 },
            clef: { sign: 'G', line: 2 },
            canPlayStops: true
        },
        viola: {
            name: 'Viola',
            lowest: { note: 'C', octave: 3 },
            highest: { note: 'E', octave: 6 },
            comfortable: { minOct: 3, maxOct: 4 },
            clef: { sign: 'C', line: 3 }, // ALTO CLEF
            canPlayStops: true
        },
        cello: {
            name: 'Cello',
            lowest: { note: 'C', octave: 2 },
            highest: { note: 'A', octave: 5 },
            comfortable: { minOct: 2, maxOct: 3 },
            clef: { sign: 'F', line: 4 }, // BASS CLEF
            canPlayStops: true
        }
    };
    
    // KEY SIGNATURES
    const KEY_SIGNATURES = {
        'C,0': { fifths: 0, scale: ['C', 'D', 'E', 'F', 'G', 'A', 'B'] },
        'G,1': { fifths: 1, scale: ['G', 'A', 'B', 'C', 'D', 'E', 'F#'] },
        'D,2': { fifths: 2, scale: ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'] },
        'A,3': { fifths: 3, scale: ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'] },
        'E,4': { fifths: 4, scale: ['E', 'F#', 'G#', 'A', 'B', 'C#', 'D#'] },
        'B,5': { fifths: 5, scale: ['B', 'C#', 'D#', 'E', 'F#', 'G#', 'A#'] },
        'F,-1': { fifths: -1, scale: ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'] },
        'Bb,-2': { fifths: -2, scale: ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A'] },
        'Eb,-3': { fifths: -3, scale: ['Eb', 'F', 'G', 'Ab', 'Bb', 'C', 'D'] },
        'Ab,-4': { fifths: -4, scale: ['Ab', 'Bb', 'C', 'Db', 'Eb', 'F', 'G'] },
        'Db,-5': { fifths: -5, scale: ['Db', 'Eb', 'F', 'Gb', 'Ab', 'Bb', 'C'] },
        'Am,0': { fifths: 0, scale: ['A', 'B', 'C', 'D', 'E', 'F', 'G'] },
        'Em,1': { fifths: 1, scale: ['E', 'F#', 'G', 'A', 'B', 'C', 'D'] },
        'Bm,2': { fifths: 2, scale: ['B', 'C#', 'D', 'E', 'F#', 'G', 'A'] },
        'Dm,-1': { fifths: -1, scale: ['D', 'E', 'F', 'G', 'A', 'Bb', 'C'] },
        'Gm,-2': { fifths: -2, scale: ['G', 'A', 'Bb', 'C', 'D', 'Eb', 'F'] },
        'Cm,-3': { fifths: -3, scale: ['C', 'D', 'Eb', 'F', 'G', 'Ab', 'Bb'] }
    };
    
    // RHYTHM PATTERNS
    const RHYTHM_PATTERNS = {
        whole: [16],
        half: [8, 8],
        quarter: [4, 4, 4, 4],
        mixed: [8, 4, 4, 2, 2, 4],
        complex: [4, 2, 2, 1, 1, 1, 1, 4]
    };
    
    // Generate note in correct range
    function generateNoteInRange(instrumentKey, scale) {
        const inst = INSTRUMENT_RANGES[instrumentKey];
        const note = scale[Math.floor(Math.random() * scale.length)];
        
        // Use comfortable octave range
        const minOct = inst.comfortable.minOct;
        const maxOct = inst.comfortable.maxOct;
        const octave = minOct + Math.floor(Math.random() * (maxOct - minOct + 1));
        
        // Parse note for XML
        const step = note.replace(/[#b]/, '');
        let alter = 0;
        if (note.includes('#')) alter = 1;
        if (note.includes('b')) alter = -1;
        
        return { pitch: note, step: step, octave: octave, alter: alter };
    }
    
    // Generate full composition
    function generateFullComposition() {
        showStatus('Generating full composition...', 'info');
        
        const config = {
            measures: parseInt(document.getElementById('measures').value),
            key: document.getElementById('key').value,
            tempo: parseInt(document.getElementById('tempo').value),
            timeSignature: document.getElementById('timeSignature').value,
            rhythmPattern: document.getElementById('rhythmPattern').value,
            enableStops: document.getElementById('enableStops').checked,
            doubleStops: parseInt(document.getElementById('doubleStops').value) || 0,
            tripleStops: parseInt(document.getElementById('tripleStops').value) || 0,
            quadStops: parseInt(document.getElementById('quadStops').value) || 0
        };
        
        const keyData = KEY_SIGNATURES[config.key];
        
        composition = {
            config: config,
            keyData: keyData,
            parts: {}
        };
        
        // Generate each part
        for (let instrumentKey in INSTRUMENT_RANGES) {
            const inst = INSTRUMENT_RANGES[instrumentKey];
            const part = {
                name: inst.name,
                clef: inst.clef,
                measures: []
            };
            
            // Generate measures
            const [beatsNum, beatsDenom] = config.timeSignature.split('/').map(Number);
            const totalDivisions = (beatsNum * 16) / beatsDenom;
            
            for (let m = 0; m < config.measures; m++) {
                const events = [];
                let currentDivision = 0;
                const pattern = RHYTHM_PATTERNS[config.rhythmPattern];
                let patternIdx = 0;
                
                while (currentDivision < totalDivisions) {
                    const remaining = totalDivisions - currentDivision;
                    let duration = pattern[patternIdx % pattern.length];
                    
                    if (duration > remaining) {
                        duration = remaining;
                    }
                    
                    // Determine if this should be a stop
                    const stopType = determineStopType(instrumentKey, config);
                    
                    if (stopType > 1) {
                        // Generate stop
                        const notes = [];
                        for (let i = 0; i < stopType; i++) {
                            notes.push(generateNoteInRange(instrumentKey, keyData.scale));
                        }
                        events.push({
                            type: 'chord',
                            notes: notes,
                            duration: duration
                        });
                    } else {
                        // Single note
                        const note = generateNoteInRange(instrumentKey, keyData.scale);
                        events.push({
                            type: 'note',
                            notes: [note],
                            duration: duration
                        });
                    }
                    
                    currentDivision += duration;
                    patternIdx++;
                }
                
                part.measures.push({ events: events });
            }
            
            composition.parts[instrumentKey] = part;
        }
        
        displayPreview();
        document.getElementById('exportBtn').disabled = false;
        showStatus('Full composition generated successfully!', 'success');
    }
    
    // Determine stop type
    function determineStopType(instrumentKey, config) {
        const inst = INSTRUMENT_RANGES[instrumentKey];
        if (!inst.canPlayStops || !config.enableStops) {
            return 1;
        }
        
        const roll = Math.random() * 100;
        if (roll < config.quadStops) return 4;
        if (roll < config.quadStops + config.tripleStops) return 3;
        if (roll < config.quadStops + config.tripleStops + config.doubleStops) return 2;
        
        return 1;
    }
    
    // Display preview
    function displayPreview() {
        const preview = document.getElementById('preview');
        preview.innerHTML = '<h3>Composition Preview</h3>';
        
        for (let instrumentKey in composition.parts) {
            const part = composition.parts[instrumentKey];
            const inst = INSTRUMENT_RANGES[instrumentKey];
            
            const block = document.createElement('div');
            block.className = 'instrument-block';
            
            const header = document.createElement('div');
            header.className = 'instrument-header';
            header.innerHTML = `${part.name} (Octaves ${inst.comfortable.minOct}-${inst.comfortable.maxOct})`;
            block.appendChild(header);
            
            // Show first 2 measures
            for (let m = 0; m < Math.min(2, part.measures.length); m++) {
                const measureDiv = document.createElement('div');
                measureDiv.className = 'measure-display';
                
                let measureText = `M${m + 1}: `;
                part.measures[m].events.forEach(event => {
                    if (event.type === 'chord') {
                        const chord = event.notes.map(n => n.pitch + n.octave).join('+');
                        measureText += `<span class="note-stop">[${chord}]</span> `;
                    } else {
                        const note = event.notes[0].pitch + event.notes[0].octave;
                        measureText += `${note} `;
                    }
                });
                
                measureDiv.innerHTML = measureText;
                block.appendChild(measureDiv);
            }
            
            preview.appendChild(block);
        }
    }
    
    // Export full MusicXML
    function exportFullXML() {
        if (!composition) {
            showStatus('No composition to export', 'error');
            return;
        }
        
        showStatus('Exporting MusicXML...', 'info');
        
        const [beats, beatType] = composition.config.timeSignature.split('/');
        
        let xml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <work>
    <work-title>String Quintet v22</work-title>
  </work>
  <identification>
    <creator type="composer">Quintet Composer v22</creator>
  </identification>
  <part-list>`;
        
        // Part list
        let partNum = 1;
        for (let instrumentKey in composition.parts) {
            const part = composition.parts[instrumentKey];
            xml += `
    <score-part id="P${partNum}">
      <part-name>${part.name}</part-name>
    </score-part>`;
            partNum++;
        }
        
        xml += `
  </part-list>`;
        
        // Parts
        partNum = 1;
        for (let instrumentKey in composition.parts) {
            const part = composition.parts[instrumentKey];
            xml += `
  <part id="P${partNum}">`;
            
            for (let m = 0; m < part.measures.length; m++) {
                xml += `
    <measure number="${m + 1}">`;
                
                // First measure attributes
                if (m === 0) {
                    xml += `
      <attributes>
        <divisions>4</divisions>
        <key>
          <fifths>${composition.keyData.fifths}</fifths>
        </key>
        <time>
          <beats>${beats}</beats>
          <beat-type>${beatType}</beat-type>
        </time>
        <clef>
          <sign>${part.clef.sign}</sign>
          <line>${part.clef.line}</line>
        </clef>
      </attributes>`;
                    
                    // Tempo
                    if (partNum === 1) {
                        xml += `
      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${composition.config.tempo}</per-minute>
          </metronome>
        </direction-type>
      </direction>`;
                    }
                }
                
                // Add notes
                part.measures[m].events.forEach(event => {
                    event.notes.forEach((note, idx) => {
                        xml += `
      <note>`;
                        
                        if (event.type === 'chord' && idx > 0) {
                            xml += `
        <chord/>`;
                        }
                        
                        xml += `
        <pitch>
          <step>${note.step}</step>`;
                        
                        if (note.alter !== 0) {
                            xml += `
          <alter>${note.alter}</alter>`;
                        }
                        
                        xml += `
          <octave>${note.octave}</octave>
        </pitch>
        <duration>${event.duration}</duration>
        <type>${getDurationType(event.duration)}</type>
      </note>`;
                    });
                });
                
                xml += `
    </measure>`;
            }
            
            xml += `
  </part>`;
            partNum++;
        }
        
        xml += `
</score-partwise>`;
        
        // Download
        const blob = new Blob([xml], { type: 'application/vnd.recordare.musicxml+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'quintet_v22_full.musicxml';
        a.click();
        URL.revokeObjectURL(url);
        
        showStatus('MusicXML exported successfully!', 'success');
    }
    
    // Get duration type
    function getDurationType(divisions) {
        if (divisions >= 16) return 'whole';
        if (divisions >= 8) return 'half';
        if (divisions >= 4) return 'quarter';
        if (divisions >= 2) return 'eighth';
        return 'sixteenth';
    }
    
    // Clear
    function clearAll() {
        composition = null;
        document.getElementById('preview').innerHTML = '';
        document.getElementById('exportBtn').disabled = true;
        showStatus('Cleared', 'info');
    }
    
    // Show status
    function showStatus(message, type) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = 'status active';
        if (type === 'error') status.classList.add('error');
        
        if (type === 'success') {
            setTimeout(() => status.classList.remove('active'), 5000);
        }
    }
    
    // Initialize
    console.log('v22 Full Features initialized');
    console.log('Using proven correct ranges from v21');
    console.log('All features restored: keys, rhythms, stops');
    </script>
</body>
</html>