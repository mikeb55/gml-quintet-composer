<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>String Quintet Composer - Enhanced Guitar v29</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        .status-bar {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .status-item {
            display: inline-block;
            margin-right: 20px;
            padding: 5px 10px;
            background: #fff;
            border-radius: 5px;
        }
        .success { color: #28a745; font-weight: bold; }
        .new-badge { 
            background: #ffc107; 
            color: #000; 
            padding: 2px 8px; 
            border-radius: 5px; 
            font-size: 11px; 
            margin-left: 5px;
        }
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #6c757d;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .btn {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .action-buttons {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>String Quintet Composer</h1>
        <div class="subtitle">Version 29 - Enhanced Guitar Patterns <span class="new-badge">NEW</span></div>
        
        <div class="status-bar">
            <span class="status-item">Engine: <span class="success">READY</span></span>
            <span class="status-item">Division: <span class="success">256</span></span>
            <span class="status-item">Format: <span class="success">.musicxml</span></span>
            <span class="status-item">Guitar: <span class="success">ENHANCED</span></span>
        </div>

        <div class="control-panel">
            <div class="control-group">
                <h3>‚öôÔ∏è Composition Settings</h3>
                <label for="measures">Number of Measures:</label>
                <input type="number" id="measures" value="16" min="4" max="100">
                
                <label for="tempo">Tempo (BPM):</label>
                <input type="number" id="tempo" value="120" min="40" max="200">
                
                <label for="key">Key:</label>
                <select id="key">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="F">F Major</option>
                    <option value="Am">A Minor</option>
                </select>
            </div>

            <div class="control-group">
                <h3>üé∏ Guitar Style <span class="new-badge">ENHANCED</span></h3>
                <label for="guitarStyle">Pattern:</label>
                <select id="guitarStyle">
                    <option value="arpeggios">Simple Arpeggios</option>
                    <option value="alberti">Alberti Bass Pattern</option>
                    <option value="travis">Travis Picking</option>
                    <option value="tremolo">Classical Tremolo</option>
                    <option value="block">Block Chords</option>
                    <option value="fingerstyle">Modern Fingerstyle</option>
                </select>
            </div>

            <div class="control-group">
                <h3>üéµ Harmonic Style</h3>
                <label for="progression">Chord Progression:</label>
                <select id="progression">
                    <option value="classical">Classical (I-IV-V-I)</option>
                    <option value="pop">Pop (I-V-vi-IV)</option>
                    <option value="simple">Simple (I-I-V-V-I-I-IV-V)</option>
                    <option value="romantic">Romantic (I-vi-IV-V)</option>
                </select>
            </div>

            <div class="control-group">
                <h3>üé® Options</h3>
                <label>
                    <input type="checkbox" id="enableDynamics" checked> Include Dynamics
                </label>
                <label>
                    <input type="checkbox" id="enablePhrasing" checked> Phrase Markings
                </label>
                <label>
                    <input type="checkbox" id="simpleMode"> Simple Mode (Whole notes)</label>
                </label>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="generateComposition()">üéº Generate String Quintet</button>
        </div>
    </div>

    <script>
        // CORE CONFIGURATION - DO NOT CHANGE
        const DIVISIONS = 256;
        const FILE_EXTENSION = '.musicxml';
        
        // Key definitions
        const KEYS = {
            'C': { 
                tonic: 60,
                chords: {
                    'I': [60, 64, 67],
                    'ii': [62, 65, 69],
                    'IV': [65, 69, 60],
                    'V': [67, 71, 62],
                    'vi': [69, 60, 64]
                }
            },
            'G': {
                tonic: 67,
                chords: {
                    'I': [67, 71, 62],
                    'ii': [69, 60, 64],
                    'IV': [60, 64, 67],
                    'V': [62, 66, 69],
                    'vi': [64, 67, 71]
                }
            },
            'D': {
                tonic: 62,
                chords: {
                    'I': [62, 66, 69],
                    'ii': [64, 67, 71],
                    'IV': [67, 71, 62],
                    'V': [69, 61, 64],
                    'vi': [71, 62, 66]
                }
            },
            'F': {
                tonic: 65,
                chords: {
                    'I': [65, 69, 60],
                    'ii': [67, 70, 62],
                    'IV': [70, 62, 65],
                    'V': [60, 64, 67],
                    'vi': [62, 65, 69]
                }
            },
            'Am': {
                tonic: 57,
                chords: {
                    'i': [57, 60, 64],
                    'III': [60, 64, 67],
                    'iv': [62, 65, 69],
                    'V': [64, 67, 71],
                    'VI': [65, 69, 60]
                }
            }
        };
        
        const PROGRESSIONS = {
            'classical': ['I', 'IV', 'V', 'I'],
            'pop': ['I', 'V', 'vi', 'IV'],
            'simple': ['I', 'I', 'V', 'V', 'I', 'I', 'IV', 'V'],
            'romantic': ['I', 'vi', 'IV', 'V']
        };
        
        const INSTRUMENT_RANGES = {
            'Guitar': { min: 40, max: 76, clef: 'treble' },
            'Violin 1': { min: 55, max: 100, clef: 'treble' },
            'Violin 2': { min: 55, max: 100, clef: 'treble' },
            'Viola': { min: 48, max: 88, clef: 'alto' },
            'Cello': { min: 36, max: 81, clef: 'bass' }
        };
        
        const DURATIONS = {
            'whole': DIVISIONS * 4,
            'half': DIVISIONS * 2,
            'quarter': DIVISIONS,
            'eighth': DIVISIONS / 2,
            'sixteenth': DIVISIONS / 4
        };
        
        // NEW: Enhanced Guitar Patterns
        const GUITAR_PATTERNS = {
            'arpeggios': {
                pattern: [0, 1, 2, 1, 2, 1, 0, 1],
                rhythm: 'eighth'
            },
            'alberti': {
                pattern: [0, 2, 1, 2, 0, 2, 1, 2],
                rhythm: 'eighth'
            },
            'travis': {
                pattern: [0, 2, 0, 1, 0, 2, 0, 1],
                rhythm: 'eighth'
            },
            'tremolo': {
                pattern: [2, 2, 2, 2, 1, 1, 1, 1],
                rhythm: 'sixteenth'
            },
            'block': {
                pattern: [0, -1, 0, -1], // -1 means chord
                rhythm: 'quarter'
            },
            'fingerstyle': {
                pattern: [0, 2, 1, 0, 2, 1, 2, 0],
                rhythm: 'eighth'
            }
        };
        
        function generateProgression() {
            const progressionType = document.getElementById('progression').value;
            const key = document.getElementById('key').value;
            const keyInfo = KEYS[key];
            const progression = PROGRESSIONS[progressionType];
            
            const measures = parseInt(document.getElementById('measures').value);
            let fullProgression = [];
            
            for (let m = 0; m < measures; m++) {
                const chordSymbol = progression[m % progression.length];
                const chordTones = keyInfo.chords[chordSymbol] || keyInfo.chords['I'] || keyInfo.chords['i'];
                fullProgression.push({
                    symbol: chordSymbol,
                    tones: chordTones,
                    measure: m + 1
                });
            }
            
            return fullProgression;
        }
        
        function fitToRange(midi, min, max) {
            while (midi < min) midi += 12;
            while (midi > max) midi -= 12;
            return midi;
        }
        
        function midiToNote(midi) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(midi / 12) - 1;
            const noteIndex = midi % 12;
            const noteName = noteNames[noteIndex];
            const step = noteName.replace('#', '');
            const alter = noteName.includes('#') ? 1 : 0;
            return { step, alter, octave };
        }
        
        function generateNoteXML(midi, duration, noteType, isChord = false) {
            const note = midiToNote(midi);
            let xml = '<note>';
            if (isChord) xml += '<chord/>';
            xml += '<pitch>';
            xml += '<step>' + note.step + '</step>';
            if (note.alter) xml += '<alter>' + note.alter + '</alter>';
            xml += '<octave>' + note.octave + '</octave>';
            xml += '</pitch>';
            xml += '<duration>' + duration + '</duration>';
            xml += '<voice>1</voice>';
            xml += '<type>' + noteType + '</type>';
            xml += '</note>';
            return xml;
        }
        
        // NEW: Enhanced guitar generation
        function generateGuitarMeasure(chord, style) {
            const range = INSTRUMENT_RANGES['Guitar'];
            const pattern = GUITAR_PATTERNS[style] || GUITAR_PATTERNS['arpeggios'];
            let xml = '';
            
            if (style === 'block') {
                // Block chords - quarter note chords
                for (let i = 0; i < 4; i++) {
                    // Generate 3-note chord
                    for (let j = 0; j < chord.tones.length; j++) {
                        const midi = fitToRange(chord.tones[j], range.min, range.max);
                        xml += generateNoteXML(midi, DURATIONS.quarter, 'quarter', j > 0);
                    }
                }
            } else {
                // Pattern-based generation
                const duration = DURATIONS[pattern.rhythm];
                const noteType = pattern.rhythm;
                
                pattern.pattern.forEach(index => {
                    if (index >= 0) {
                        const tone = chord.tones[index % chord.tones.length];
                        const midi = fitToRange(tone, range.min, range.max);
                        xml += generateNoteXML(midi, duration, noteType);
                    }
                });
            }
            
            return xml;
        }
        
        function generateMeasureContent(instrumentName, chord, measureNum) {
            const range = INSTRUMENT_RANGES[instrumentName];
            const simpleMode = document.getElementById('simpleMode').checked;
            
            if (simpleMode) {
                const tone = chord.tones[0];
                const midi = fitToRange(tone, range.min, range.max);
                return generateNoteXML(midi, DURATIONS.whole, 'whole');
            }
            
            // Use enhanced guitar generation
            if (instrumentName === 'Guitar') {
                const style = document.getElementById('guitarStyle').value;
                return generateGuitarMeasure(chord, style);
            }
            
            // Other instruments remain the same as v28
            switch(instrumentName) {
                case 'Violin 1':
                    // Simple melody
                    let xml = '';
                    for (let i = 0; i < 4; i++) {
                        const tone = chord.tones[i % chord.tones.length];
                        const midi = fitToRange(tone + 12, range.min, range.max);
                        xml += generateNoteXML(midi, DURATIONS.quarter, 'quarter');
                    }
                    return xml;
                    
                case 'Violin 2':
                case 'Viola':
                    // Harmony
                    const tone = chord.tones[1 % chord.tones.length];
                    const midi = fitToRange(tone, range.min, range.max);
                    return generateNoteXML(midi, DURATIONS.whole, 'whole');
                    
                case 'Cello':
                    // Bass line
                    let bassXml = '';
                    const root = fitToRange(chord.tones[0], range.min, range.max);
                    const fifth = fitToRange(chord.tones[2 % chord.tones.length], range.min, range.max);
                    bassXml += generateNoteXML(root, DURATIONS.quarter, 'quarter');
                    bassXml += generateNoteXML(fifth, DURATIONS.quarter, 'quarter');
                    bassXml += generateNoteXML(root, DURATIONS.quarter, 'quarter');
                    bassXml += generateNoteXML(fifth, DURATIONS.quarter, 'quarter');
                    return bassXml;
            }
        }
        
        function generatePart(instrumentName, partId, progression) {
            let xml = '<part id="' + partId + '">';
            
            // First measure with attributes
            xml += '<measure number="1">';
            xml += '<attributes>';
            xml += '<divisions>' + DIVISIONS + '</divisions>';
            xml += '<key><fifths>0</fifths></key>';
            xml += '<time><beats>4</beats><beat-type>4</beat-type></time>';
            
            const clef = INSTRUMENT_RANGES[instrumentName].clef;
            if (clef === 'treble') {
                xml += '<clef><sign>G</sign><line>2</line></clef>';
            } else if (clef === 'alto') {
                xml += '<clef><sign>C</sign><line>3</line></clef>';
            } else if (clef === 'bass') {
                xml += '<clef><sign>F</sign><line>4</line></clef>';
            }
            xml += '</attributes>';
            
            if (partId === 'P1') {
                const tempo = document.getElementById('tempo').value;
                xml += '<direction placement="above">';
                xml += '<direction-type>';
                xml += '<metronome><beat-unit>quarter</beat-unit><per-minute>' + tempo + '</per-minute></metronome>';
                xml += '</direction-type>';
                xml += '</direction>';
            }
            
            if (document.getElementById('enableDynamics').checked) {
                xml += '<direction placement="below">';
                xml += '<direction-type>';
                xml += '<dynamics><mf/></dynamics>';
                xml += '</direction-type>';
                xml += '</direction>';
            }
            
            xml += generateMeasureContent(instrumentName, progression[0], 1);
            xml += '</measure>';
            
            // Remaining measures
            for (let m = 2; m <= progression.length; m++) {
                xml += '<measure number="' + m + '">';
                
                if (document.getElementById('enablePhrasing').checked && (m - 1) % 4 === 0) {
                    xml += '<direction placement="above">';
                    xml += '<direction-type>';
                    xml += '<words>phrase</words>';
                    xml += '</direction-type>';
                    xml += '</direction>';
                }
                
                xml += generateMeasureContent(instrumentName, progression[m - 1], m);
                xml += '</measure>';
            }
            
            xml += '</part>';
            return xml;
        }
        
        function generateComposition() {
            const progression = generateProgression();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            
            // Build MusicXML
            let xml = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
            xml += '<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" ';
            xml += '"http://www.musicxml.org/dtds/partwise.dtd">\n';
            xml += '<score-partwise version="3.1">\n';
            xml += '<work><work-title>String Quintet - v29</work-title></work>\n';
            xml += '<identification>\n';
            xml += '<creator type="composer">GML Quintet Composer v29</creator>\n';
            xml += '<encoding>\n';
            xml += '<software>GML String Quintet Composer - Enhanced Guitar</software>\n';
            xml += '<encoding-date>' + new Date().toISOString().split('T')[0] + '</encoding-date>\n';
            xml += '</encoding>\n';
            xml += '</identification>\n';
            
            xml += '<part-list>\n';
            const instruments = ['Guitar', 'Violin 1', 'Violin 2', 'Viola', 'Cello'];
            instruments.forEach((name, index) => {
                const partId = 'P' + (index + 1);
                xml += '<score-part id="' + partId + '">\n';
                xml += '<part-name>' + name + '</part-name>\n';
                xml += '</score-part>\n';
            });
            xml += '</part-list>\n';
            
            instruments.forEach((name, index) => {
                const partId = 'P' + (index + 1);
                xml += generatePart(name, partId, progression);
            });
            
            xml += '</score-partwise>';
            
            // Download
            const filename = 'quintet_v29_' + timestamp + FILE_EXTENSION;
            const blob = new Blob([xml], { type: 'application/vnd.recordare.musicxml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Generated: ' + filename + ' with ' + document.getElementById('guitarStyle').value + ' guitar pattern!');
        }
    </script>
</body>
</html>