<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer v12.13 - V10 Style Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #5a67d8;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .version {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .section-type-buttons {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .section-type-buttons h3 {
            color: #92400e;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .section-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .section-type-btn {
            background: white;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            text-align: center;
        }
        
        .section-type-btn:hover {
            background: #f59e0b;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .section-type-btn.exposition::before { content: "üìñ "; }
        .section-type-btn.development::before { content: "üîÑ "; }
        .section-type-btn.recapitulation::before { content: "üîÅ "; }
        .section-type-btn.coda::before { content: "üéµ "; }
        .section-type-btn.custom::before { content: "‚ú® "; }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .control-group h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        label {
            display: block;
            margin: 8px 0;
            color: #4a5568;
            font-weight: 500;
        }
        
        input[type="number"], 
        input[type="text"], 
        select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .section-container {
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .section-type-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fbbf24;
            color: #78350f;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            z-index: 10;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .section-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-letter {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .section-composer-badge {
            background: rgba(255,255,255,0.3);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .section-controls {
            background: #f9fafb;
            padding: 20px;
            display: none;
        }
        
        .section-controls.active {
            display: block;
        }
        
        .section-top-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        
        .composer-selector {
            grid-column: span 2;
        }
        
        .composer-mini-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .composer-mini-card {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            background: white;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .composer-mini-card:hover {
            background: #f7f3ff;
            border-color: #764ba2;
        }
        
        .composer-mini-card.selected {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-color: #667eea;
            font-weight: 600;
        }
        
        .theme-info {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #1e40af;
        }
        
        .theme-info strong {
            color: #1e3a8a;
        }
        
        .instrument-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }
        
        .instrument-box {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .instrument-box h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .remove-section {
            background: #fc8181;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .toggle-indicator {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .section-header.expanded .toggle-indicator {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº Quintet Composer v12.13 üéµ</h1>
        <div class="version">V10 Style Interface</div>
        
        <!-- Section Type Buttons - NEW FEATURE FROM v8.8 -->
        <div class="section-type-buttons">
            <h3>üéº Add Musical Structure Sections</h3>
            <div class="section-type-grid">
                <button class="section-type-btn exposition" onclick="addThemeSection('exposition')">
                    Exposition
                    <div style="font-size: 10px; font-weight: normal;">Present theme</div>
                </button>
                <button class="section-type-btn development" onclick="addThemeSection('development')">
                    Development
                    <div style="font-size: 10px; font-weight: normal;">Transform theme</div>
                </button>
                <button class="section-type-btn recapitulation" onclick="addThemeSection('recapitulation')">
                    Recapitulation
                    <div style="font-size: 10px; font-weight: normal;">Return theme</div>
                </button>
                <button class="section-type-btn coda" onclick="addThemeSection('coda')">
                    Coda
                    <div style="font-size: 10px; font-weight: normal;">Conclude</div>
                </button>
                <button class="section-type-btn custom" onclick="addThemeSection('custom')">
                    Custom Section
                    <div style="font-size: 10px; font-weight: normal;">Your design</div>
                </button>
            </div>
        </div>
        
        <!-- Global Controls -->
        <div class="controls-grid">
            <div class="control-group">
                <h3>üéµ Composition</h3>
                <label>
                    Title:
                    <input type="text" id="title" value="Theme & Development Quintet" />
                </label>
                <label>
                    Tempo (BPM):
                    <input type="number" id="tempo" min="40" max="200" value="120" />
                </label>
            </div>
            
            <div class="control-group">
                <h3>üìê Default Settings</h3>
                <label>
                    Measures per Section:
                    <input type="number" id="measuresPerSection" min="4" max="16" value="8" />
                </label>
                <label>
                    Default Key:
                    <select id="globalKey">
                        <option value="C">C Major</option>
                        <option value="G">G Major</option>
                        <option value="D">D Major</option>
                        <option value="F">F Major</option>
                        <option value="Am">A minor</option>
                        <option value="Em">E minor</option>
                    </select>
                </label>
            </div>
            
        </div>
        
        <!-- Sections Container -->
        <div id="sectionsContainer"></div>
        
        <!-- Generate/Export Buttons -->
        <div class="button-group">
            <button onclick="generateScore()">üéº Generate Score</button>
            <button onclick="exportMusicXML()" class="secondary" id="exportBtn" disabled style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">üíæ Export MusicXML</button>
            <button onclick="resetAll()" style="background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);">üîÑ Reset All</button>
        </div>
        
        <div id="status"></div>
    </div>
    
    <script>
        // Global variables
        let currentScore = null;
        let sections = [];
        let sectionCounter = 0;
        
        // Composer profiles
        const COMPOSERS = {
            bach: { name: 'Bach', style: 'Fugal' },
            mozart: { name: 'Mozart', style: 'Classical' },
            beethoven: { name: 'Beethoven', style: 'Dramatic' },
            brahms: { name: 'Brahms', style: 'Romantic' },
            ravel: { name: 'Ravel', style: 'Impressionist' },
            glass: { name: 'Glass', style: 'Minimalist' }
        };
        
        // Section templates with theme development
        const SECTION_TEMPLATES = {
            exposition: {
                name: 'Exposition',
                description: 'Present the main theme in home key',
                defaultKey: 'C',
                defaultMeasures: 8,
                themeTransform: 'original',
                chordProgression: 'I vi IV V I vi ii V'
            },
            development: {
                name: 'Development',
                description: 'Transform and modulate the theme',
                defaultKey: 'G',
                defaultMeasures: 12,
                themeTransform: 'fragmented',
                chordProgression: 'vi ii V I IV V/V V I'
            },
            recapitulation: {
                name: 'Recapitulation',
                description: 'Return theme in home key with variations',
                defaultKey: 'C',
                defaultMeasures: 8,
                themeTransform: 'inverted',
                chordProgression: 'I vi IV V vi ii V I'
            },
            coda: {
                name: 'Coda',
                description: 'Conclusive ending with theme fragments',
                defaultKey: 'C',
                defaultMeasures: 4,
                themeTransform: 'augmented',
                chordProgression: 'I IV I V I I I I'
            },
            custom: {
                name: 'Custom Section',
                description: 'User-defined section',
                defaultKey: 'C',
                defaultMeasures: 8,
                themeTransform: 'original',
                chordProgression: 'I V vi IV'
            }
        };
        
        // Initialize with exposition
        function initialize() {
            addThemeSection('exposition');
        }
        
        // Add themed section
        function addThemeSection(type) {
            const template = SECTION_TEMPLATES[type];
            const sectionNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            const sectionName = sectionNames[sections.length % sectionNames.length];
            
            const section = {
                id: `section-${sectionCounter}`,
                name: sectionName,
                type: type,
                templateName: template.name,
                composer: 'mozart',
                key: template.defaultKey || document.getElementById('globalKey').value,
                timeSignature: '4/4',
                measures: template.defaultMeasures,
                themeTransform: template.themeTransform,
                chordProgression: template.chordProgression,
                instruments: {
                    guitar: { pattern: 'chords', polyrhythm: 'none', dynamics: 'mf' },
                    violin1: { pattern: 'melody', polyrhythm: 'none', dynamics: 'mf' },
                    violin2: { pattern: 'harmony', polyrhythm: 'none', dynamics: 'mp' },
                    viola: { pattern: 'arpeggios', polyrhythm: 'none', dynamics: 'mp' },
                    cello: { pattern: 'bassline', polyrhythm: 'none', dynamics: 'mf' }
                }
            };
            
            sections.push(section);
            sectionCounter++;
            renderSections();
        }
        
        // Remove section
        function removeSection(id) {
            if (sections.length > 1) {
                sections = sections.filter(s => s.id !== id);
                renderSections();
            } else {
                showStatus('Must have at least one section', 'error');
            }
        }
        
        // Toggle section visibility
        function toggleSection(id) {
            const header = document.querySelector(`#${id} .section-header`);
            const controls = document.querySelector(`#${id} .section-controls`);
            header.classList.toggle('expanded');
            controls.classList.toggle('active');
        }
        
        // Update composer for section
        function updateComposer(sectionId, composer) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                section.composer = composer;
                document.querySelectorAll(`#${sectionId} .composer-mini-card`).forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`#${sectionId} [data-composer="${composer}"]`).classList.add('selected');
                document.querySelector(`#${sectionId} .section-composer-badge`).textContent = COMPOSERS[composer].name;
            }
        }
        
        // Update section settings
        function updateSection(sectionId, property, value) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                section[property] = value;
            }
        }
        
        // Update instrument settings
        function updateInstrument(sectionId, instrument, property, value) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                section.instruments[instrument][property] = value;
            }
        }
        
        // Render all sections
        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = sections.map(section => {
                const template = SECTION_TEMPLATES[section.type];
                return `
                <div class="section-container" id="${section.id}">
                    <div class="section-type-badge">${section.type}</div>
                    <div class="section-header ${sections.length === 1 ? 'expanded' : ''}" onclick="toggleSection('${section.id}')">
                        <h2>
                            <span class="section-letter">${section.name}</span>
                            ${section.templateName}
                            <span class="section-composer-badge">${COMPOSERS[section.composer].name}</span>
                        </h2>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${sections.length > 1 ? 
                                `<button class="remove-section" onclick="event.stopPropagation(); removeSection('${section.id}')">Remove</button>` 
                                : ''}
                            <span class="toggle-indicator">‚ñº</span>
                        </div>
                    </div>
                    <div class="section-controls ${sections.length === 1 ? 'active' : ''}">
                        <div class="theme-info">
                            <strong>${template.name}:</strong> ${template.description}<br>
                            <strong>Theme Treatment:</strong> ${section.themeTransform.charAt(0).toUpperCase() + section.themeTransform.slice(1)}<br>
                            <strong>Chord Progression:</strong> ${section.chordProgression}
                        </div>
                        
                        <div class="section-top-controls">
                            <div class="composer-selector">
                                <label style="font-weight: 600; color: #764ba2;">Composer Style:</label>
                                <div class="composer-mini-grid">
                                    ${Object.entries(COMPOSERS).map(([key, comp]) => `
                                        <div class="composer-mini-card ${section.composer === key ? 'selected' : ''}" 
                                             data-composer="${key}"
                                             onclick="updateComposer('${section.id}', '${key}')">
                                            ${comp.name}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <label>
                                    Key Signature:
                                    <select onchange="updateSection('${section.id}', 'key', this.value)">
                                        <option value="C" ${section.key === 'C' ? 'selected' : ''}>C Major</option>
                                        <option value="G" ${section.key === 'G' ? 'selected' : ''}>G Major</option>
                                        <option value="D" ${section.key === 'D' ? 'selected' : ''}>D Major</option>
                                        <option value="F" ${section.key === 'F' ? 'selected' : ''}>F Major</option>
                                        <option value="Am" ${section.key === 'Am' ? 'selected' : ''}>A minor</option>
                                        <option value="Em" ${section.key === 'Em' ? 'selected' : ''}>E minor</option>
                                    </select>
                                </label>
                            </div>
                            <div>
                                <label>
                                    Measures:
                                    <input type="number" value="${section.measures}" min="2" max="32" 
                                           onchange="updateSection('${section.id}', 'measures', this.value)">
                                </label>
                            </div>
                        </div>
                        
                        <h4 style="margin: 15px 0 10px 0; color: #4a5568;">Instrument Settings:</h4>
                        <div class="instrument-settings">
                            ${renderInstrumentSettings(section, 'guitar', 'üé∏ Guitar')}
                            ${renderInstrumentSettings(section, 'violin1', 'üéª Violin I')}
                            ${renderInstrumentSettings(section, 'violin2', 'üéª Violin II')}
                            ${renderInstrumentSettings(section, 'viola', 'üéª Viola')}
                            ${renderInstrumentSettings(section, 'cello', 'üéª Cello')}
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        
        // Render instrument settings
        function renderInstrumentSettings(section, instrument, displayName) {
            const settings = section.instruments[instrument];
            return `
                <div class="instrument-box">
                    <h4>${displayName}</h4>
                    <select onchange="updateInstrument('${section.id}', '${instrument}', 'pattern', this.value)" style="margin-bottom: 6px; font-size: 12px; padding: 5px;">
                        <option value="melody" ${settings.pattern === 'melody' ? 'selected' : ''}>Melody</option>
                        <option value="harmony" ${settings.pattern === 'harmony' ? 'selected' : ''}>Harmony</option>
                        <option value="chords" ${settings.pattern === 'chords' ? 'selected' : ''}>Chords</option>
                        <option value="arpeggios" ${settings.pattern === 'arpeggios' ? 'selected' : ''}>Arpeggios</option>
                        <option value="bassline" ${settings.pattern === 'bassline' ? 'selected' : ''}>Bass Line</option>
                    </select>
                    
                    <select onchange="updateInstrument('${section.id}', '${instrument}', 'dynamics', this.value)" style="font-size: 12px; padding: 5px;">
                        <option value="pp" ${settings.dynamics === 'pp' ? 'selected' : ''}>pp</option>
                        <option value="p" ${settings.dynamics === 'p' ? 'selected' : ''}>p</option>
                        <option value="mp" ${settings.dynamics === 'mp' ? 'selected' : ''}>mp</option>
                        <option value="mf" ${settings.dynamics === 'mf' ? 'selected' : ''}>mf</option>
                        <option value="f" ${settings.dynamics === 'f' ? 'selected' : ''}>f</option>
                        <option value="ff" ${settings.dynamics === 'ff' ? 'selected' : ''}>ff</option>
                    </select>
                </div>
            `;
        }
        
        // Transform theme based on section type
        function transformTheme(theme, transformType) {
            const themeNotes = theme.split(' ').map(n => parseInt(n)).filter(n => !isNaN(n));
            
            switch(transformType) {
                case 'original':
                    return themeNotes;
                    
                case 'fragmented':
                    // Take first 4 notes and repeat with variation
                    const fragment = themeNotes.slice(0, 4);
                    return [...fragment, ...fragment.map(n => n + 2)];
                    
                case 'inverted':
                    // Invert intervals
                    const firstNote = themeNotes[0];
                    return themeNotes.map((note, i) => {
                        if (i === 0) return firstNote;
                        const interval = themeNotes[i] - themeNotes[i-1];
                        return firstNote - interval;
                    });
                    
                case 'augmented':
                    // Double note durations (represented by repetition here)
                    return themeNotes.flatMap(n => [n, n]);
                    
                default:
                    return themeNotes;
            }
        }
        
        // Generate score
        function generateScore() {
            try {
                showStatus('Generating score...', 'info');
                
                // Check if we have sections
                if (sections.length === 0) {
                    showStatus('Please add at least one section first!', 'error');
                    return;
                }
                
                // Build structure summary
                const structure = sections.map(s => `${s.name}:${s.templateName}`).join(' ‚Üí ');
                
                // Create score object with all the necessary data
                currentScore = {
                    sections: sections,
                    generated: new Date().toISOString(),
                    structure: structure,
                    totalMeasures: sections.reduce((total, section) => total + section.measures, 0)
                };
                
                // Enable export button
                document.getElementById('exportBtn').disabled = false;
                
                showStatus(`Score generated successfully! Structure: ${structure}`, 'success');
                
            } catch (error) {
                console.error('Generation error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Export MusicXML
        function exportMusicXML() {
            if (!currentScore) {
                showStatus('No score to export!', 'error');
                return;
            }
            
            try {
                showStatus('Generating MusicXML...', 'info');
                
                // Generate proper MusicXML
                let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
                xml += '<score-partwise version="3.1">\n';
                xml += '  <part-list>\n';
                xml += '    <score-part id="P1"><part-name>Guitar</part-name></score-part>\n';
                xml += '    <score-part id="P2"><part-name>Violin I</part-name></score-part>\n';
                xml += '    <score-part id="P3"><part-name>Violin II</part-name></score-part>\n';
                xml += '    <score-part id="P4"><part-name>Viola</part-name></score-part>\n';
                xml += '    <score-part id="P5"><part-name>Cello</part-name></score-part>\n';
                xml += '  </part-list>\n';
                
                // Generate parts
                const instruments = ['guitar', 'violin1', 'violin2', 'viola', 'cello'];
                instruments.forEach((inst, i) => {
                    xml += `  <part id="P${i+1}">\n`;
                    
                    let measureNumber = 1;
                    sections.forEach((section, s) => {
                        for (let m = 1; m <= section.measures; m++) {
                            xml += `    <measure number="${measureNumber}">\n`;
                            
                            if (measureNumber === 1) {
                                xml += '      <attributes><divisions>4</divisions><key><fifths>0</fifths></key><time><beats>4</beats><beat-type>4</beat-type></time></attributes>\n';
                            }
                            
                            // Generate notes based on instrument and section settings
                            const pattern = section.instruments[inst].pattern;
                            const dynamics = section.instruments[inst].dynamics;
                            
                            if (pattern === 'chords' && inst === 'guitar') {
                                // Guitar chord pattern
                                xml += '      <note><pitch><step>C</step><octave>4</octave></pitch><duration>4</duration><type>quarter</type></note>\n';
                                xml += '      <note><pitch><step>E</step><octave>4</octave></pitch><duration>4</duration><type>quarter</type></note>\n';
                                xml += '      <note><pitch><step>G</step><octave>4</octave></pitch><duration>4</duration><type>quarter</type></note>\n';
                                xml += '      <note><pitch><step>C</step><octave>5</octave></pitch><duration>4</duration><type>quarter</type></note>\n';
                            } else if (pattern === 'melody' && (inst === 'violin1' || inst === 'violin2')) {
                                // Violin melody pattern
                                xml += '      <note><pitch><step>G</step><octave>5</octave></pitch><duration>2</duration><type>half</type></note>\n';
                                xml += '      <note><pitch><step>A</step><octave>5</octave></pitch><duration>2</duration><type>half</type></note>\n';
                            } else if (pattern === 'bassline' && inst === 'cello') {
                                // Cello bassline pattern
                                xml += '      <note><pitch><step>C</step><octave>3</octave></pitch><duration>4</duration><type>whole</type></note>\n';
                            } else if (pattern === 'arpeggios' && inst === 'viola') {
                                // Viola arpeggio pattern
                                xml += '      <note><pitch><step>C</step><octave>4</octave></pitch><duration>1</duration><type>quarter</type></note>\n';
                                xml += '      <note><pitch><step>E</step><octave>4</octave></pitch><duration>1</duration><type>quarter</type></note>\n';
                                xml += '      <note><pitch><step>G</step><octave>4</octave></pitch><duration>1</duration><type>quarter</type></note>\n';
                                xml += '      <note><pitch><step>C</step><octave>5</octave></pitch><duration>1</duration><type>quarter</type></note>\n';
                            } else {
                                // Default pattern - whole note
                                xml += '      <note><pitch><step>C</step><octave>4</octave></pitch><duration>4</duration><type>whole</type></note>\n';
                            }
                            
                            xml += '    </measure>\n';
                            measureNumber++;
                        }
                    });
                    xml += '  </part>\n';
                });
                
                xml += '</score-partwise>';
                
                // Create and download the file
                const blob = new Blob([xml], { type: 'application/vnd.recordare.musicxml+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quintet-v12.13-${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.musicxml`;
                a.click();
                URL.revokeObjectURL(url);
                
                showStatus('MusicXML exported successfully!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showStatus(`Export failed: ${error.message}`, 'error');
            }
        }
        
        // Reset all
        function resetAll() {
            sections = [];
            sectionCounter = 0;
            currentScore = null;
            document.getElementById('exportBtn').disabled = true;
            initialize();
            showStatus('All settings reset', 'info');
        }
        
        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            setTimeout(() => {
                status.textContent = '';
                status.className = 'status';
            }, 5000);
        }
        
        // Initialize on load
        initialize();
    </script>
</body>
</html>