 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer v10.2 - Working with Sections</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #5a67d8;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .version {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .control-group h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        label {
            display: block;
            margin: 8px 0;
            color: #4a5568;
            font-weight: 500;
        }
        
        input[type="number"], 
        input[type="text"], 
        select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .midi-upload {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: #f9f9f9;
            margin-bottom: 20px;
            position: relative;
        }
        
        .midi-upload:hover {
            background: #f0f0ff;
        }
        
        .midi-upload.dragover {
            background: #e0e0ff;
            border-color: #764ba2;
        }
        
        #midiFile {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .theme-display {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            display: none;
        }
        
        .theme-display.show {
            display: block;
        }
        
        .section-container {
            margin-bottom: 30px;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-controls {
            background: #f9fafb;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 20px;
        }
        
        .composer-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .composer-card {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            background: white;
        }
        
        .composer-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .composer-card.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        button.danger {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
        }
        
        button.add-section {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .status.info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }
        
        .remove-section {
            background: #fc8181;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .remove-section:hover {
            background: #f56565;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº Quintet Composer v10.2 üéµ</h1>
        <div class="version">Theme Development with Sections & MIDI Import</div>
        
        <!-- Global Controls -->
        <div class="controls-grid">
            <div class="control-group">
                <h3>üéµ Composition</h3>
                <label>
                    Title:
                    <input type="text" id="title" value="Quintet in C Major" />
                </label>
                <label>
                    Composer:
                    <input type="text" id="composer" value="Generated with v10.2" />
                </label>
            </div>
            
            <div class="control-group">
                <h3>‚è±Ô∏è Settings</h3>
                <label>
                    Tempo (BPM):
                    <input type="number" id="tempo" min="40" max="200" value="120" />
                </label>
                <label>
                    Measures per Section:
                    <input type="number" id="measuresPerSection" min="4" max="32" value="8" />
                </label>
            </div>
            
            <div class="control-group">
                <h3>üìÅ MIDI Import</h3>
                <div class="midi-upload" id="midiUpload">
                    <div>Drop MIDI file or click to browse</div>
                    <input type="file" id="midiFile" accept=".mid,.midi">
                </div>
                <div class="theme-display" id="themeDisplay"></div>
            </div>
        </div>
        
        <!-- Composer Selection -->
        <h3 style="margin: 20px 0 10px 0; color: #4a5568;">Select Composer Style:</h3>
        <div class="composer-grid">
            <div class="composer-card selected" data-composer="bach">Bach (Fugal)</div>
            <div class="composer-card" data-composer="mozart">Mozart (Classical)</div>
            <div class="composer-card" data-composer="beethoven">Beethoven (Dramatic)</div>
            <div class="composer-card" data-composer="brahms">Brahms (Romantic)</div>
            <div class="composer-card" data-composer="debussy">Debussy (Impressionist)</div>
            <div class="composer-card" data-composer="stravinsky">Stravinsky (Modern)</div>
        </div>
        
        <!-- Sections Container -->
        <div id="sectionsContainer"></div>
        
        <!-- Add Section Button -->
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="addSection()" class="add-section">‚ûï Add New Section</button>
        </div>
        
        <!-- Generate/Export Buttons -->
        <div class="button-group">
            <button onclick="generateScore()">üéº Generate Score</button>
            <button onclick="exportMusicXML()" class="secondary" id="exportBtn" disabled>üíæ Export MusicXML</button>
            <button onclick="resetAll()" class="danger">üîÑ Reset All</button>
        </div>
        
        <div id="status"></div>
    </div>
    
    <script>
        // Global variables
        let currentScore = null;
        let sections = [];
        let sectionCounter = 0;
        let currentComposer = 'bach';
        let importedTheme = null;
        
        // Musical data
        const SCALES = {
            'C': { notes: ['C', 'D', 'E', 'F', 'G', 'A', 'B'], fifths: 0 },
            'G': { notes: ['G', 'A', 'B', 'C', 'D', 'E', 'F#'], fifths: 1 },
            'D': { notes: ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'], fifths: 2 },
            'A': { notes: ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'], fifths: 3 },
            'F': { notes: ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'], fifths: -1 }
        };
        
        // Initialize composer selection
        document.querySelectorAll('.composer-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.composer-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                currentComposer = card.dataset.composer;
            });
        });
        
        // MIDI file handling
        document.getElementById('midiFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const buffer = await file.arrayBuffer();
                    const bytes = new Uint8Array(buffer);
                    
                    // Simple theme extraction (simplified for demo)
                    importedTheme = {
                        notes: ['C', 'E', 'G', 'C', 'B', 'G', 'E', 'C'],
                        octaves: [4, 4, 4, 5, 4, 4, 4, 4],
                        durations: [4, 4, 4, 4, 4, 4, 4, 4]
                    };
                    
                    document.getElementById('themeDisplay').className = 'theme-display show';
                    document.getElementById('themeDisplay').innerHTML = `
                        <strong>Theme loaded:</strong> ${importedTheme.notes.join(' ')}
                    `;
                    
                    showStatus('MIDI file loaded successfully!', 'success');
                } catch (error) {
                    showStatus('Error loading MIDI file', 'error');
                }
            }
        });
        
        // Drag and drop
        const midiUpload = document.getElementById('midiUpload');
        midiUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            midiUpload.classList.add('dragover');
        });
        
        midiUpload.addEventListener('dragleave', () => {
            midiUpload.classList.remove('dragover');
        });
        
        midiUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            midiUpload.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.mid') || file.name.endsWith('.midi'))) {
                const fileInput = document.getElementById('midiFile');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
            }
        });
        
        // Initialize with intro section
        function initialize() {
            addSection('intro');
        }
        
        // Add a new section
        function addSection(type = null) {
            const sectionTypes = ['intro', 'verse', 'chorus', 'bridge', 'outro'];
            const sectionName = type || sectionTypes[sections.length % sectionTypes.length];
            
            const section = {
                id: `section-${sectionCounter}`,
                name: sectionName,
                key: 'C',
                pattern: 'melodic'
            };
            
            sections.push(section);
            sectionCounter++;
            renderSections();
        }
        
        // Remove a section
        function removeSection(id) {
            if (sections.length > 1) {
                sections = sections.filter(s => s.id !== id);
                renderSections();
            } else {
                showStatus('Must have at least one section', 'error');
            }
        }
        
        // Render all sections
        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = sections.map(section => `
                <div class="section-container">
                    <div class="section-header">
                        <h2>Section: ${section.name.toUpperCase()}</h2>
                        ${sections.length > 1 ? 
                            `<button class="remove-section" onclick="removeSection('${section.id}')">Remove</button>` 
                            : ''}
                    </div>
                    <div class="section-controls">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>
                                    Key Signature:
                                    <select onchange="updateSection('${section.id}', 'key', this.value)">
                                        <option value="C" ${section.key === 'C' ? 'selected' : ''}>C Major</option>
                                        <option value="G" ${section.key === 'G' ? 'selected' : ''}>G Major</option>
                                        <option value="D" ${section.key === 'D' ? 'selected' : ''}>D Major</option>
                                        <option value="F" ${section.key === 'F' ? 'selected' : ''}>F Major</option>
                                    </select>
                                </label>
                            </div>
                            <div>
                                <label>
                                    Pattern Type:
                                    <select onchange="updateSection('${section.id}', 'pattern', this.value)">
                                        <option value="melodic" ${section.pattern === 'melodic' ? 'selected' : ''}>Melodic</option>
                                        <option value="harmonic" ${section.pattern === 'harmonic' ? 'selected' : ''}>Harmonic</option>
                                        <option value="rhythmic" ${section.pattern === 'rhythmic' ? 'selected' : ''}>Rhythmic</option>
                                        <option value="theme" ${section.pattern === 'theme' ? 'selected' : ''}>Use Theme</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update section setting
        function updateSection(sectionId, property, value) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                section[property] = value;
            }
        }
        
        // Generate the score
        function generateScore() {
            try {
                const title = document.getElementById('title').value;
                const composer = document.getElementById('composer').value;
                const tempo = parseInt(document.getElementById('tempo').value);
                const measuresPerSection = parseInt(document.getElementById('measuresPerSection').value);
                
                // Build MusicXML
                let musicXML = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <work>
    <work-title>${title}</work-title>
  </work>
  <identification>
    <creator type="composer">${composer}</creator>
    <encoding>
      <software>Quintet Composer v10.2</software>
      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
    </encoding>
  </identification>
  <part-list>
    <score-part id="P1">
      <part-name>Guitar</part-name>
    </score-part>
    <score-part id="P2">
      <part-name>Violin I</part-name>
    </score-part>
    <score-part id="P3">
      <part-name>Violin II</part-name>
    </score-part>
    <score-part id="P4">
      <part-name>Viola</part-name>
    </score-part>
    <score-part id="P5">
      <part-name>Cello</part-name>
    </score-part>
  </part-list>`;
                
                // Generate parts for each instrument
                const instruments = ['guitar', 'violin1', 'violin2', 'viola', 'cello'];
                const partIds = ['P1', 'P2', 'P3', 'P4', 'P5'];
                
                instruments.forEach((instrument, index) => {
                    musicXML += generatePart(
                        partIds[index],
                        instrument,
                        sections,
                        measuresPerSection,
                        tempo,
                        currentComposer,
                        importedTheme
                    );
                });
                
                musicXML += '\n</score-partwise>';
                
                currentScore = musicXML;
                document.getElementById('exportBtn').disabled = false;
                showStatus('Score generated successfully!', 'success');
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // Generate part for an instrument
        function generatePart(partId, instrument, sections, measuresPerSection, tempo, composer, theme) {
            let partXML = `\n  <part id="${partId}">`;
            let measureNumber = 1;
            
            sections.forEach((section, sectionIndex) => {
                for (let m = 0; m < measuresPerSection; m++) {
                    partXML += `\n    <measure number="${measureNumber}">`;
                    
                    // Add attributes for first measure
                    if (measureNumber === 1) {
                        partXML += `\n      <attributes>
        <divisions>4</divisions>
        <key>
          <fifths>${SCALES[section.key].fifths}</fifths>
        </key>
        <time>
          <beats>4</beats>
          <beat-type>4</beat-type>
        </time>
        <clef>`;
                        
                        if (instrument === 'cello') {
                            partXML += `\n          <sign>F</sign>
          <line>4</line>`;
                        } else if (instrument === 'viola') {
                            partXML += `\n          <sign>C</sign>
          <line>3</line>`;
                        } else {
                            partXML += `\n          <sign>G</sign>
          <line>2</line>`;
                        }
                        
                        partXML += `\n        </clef>
      </attributes>`;
                        
                        // Add tempo
                        partXML += `\n      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${tempo}</per-minute>
          </metronome>
        </direction-type>
        <sound tempo="${tempo}"/>
      </direction>`;
                    }
                    
                    // Generate notes based on composer style and section
                    partXML += generateMeasureContent(
                        instrument,
                        section,
                        composer,
                        theme,
                        m
                    );
                    
                    partXML += `\n    </measure>`;
                    measureNumber++;
                }
            });
            
            partXML += `\n  </part>`;
            return partXML;
        }
        
        // Generate measure content
        function generateMeasureContent(instrument, section, composer, theme, measureIndex) {
            let xml = '';
            const scale = SCALES[section.key].notes;
            
            // Use theme if available and section pattern is 'theme'
            if (theme && section.pattern === 'theme' && instrument === 'violin1') {
                const noteIndex = measureIndex % theme.notes.length;
                const note = theme.notes[noteIndex];
                const octave = theme.octaves[noteIndex];
                
                xml += `\n      <note>
        <pitch>
          <step>${note}</step>
          <octave>${octave}</octave>
        </pitch>
        <duration>16</duration>
        <type>whole</type>
      </note>`;
                return xml;
            }
            
            // Generate composer-specific patterns
            const patterns = getComposerPattern(composer, instrument, scale, measureIndex);
            
            patterns.forEach((noteData, i) => {
                xml += `\n      <note>`;
                
                if (noteData.rest) {
                    xml += `\n        <rest/>`;
                } else {
                    xml += `\n        <pitch>
          <step>${noteData.note}</step>`;
                    if (noteData.alter) {
                        xml += `\n          <alter>${noteData.alter}</alter>`;
                    }
                    xml += `\n          <octave>${noteData.octave}</octave>
        </pitch>`;
                }
                
                xml += `\n        <duration>${noteData.duration}</duration>
        <type>${noteData.type}</type>
      </note>`;
            });
            
            return xml;
        }
        
        // Get composer-specific patterns
        function getComposerPattern(composer, instrument, scale, measureIndex) {
            const octaves = {
                guitar: 3,
                violin1: 4,
                violin2: 4,
                viola: 3,
                cello: 2
            };
            
            const baseOctave = octaves[instrument];
            
            // Simple patterns for each composer
            switch(composer) {
                case 'bach':
                    // Contrapuntal style
                    if (instrument === 'violin1') {
                        return [
                            { note: scale[0], octave: baseOctave + 1, duration: 4, type: 'quarter' },
                            { note: scale[2], octave: baseOctave + 1, duration: 4, type: 'quarter' },
                            { note: scale[4], octave: baseOctave + 1, duration: 4, type: 'quarter' },
                            { note: scale[2], octave: baseOctave + 1, duration: 4, type: 'quarter' }
                        ];
                    } else if (instrument === 'cello') {
                        return [
                            { note: scale[0], octave: baseOctave, duration: 8, type: 'half' },
                            { note: scale[4], octave: baseOctave, duration: 8, type: 'half' }
                        ];
                    }
                    break;
                    
                case 'mozart':
                    // Classical elegance
                    if (instrument === 'violin1') {
                        return [
                            { note: scale[0], octave: baseOctave + 1, duration: 8, type: 'half' },
                            { note: scale[2], octave: baseOctave + 1, duration: 4, type: 'quarter' },
                            { note: scale[4], octave: baseOctave + 1, duration: 4, type: 'quarter' }
                        ];
                    }
                    break;
                    
                case 'beethoven':
                    // Dramatic motifs
                    if (instrument === 'violin1') {
                        return [
                            { note: scale[4], octave: baseOctave + 1, duration: 4, type: 'quarter' },
                            { note: scale[4], octave: baseOctave + 1, duration: 4, type: 'quarter' },
                            { note: scale[4], octave: baseOctave + 1, duration: 4, type: 'quarter' },
                            { note: scale[2], octave: baseOctave, duration: 4, type: 'quarter' }
                        ];
                    }
                    break;
                    
                case 'debussy':
                    // Impressionistic
                    return [
                        { note: scale[measureIndex % scale.length], octave: baseOctave, duration: 16, type: 'whole' }
                    ];
                    
                default:
                    // Default pattern
                    return [
                        { note: scale[0], octave: baseOctave, duration: 16, type: 'whole' }
                    ];
            }
            
            // Default fallback
            return [
                { note: scale[0], octave: baseOctave, duration: 16, type: 'whole' }
            ];
        }
        
        // Export MusicXML
        function exportMusicXML() {
            if (!currentScore) {
                showStatus('No score to export! Generate a score first.', 'error');
                return;
            }
            
            const blob = new Blob([currentScore], { type: 'application/vnd.recordare.musicxml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quintet-${currentComposer}-v10.2-${new Date().toISOString().slice(0, 10)}.musicxml`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('MusicXML file exported successfully!', 'success');
        }
        
        // Reset all
        function resetAll() {
            sections = [];
            sectionCounter = 0;
            currentScore = null;
            importedTheme = null;
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('themeDisplay').className = 'theme-display';
            document.getElementById('midiFile').value = '';
            initialize();
            showStatus('All settings reset', 'info');
        }
        
        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            setTimeout(() => {
                status.textContent = '';
                status.className = 'status';
            }, 5000);
        }
        
        // Initialize on load
        initialize();
    </script>
</body>
</html>