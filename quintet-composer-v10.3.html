<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer v10.3 - Enhanced Musical Generation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #5a67d8;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .version {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .control-group h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        label {
            display: block;
            margin: 8px 0;
            color: #4a5568;
            font-weight: 500;
        }
        
        input[type="number"], 
        input[type="text"], 
        select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .section-container {
            margin-bottom: 30px;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .section-controls {
            background: #f9fafb;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            display: none;
        }
        
        .section-controls.active {
            display: block;
        }
        
        .instrument-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .instrument-box {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .instrument-box h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .instrument-box select {
            margin-bottom: 8px;
            font-size: 12px;
            padding: 6px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        button.danger {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
        }
        
        button.add-section {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .remove-section {
            background: #fc8181;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .lead-instrument {
            background: #fef3c7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #fcd34d;
        }
        
        .lead-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .lead-options label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº Quintet Composer v10.3 üéµ</h1>
        <div class="version">Enhanced with Real Polyrhythms, Chords & Articulations</div>
        
        <!-- Global Controls -->
        <div class="controls-grid">
            <div class="control-group">
                <h3>üéµ Composition</h3>
                <label>
                    Title:
                    <input type="text" id="title" value="Polyrhythmic Quintet" />
                </label>
                <label>
                    Composer:
                    <input type="text" id="composer" value="Generated v10.3" />
                </label>
            </div>
            
            <div class="control-group">
                <h3>‚è±Ô∏è Settings</h3>
                <label>
                    Tempo (BPM):
                    <input type="number" id="tempo" min="40" max="200" value="120" />
                </label>
                <label>
                    Measures per Section:
                    <input type="number" id="measuresPerSection" min="4" max="16" value="4" />
                </label>
            </div>
        </div>
        
        <!-- Lead Instrument Selection -->
        <div class="lead-instrument">
            <h3>üéØ Lead Instrument</h3>
            <div class="lead-options">
                <label><input type="radio" name="lead" value="guitar"> üé∏ Guitar</label>
                <label><input type="radio" name="lead" value="violin1" checked> üéª Violin I</label>
                <label><input type="radio" name="lead" value="violin2"> üéª Violin II</label>
                <label><input type="radio" name="lead" value="viola"> üéª Viola</label>
                <label><input type="radio" name="lead" value="cello"> üéª Cello</label>
            </div>
        </div>
        
        <!-- Sections Container -->
        <div id="sectionsContainer"></div>
        
        <!-- Add Section Button -->
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="addSection()" class="add-section">‚ûï Add New Section</button>
        </div>
        
        <!-- Generate/Export Buttons -->
        <div class="button-group">
            <button onclick="generateScore()">üéº Generate Score</button>
            <button onclick="exportMusicXML()" class="secondary" id="exportBtn" disabled>üíæ Export MusicXML</button>
            <button onclick="resetAll()" class="danger">üîÑ Reset All</button>
        </div>
        
        <div id="status"></div>
    </div>
    
    <script>
        // Global variables
        let currentScore = null;
        let sections = [];
        let sectionCounter = 0;
        
        // Musical data - expanded from v9.1
        const CHORD_PROGRESSIONS = {
            'C': [
                { root: 'C', third: 'E', fifth: 'G' },  // I
                { root: 'F', third: 'A', fifth: 'C' },  // IV
                { root: 'G', third: 'B', fifth: 'D' },  // V
                { root: 'A', third: 'C', fifth: 'E' }   // vi
            ],
            'G': [
                { root: 'G', third: 'B', fifth: 'D' },
                { root: 'C', third: 'E', fifth: 'G' },
                { root: 'D', third: 'F', fifth: 'A' },
                { root: 'E', third: 'G', fifth: 'B' }
            ],
            'D': [
                { root: 'D', third: 'F', fifth: 'A' },
                { root: 'G', third: 'B', fifth: 'D' },
                { root: 'A', third: 'C', fifth: 'E' },
                { root: 'B', third: 'D', fifth: 'F' }
            ],
            'F': [
                { root: 'F', third: 'A', fifth: 'C' },
                { root: 'B', third: 'D', fifth: 'F' },
                { root: 'C', third: 'E', fifth: 'G' },
                { root: 'D', third: 'F', fifth: 'A' }
            ]
        };
        
        const SCALES = {
            'C': { notes: ['C', 'D', 'E', 'F', 'G', 'A', 'B'], fifths: 0 },
            'G': { notes: ['G', 'A', 'B', 'C', 'D', 'E', 'F'], fifths: 1, sharps: {'F': 1} },
            'D': { notes: ['D', 'E', 'F', 'G', 'A', 'B', 'C'], fifths: 2, sharps: {'F': 1, 'C': 1} },
            'F': { notes: ['F', 'G', 'A', 'B', 'C', 'D', 'E'], fifths: -1, flats: {'B': -1} }
        };
        
        // Initialize with one section
        function initialize() {
            addSection();
        }
        
        // Add a new section
        function addSection() {
            const sectionNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            const sectionName = sectionNames[sections.length % sectionNames.length];
            
            const section = {
                id: `section-${sectionCounter}`,
                name: sectionName,
                key: 'C',
                timeSignature: '4/4',
                instruments: {
                    guitar: { pattern: 'chords', polyrhythm: 'none', dynamics: 'mf' },
                    violin1: { pattern: 'melody', polyrhythm: 'none', dynamics: 'mf' },
                    violin2: { pattern: 'harmony', polyrhythm: 'none', dynamics: 'mp' },
                    viola: { pattern: 'arpeggios', polyrhythm: 'none', dynamics: 'mp' },
                    cello: { pattern: 'bassline', polyrhythm: 'none', dynamics: 'mf' }
                }
            };
            
            sections.push(section);
            sectionCounter++;
            renderSections();
        }
        
        // Remove a section
        function removeSection(id) {
            if (sections.length > 1) {
                sections = sections.filter(s => s.id !== id);
                renderSections();
            } else {
                showStatus('Must have at least one section', 'error');
            }
        }
        
        // Toggle section visibility
        function toggleSection(id) {
            const controls = document.querySelector(`#${id} .section-controls`);
            controls.classList.toggle('active');
        }
        
        // Render all sections
        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = sections.map(section => `
                <div class="section-container" id="${section.id}">
                    <div class="section-header" onclick="toggleSection('${section.id}')">
                        <h2>Section ${section.name}</h2>
                        ${sections.length > 1 ? 
                            `<button class="remove-section" onclick="event.stopPropagation(); removeSection('${section.id}')">Remove</button>` 
                            : ''}
                    </div>
                    <div class="section-controls ${section.name === 'A' ? 'active' : ''}">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label>
                                    Key Signature:
                                    <select onchange="updateSection('${section.id}', 'key', this.value)">
                                        <option value="C" ${section.key === 'C' ? 'selected' : ''}>C Major</option>
                                        <option value="G" ${section.key === 'G' ? 'selected' : ''}>G Major</option>
                                        <option value="D" ${section.key === 'D' ? 'selected' : ''}>D Major</option>
                                        <option value="F" ${section.key === 'F' ? 'selected' : ''}>F Major</option>
                                    </select>
                                </label>
                            </div>
                            <div>
                                <label>
                                    Time Signature:
                                    <select onchange="updateSection('${section.id}', 'timeSignature', this.value)">
                                        <option value="4/4" ${section.timeSignature === '4/4' ? 'selected' : ''}>4/4</option>
                                        <option value="3/4" ${section.timeSignature === '3/4' ? 'selected' : ''}>3/4</option>
                                        <option value="5/4" ${section.timeSignature === '5/4' ? 'selected' : ''}>5/4</option>
                                        <option value="6/8" ${section.timeSignature === '6/8' ? 'selected' : ''}>6/8</option>
                                        <option value="7/8" ${section.timeSignature === '7/8' ? 'selected' : ''}>7/8</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 10px; color: #4a5568;">Instrument Settings:</h4>
                        <div class="instrument-settings">
                            ${renderInstrumentSettings(section, 'guitar', 'üé∏ Guitar')}
                            ${renderInstrumentSettings(section, 'violin1', 'üéª Violin I')}
                            ${renderInstrumentSettings(section, 'violin2', 'üéª Violin II')}
                            ${renderInstrumentSettings(section, 'viola', 'üéª Viola')}
                            ${renderInstrumentSettings(section, 'cello', 'üéª Cello')}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Render instrument settings
        function renderInstrumentSettings(section, instrument, displayName) {
            const settings = section.instruments[instrument];
            return `
                <div class="instrument-box">
                    <h4>${displayName}</h4>
                    <select onchange="updateInstrument('${section.id}', '${instrument}', 'pattern', this.value)">
                        <option value="melody" ${settings.pattern === 'melody' ? 'selected' : ''}>Melody</option>
                        <option value="harmony" ${settings.pattern === 'harmony' ? 'selected' : ''}>Harmony</option>
                        <option value="chords" ${settings.pattern === 'chords' ? 'selected' : ''}>Chords</option>
                        <option value="arpeggios" ${settings.pattern === 'arpeggios' ? 'selected' : ''}>Arpeggios</option>
                        <option value="tremolo" ${settings.pattern === 'tremolo' ? 'selected' : ''}>Tremolo</option>
                        <option value="pizzicato" ${settings.pattern === 'pizzicato' ? 'selected' : ''}>Pizzicato</option>
                        <option value="staccato" ${settings.pattern === 'staccato' ? 'selected' : ''}>Staccato</option>
                        <option value="legato" ${settings.pattern === 'legato' ? 'selected' : ''}>Legato</option>
                        <option value="bassline" ${settings.pattern === 'bassline' ? 'selected' : ''}>Bass Line</option>
                        <option value="pedal" ${settings.pattern === 'pedal' ? 'selected' : ''}>Pedal Tone</option>
                    </select>
                    
                    <select onchange="updateInstrument('${section.id}', '${instrument}', 'polyrhythm', this.value)">
                        <option value="none" ${settings.polyrhythm === 'none' ? 'selected' : ''}>No Polyrhythm</option>
                        <option value="3:2" ${settings.polyrhythm === '3:2' ? 'selected' : ''}>3:2 (Triplets)</option>
                        <option value="4:3" ${settings.polyrhythm === '4:3' ? 'selected' : ''}>4:3</option>
                        <option value="5:4" ${settings.polyrhythm === '5:4' ? 'selected' : ''}>5:4 (Quintuplets)</option>
                        <option value="7:6" ${settings.polyrhythm === '7:6' ? 'selected' : ''}>7:6</option>
                    </select>
                    
                    <select onchange="updateInstrument('${section.id}', '${instrument}', 'dynamics', this.value)">
                        <option value="pp" ${settings.dynamics === 'pp' ? 'selected' : ''}>pp</option>
                        <option value="p" ${settings.dynamics === 'p' ? 'selected' : ''}>p</option>
                        <option value="mp" ${settings.dynamics === 'mp' ? 'selected' : ''}>mp</option>
                        <option value="mf" ${settings.dynamics === 'mf' ? 'selected' : ''}>mf</option>
                        <option value="f" ${settings.dynamics === 'f' ? 'selected' : ''}>f</option>
                        <option value="ff" ${settings.dynamics === 'ff' ? 'selected' : ''}>ff</option>
                    </select>
                </div>
            `;
        }
        
        // Update section settings
        function updateSection(sectionId, property, value) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                section[property] = value;
            }
        }
        
        // Update instrument settings
        function updateInstrument(sectionId, instrument, property, value) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                section.instruments[instrument][property] = value;
            }
        }
        
        // Generate the score
        function generateScore() {
            try {
                const title = document.getElementById('title').value;
                const composer = document.getElementById('composer').value;
                const tempo = parseInt(document.getElementById('tempo').value);
                const measuresPerSection = parseInt(document.getElementById('measuresPerSection').value);
                const leadInstrument = document.querySelector('input[name="lead"]:checked')?.value || 'violin1';
                
                // Build MusicXML with unique timestamp
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                let musicXML = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <work>
    <work-title>${title} - ${timestamp}</work-title>
  </work>
  <identification>
    <creator type="composer">${composer}</creator>
    <encoding>
      <software>Quintet Composer v10.3</software>
      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
    </encoding>
  </identification>
  <part-list>
    <score-part id="P1">
      <part-name>Guitar</part-name>
    </score-part>
    <score-part id="P2">
      <part-name>Violin I</part-name>
    </score-part>
    <score-part id="P3">
      <part-name>Violin II</part-name>
    </score-part>
    <score-part id="P4">
      <part-name>Viola</part-name>
    </score-part>
    <score-part id="P5">
      <part-name>Cello</part-name>
    </score-part>
  </part-list>`;
                
                // Generate parts for each instrument
                const instruments = ['guitar', 'violin1', 'violin2', 'viola', 'cello'];
                const partIds = ['P1', 'P2', 'P3', 'P4', 'P5'];
                
                instruments.forEach((instrument, index) => {
                    musicXML += generatePart(
                        partIds[index],
                        instrument,
                        sections,
                        measuresPerSection,
                        tempo,
                        leadInstrument === instrument
                    );
                });
                
                musicXML += '\n</score-partwise>';
                
                currentScore = musicXML;
                document.getElementById('exportBtn').disabled = false;
                showStatus('Score generated successfully with enhanced patterns!', 'success');
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // Generate part for an instrument (enhanced from v9.1)
        function generatePart(partId, instrument, sections, measuresPerSection, tempo, isLead) {
            let partXML = `\n  <part id="${partId}">`;
            let measureNumber = 1;
            
            sections.forEach((section, sectionIndex) => {
                const settings = section.instruments[instrument];
                const [beats, beatType] = section.timeSignature.split('/').map(Number);
                const scale = SCALES[section.key];
                const chords = CHORD_PROGRESSIONS[section.key] || CHORD_PROGRESSIONS['C'];
                
                for (let m = 0; m < measuresPerSection; m++) {
                    partXML += `\n    <measure number="${measureNumber}">`;
                    
                    // Add attributes for first measure
                    if (measureNumber === 1) {
                        partXML += `\n      <attributes>
        <divisions>4</divisions>
        <key>
          <fifths>${scale.fifths}</fifths>
        </key>
        <time>
          <beats>${beats}</beats>
          <beat-type>${beatType}</beat-type>
        </time>
        <clef>`;
                        
                        if (instrument === 'cello') {
                            partXML += `\n          <sign>F</sign>
          <line>4</line>`;
                        } else if (instrument === 'viola') {
                            partXML += `\n          <sign>C</sign>
          <line>3</line>`;
                        } else {
                            partXML += `\n          <sign>G</sign>
          <line>2</line>`;
                        }
                        
                        partXML += `\n        </clef>
      </attributes>`;
                        
                        // Add tempo
                        partXML += `\n      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${tempo}</per-minute>
          </metronome>
        </direction-type>
        <sound tempo="${tempo}"/>
      </direction>`;
                    }
                    
                    // Add rehearsal mark for new sections
                    if (m === 0) {
                        partXML += `\n      <direction placement="above">
        <direction-type>
          <rehearsal>${section.name}</rehearsal>
        </direction-type>
      </direction>`;
                        
                        // Add dynamics
                        partXML += `\n      <direction placement="below">
        <direction-type>
          <dynamics>
            <${settings.dynamics}/>
          </dynamics>
        </direction-type>
      </direction>`;
                    }
                    
                    // Generate notes based on pattern and polyrhythm
                    if (settings.polyrhythm !== 'none') {
                        partXML += generatePolyrhythmicNotes(
                            instrument, settings.polyrhythm, scale, 
                            chords[m % 4], beats, isLead
                        );
                    } else {
                        partXML += generatePatternNotes(
                            instrument, settings.pattern, scale,
                            chords[m % 4], beats, isLead
                        );
                    }
                    
                    partXML += `\n    </measure>`;
                    measureNumber++;
                }
            });
            
            partXML += `\n  </part>`;
            return partXML;
        }
        
        // Generate polyrhythmic notes (from v9.1)
        function generatePolyrhythmicNotes(instrument, polyrhythm, scale, chord, beats, isLead) {
            let xml = '';
            const [polyNum, polyBase] = polyrhythm.split(':').map(Number);
            const beatDuration = 4; // divisions per quarter note
            const polyDuration = (polyBase * beatDuration) / polyNum;
            const groupsPerMeasure = Math.floor((beats * beatDuration) / (polyBase * beatDuration));
            
            // Generate polyrhythmic groups
            for (let group = 0; group < groupsPerMeasure; group++) {
                for (let n = 0; n < polyNum; n++) {
                    const noteIndex = (group * polyNum + n) % scale.notes.length;
                    const note = scale.notes[noteIndex];
                    const octave = getOctaveForInstrument(instrument, isLead);
                    const alter = scale.sharps?.[note] || scale.flats?.[note] || 0;
                    
                    xml += `\n      <note>
        <pitch>
          <step>${note}</step>`;
                    if (alter !== 0) {
                        xml += `\n          <alter>${alter}</alter>`;
                    }
                    xml += `\n          <octave>${octave}</octave>
        </pitch>
        <duration>${Math.round(polyDuration)}</duration>
        <type>eighth</type>
        <time-modification>
          <actual-notes>${polyNum}</actual-notes>
          <normal-notes>${polyBase}</normal-notes>
        </time-modification>`;
                    
                    if (n === 0) {
                        xml += `\n        <notations>
          <tuplet type="start" bracket="yes" number="1"/>
        </notations>`;
                    } else if (n === polyNum - 1) {
                        xml += `\n        <notations>
          <tuplet type="stop" number="1"/>
        </notations>`;
                    }
                    
                    xml += `\n      </note>`;
                }
            }
            
            // Fill remaining beats with regular notes if needed
            const remainingDivisions = (beats * beatDuration) - (groupsPerMeasure * polyBase * beatDuration);
            if (remainingDivisions > 0) {
                const note = scale.notes[0];
                xml += createNote(note, getOctaveForInstrument(instrument, isLead), 0, remainingDivisions);
            }
            
            return xml;
        }
        
        // Generate pattern notes (enhanced from v9.1)
        function generatePatternNotes(instrument, pattern, scale, chord, beats, isLead) {
            let xml = '';
            const beatDuration = 4; // divisions per quarter note
            
            switch (pattern) {
                case 'chords':
                    // Real 3-note chords for guitar
                    if (instrument === 'guitar') {
                        for (let beat = 0; beat < beats; beat++) {
                            // Root
                            xml += createNote(chord.root, 3, 0, beatDuration, false);
                            // Third (as chord)
                            xml += createNote(chord.third, 3, 0, beatDuration, true);
                            // Fifth (as chord)
                            xml += createNote(chord.fifth, 4, 0, beatDuration, true);
                        }
                    } else {
                        // Other instruments play broken chords
                        for (let beat = 0; beat < beats; beat++) {
                            const notes = [chord.root, chord.third, chord.fifth];
                            const note = notes[beat % 3];
                            xml += createNote(note, getOctaveForInstrument(instrument, isLead), 0, beatDuration);
                        }
                    }
                    break;
                    
                case 'arpeggios':
                    // Up-down arpeggio pattern
                    const arpPattern = [chord.root, chord.third, chord.fifth, chord.third];
                    for (let beat = 0; beat < beats; beat++) {
                        const note = arpPattern[beat % 4];
                        xml += createNote(note, getOctaveForInstrument(instrument, isLead), 0, beatDuration);
                    }
                    break;
                    
                case 'tremolo':
                    // Rapid 16th notes
                    for (let beat = 0; beat < beats; beat++) {
                        for (let sixteenth = 0; sixteenth < 4; sixteenth++) {
                            const note = scale.notes[2]; // Use third of scale
                            xml += createNote(note, getOctaveForInstrument(instrument, isLead), 0, 1, false, 'staccato');
                        }
                    }
                    break;
                    
                case 'pizzicato':
                    // Quarter notes with pizzicato
                    for (let beat = 0; beat < beats; beat++) {
                        const noteIndex = (beat + (isLead ? 4 : 0)) % scale.notes.length;
                        const note = scale.notes[noteIndex];
                        xml += createNote(note, getOctaveForInstrument(instrument, isLead), 0, beatDuration, false, 'pizzicato');
                    }
                    break;
                    
                case 'staccato':
                    // Notes with staccato articulation
                    for (let beat = 0; beat < beats; beat++) {
                        const noteIndex = beat % scale.notes.length;
                        const note = scale.notes[noteIndex];
                        xml += createNote(note, getOctaveForInstrument(instrument, isLead), 0, beatDuration, false, 'staccato');
                    }
                    break;
                    
                case 'legato':
                    // Notes with tenuto marks
                    for (let beat = 0; beat < beats; beat++) {
                        const noteIndex = (beats - beat - 1) % scale.notes.length; // Descending
                        const note = scale.notes[noteIndex];
                        xml += createNote(note, getOctaveForInstrument(instrument, isLead), 0, beatDuration, false, 'tenuto');
                    }
                    break;
                    
                case 'bassline':
                    // Root-fifth alternation
                    for (let beat = 0; beat < beats; beat++) {
                        const note = beat % 2 === 0 ? chord.root : chord.fifth;
                        xml += createNote(note, getOctaveForInstrument(instrument, false), 0, beatDuration);
                    }
                    break;
                    
                case 'pedal':
                    // Sustained whole note
                    xml += createNote(chord.root, getOctaveForInstrument(instrument, false), 0, beats * beatDuration);
                    break;
                    
                case 'melody':
                    // Melodic line with variety
                    const melodyPattern = isLead ? [4, 2, 5, 3, 6, 4, 2, 0] : [0, 2, 4, 2];
                    for (let beat = 0; beat < beats; beat++) {
                        const noteIndex = melodyPattern[beat % melodyPattern.length] % scale.notes.length;
                        const note = scale.notes[noteIndex];
                        xml += createNote(note, getOctaveForInstrument(instrument, isLead), 0, beatDuration);
                    }
                    break;
                    
                case 'harmony':
                default:
                    // Harmonic support using chord tones
                    for (let beat = 0; beat < beats; beat++) {
                        const notes = [chord.third, chord.fifth, chord.root];
                        const note = notes[beat % 3];
                        xml += createNote(note, getOctaveForInstrument(instrument, false), 0, beatDuration);
                    }
            }
            
            return xml;
        }
        
        // Helper function to create a note
        function createNote(pitch, octave, alter, duration, isChord = false, articulation = null) {
            let xml = '\n      <note>';
            
            if (isChord) {
                xml += '\n        <chord/>';
            }
            
            xml += '\n        <pitch>';
            xml += `\n          <step>${pitch.charAt(0)}</step>`;
            
            if (alter !== 0 || pitch.includes('#') || pitch.includes('b')) {
                const alterValue = pitch.includes('#') ? 1 : pitch.includes('b') ? -1 : alter;
                if (alterValue !== 0) {
                    xml += `\n          <alter>${alterValue}</alter>`;
                }
            }
            
            xml += `\n          <octave>${octave}</octave>`;
            xml += '\n        </pitch>';
            xml += `\n        <duration>${duration}</duration>`;
            xml += `\n        <type>${getDurationType(duration)}</type>`;
            
            if (articulation) {
                xml += '\n        <notations>';
                if (articulation === 'staccato') {
                    xml += '\n          <articulations>\n            <staccato/>\n          </articulations>';
                } else if (articulation === 'tenuto') {
                    xml += '\n          <articulations>\n            <tenuto/>\n          </articulations>';
                } else if (articulation === 'pizzicato') {
                    xml += '\n          <technical>\n            <pizzicato/>\n          </technical>';
                }
                xml += '\n        </notations>';
            }
            
            xml += '\n      </note>';
            return xml;
        }
        
        // Get duration type
        function getDurationType(duration) {
            if (duration >= 16) return 'whole';
            if (duration >= 8) return 'half';
            if (duration >= 4) return 'quarter';
            if (duration >= 2) return 'eighth';
            if (duration >= 1) return '16th';
            return '32nd';
        }
        
        // Get octave for instrument
        function getOctaveForInstrument(instrument, isLead) {
            const octaves = {
                'guitar': isLead ? 4 : 3,
                'violin1': isLead ? 5 : 4,
                'violin2': isLead ? 5 : 4,
                'viola': isLead ? 4 : 3,
                'cello': isLead ? 3 : 2
            };
            return octaves[instrument] || 4;
        }
        
        // Export MusicXML
        function exportMusicXML() {
            if (!currentScore) {
                showStatus('No score to export! Generate a score first.', 'error');
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const blob = new Blob([currentScore], { type: 'application/vnd.recordare.musicxml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quintet-v10.3-${timestamp}.musicxml`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('MusicXML file exported successfully!', 'success');
        }
        
        // Reset all
        function resetAll() {
            sections = [];
            sectionCounter = 0;
            currentScore = null;
            document.getElementById('exportBtn').disabled = true;
            initialize();
            showStatus('All settings reset', 'info');
        }
        
        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            setTimeout(() => {
                status.textContent = '';
                status.className = 'status';
            }, 5000);
        }
        
        // Initialize on load
        initialize();
    </script>
</body>
</html>