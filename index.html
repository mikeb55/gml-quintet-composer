<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∏ QuintetComposer v2.1 - Enhanced Guitar Role System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4ade80;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-container {
            flex: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 30px;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            opacity: 0.9;
        }

        select, input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        select option {
            background: #2d2d3d;
            color: #fff;
            padding: 5px;
        }

        select option:hover {
            background: #ff6b6b;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(238, 90, 36, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-export {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }

        .visualization {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            min-height: 500px;
        }

        .instrument-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .instrument-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid;
        }

        .guitar-track { border-left-color: #ff6b6b; }
        .violin1-track { border-left-color: #667eea; }
        .violin2-track { border-left-color: #764ba2; }
        .viola-track { border-left-color: #a855f7; }
        .cello-track { border-left-color: #6366f1; }

        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .track-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(255, 107, 107, 0.2);
            border-radius: 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            min-height: 60px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .section-header {
            color: #ff6b6b;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .section-config {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 4px solid #ff6b6b;
        }

        .section-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #ff6b6b;
        }

        .guitar-role-selector {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .role-option {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .role-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .role-option.selected {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
        }

        .role-details {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-top: 15px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #ff6b6b;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .section-list-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .add-section-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .btn-add-section {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 10px 20px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .quartet-behavior {
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            border-left: 3px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üé∏</div>
                <div>
                    <h1 style="font-size: 24px;">QuintetComposer</h1>
                    <p style="font-size: 12px; opacity: 0.8;">Guitar + String Quartet Generator v2.1</p>
                </div>
            </div>
            <div class="connection-status">
                <div id="connectionDot" class="status-dot"></div>
                <span id="connectionText">Standalone Mode</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Left Panel - Controls -->
        <div class="panel">
            <h2 class="panel-title">üéõÔ∏è Composition Settings</h2>
            
            <div class="control-group">
                <label class="control-label">Form Structure</label>
                <select id="formStructure">
                    <option value="single">Single Section</option>
                    <option value="AB">A-B (Binary)</option>
                    <option value="ABA">A-B-A (Ternary)</option>
                    <option value="ABAB">A-B-A-B</option>
                    <option value="ABCD">A-B-C-D</option>
                    <option value="verse-chorus">Verse-Chorus</option>
                    <option value="custom">Custom Sections</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Key Center</label>
                <select id="keyCenter">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="E">E Major</option>
                    <option value="F">F Major</option>
                    <option value="Bb">B‚ô≠ Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                    <option value="Dm">D Minor</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Tempo (BPM)</label>
                <input type="number" id="tempo" min="40" max="200" value="120">
            </div>

            <div class="control-group">
                <label class="control-label">Total Measures</label>
                <input type="number" id="measures" min="4" max="64" value="16">
            </div>

            <div class="control-group">
                <label class="control-label">String Texture</label>
                <select id="stringTexture">
                    <option value="homophonic">Homophonic</option>
                    <option value="polyphonic">Polyphonic</option>
                    <option value="chorale">Chorale</option>
                    <option value="minimal">Minimal</option>
                </select>
            </div>

            <button id="generateBtn">üéµ Generate Quintet</button>
            <button id="sectionBtn" class="btn-secondary">‚öôÔ∏è Configure Sections</button>
            <button id="previewBtn" class="btn-secondary">‚ñ∂Ô∏è Preview Audio</button>
            <button id="clearBtn" class="btn-secondary">üîÑ Clear All</button>
        </div>

        <!-- Center Panel - Visualization -->
        <div class="panel">
            <h2 class="panel-title">üéº Quintet Arrangement</h2>
            <div class="visualization">
                <div class="instrument-grid">
                    <!-- Guitar Track -->
                    <div class="instrument-track guitar-track">
                        <div class="track-header">
                            <span class="track-name">
                                üé∏ Electric Guitar
                                <span id="guitarRoleDisplay" class="role-badge">Accompaniment</span>
                            </span>
                        </div>
                        <div id="guitarDisplay" class="section-display">Waiting for generation...</div>
                    </div>
                    
                    <!-- Violin I Track -->
                    <div class="instrument-track violin1-track">
                        <div class="track-header">
                            <span class="track-name">üéª Violin I</span>
                        </div>
                        <div id="violin1Display" class="section-display">Waiting for generation...</div>
                    </div>
                    
                    <!-- Violin II Track -->
                    <div class="instrument-track violin2-track">
                        <div class="track-header">
                            <span class="track-name">üéª Violin II</span>
                        </div>
                        <div id="violin2Display" class="section-display">Waiting for generation...</div>
                    </div>
                    
                    <!-- Viola Track -->
                    <div class="instrument-track viola-track">
                        <div class="track-header">
                            <span class="track-name">üéª Viola</span>
                        </div>
                        <div id="violaDisplay" class="section-display">Waiting for generation...</div>
                    </div>
                    
                    <!-- Cello Track -->
                    <div class="instrument-track cello-track">
                        <div class="track-header">
                            <span class="track-name">üéª Cello</span>
                        </div>
                        <div id="celloDisplay" class="section-display">Waiting for generation...</div>
                    </div>
                </div>

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-item">
                        <div class="stat-value" id="sectionCount">0</div>
                        <div class="stat-label">Sections</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="measureCount">0</div>
                        <div class="stat-label">Measures</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="noteCount">0</div>
                        <div class="stat-label">Total Notes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="guitarChanges">0</div>
                        <div class="stat-label">Guitar Role Changes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Export & Integration -->
        <div class="panel">
            <h2 class="panel-title">üì§ Export & Integration</h2>
            
            <div class="control-group">
                <label class="control-label">Guitar Library</label>
                <select id="guitarLibrary">
                    <option value="none">No Library Connected</option>
                    <option value="folk">Folk Patterns</option>
                    <option value="jazz">Jazz Voicings</option>
                    <option value="rock">Rock Riffs</option>
                    <option value="classical">Classical Arpeggios</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">RiffGen Integration</label>
                <button id="importRiffBtn" class="btn-secondary">üì• Import from RiffGen</button>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 16px;">Export Options</h3>
            <button id="exportMusicXMLBtn" class="btn-export">üìÑ Export MusicXML</button>
            <button id="exportMIDIBtn" class="btn-export">üéπ Export MIDI</button>
            <button id="exportJSONBtn" class="btn-export">üìä Export JSON</button>
            <button id="sendToDAWBtn" class="btn-export">üéöÔ∏è Send to DAW</button>

            <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 16px;">Section Overview</h3>
            <div id="sectionOverview" style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; font-size: 13px; line-height: 1.8;">
                No sections configured
            </div>
        </div>
    </div>

    <!-- Section Configuration Modal -->
    <div id="sectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé∏ Configure Sections - Guitar Roles</h2>
                <button class="modal-close" onclick="closeSectionModal()">‚úï</button>
            </div>
            
            <div class="add-section-controls">
                <button class="btn-add-section" onclick="window.quintetComposer.addNewSection()">‚ûï Add Section</button>
                <select onchange="if(this.value) window.quintetComposer.addTemplateSection(this.value); this.value='';" 
                        style="background: rgba(255, 255, 255, 0.1); padding: 10px;">
                    <option value="">Add from template...</option>
                    <option value="intro">Intro</option>
                    <option value="verse">Verse</option>
                    <option value="chorus">Chorus</option>
                    <option value="bridge">Bridge</option>
                    <option value="solo">Guitar Solo</option>
                    <option value="outro">Outro</option>
                </select>
                <span style="margin-left: auto; opacity: 0.7; align-self: center;">
                    Total: <span id="totalSectionCount">0</span> sections, 
                    <span id="totalMeasureCount">0</span> measures
                </span>
            </div>

            <div id="sectionConfigs" class="section-list-container">
                <!-- Section configurations will be added dynamically -->
            </div>
            
            <button onclick="applySections()" style="width: 100%; margin-top: 20px;">Apply Section Settings</button>
        </div>
    </div>

    <script>
        class QuintetComposer {
            constructor() {
                this.version = '2.1.0';
                this.state = {
                    parts: {
                        guitar: [],
                        violin1: [],
                        violin2: [],
                        viola: [],
                        cello: []
                    },
                    sections: [],
                    formStructure: 'single',
                    key: 'C',
                    tempo: 120,
                    timeSignature: '4/4',
                    measures: 16
                };

                // Guitar role configurations
                this.guitarRoles = {
                    accompaniment: {
                        name: 'Accompaniment',
                        description: 'Strumming, fingerpicking, or arpeggios',
                        quartetResponse: 'normal',
                        dynamicBalance: { guitar: 'mp', quartet: 'mf' }
                    },
                    riff: {
                        name: 'Riff',
                        description: 'Short repeated pattern (1-4 bars)',
                        quartetResponse: 'reduced',
                        dynamicBalance: { guitar: 'mf', quartet: 'mp' }
                    },
                    melody: {
                        name: 'Melody',
                        description: 'Lead melodic line',
                        quartetResponse: 'supportive',
                        dynamicBalance: { guitar: 'f', quartet: 'p' }
                    }
                };

                // Section templates with guitar roles
                this.sectionTemplates = {
                    intro: {
                        name: 'Intro',
                        measures: 4,
                        guitarRole: 'accompaniment',
                        guitarPattern: 'fingerpicking',
                        key: 'C',
                        stringTexture: 'minimal'
                    },
                    verse: {
                        name: 'Verse',
                        measures: 8,
                        guitarRole: 'accompaniment',
                        guitarPattern: 'strumming',
                        key: 'C',
                        stringTexture: 'homophonic'
                    },
                    chorus: {
                        name: 'Chorus',
                        measures: 8,
                        guitarRole: 'riff',
                        guitarPattern: 'power_chords',
                        key: 'G',
                        stringTexture: 'polyphonic'
                    },
                    bridge: {
                        name: 'Bridge',
                        measures: 4,
                        guitarRole: 'melody',
                        guitarPattern: 'lead',
                        key: 'F',
                        stringTexture: 'minimal'
                    },
                    solo: {
                        name: 'Guitar Solo',
                        measures: 8,
                        guitarRole: 'melody',
                        guitarPattern: 'solo',
                        key: 'C',
                        stringTexture: 'supportive'
                    },
                    outro: {
                        name: 'Outro',
                        measures: 4,
                        guitarRole: 'accompaniment',
                        guitarPattern: 'arpeggios',
                        key: 'C',
                        stringTexture: 'chorale'
                    }
                };

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkConnections();
                console.log('QuintetComposer v2.1 initialized - Section-based guitar roles enabled');
            }

            setupEventListeners() {
                // Main controls
                document.getElementById('generateBtn').addEventListener('click', () => this.generate());
                document.getElementById('sectionBtn').addEventListener('click', () => this.openSectionModal());
                document.getElementById('clearBtn').addEventListener('click', () => this.clear());
                document.getElementById('previewBtn').addEventListener('click', () => this.preview());

                // Export buttons
                document.getElementById('exportMusicXMLBtn').addEventListener('click', () => this.exportMusicXML());
                document.getElementById('exportMIDIBtn').addEventListener('click', () => this.exportMIDI());
                document.getElementById('exportJSONBtn').addEventListener('click', () => this.exportJSON());
                document.getElementById('sendToDAWBtn').addEventListener('click', () => this.sendToDAW());

                // Import button
                document.getElementById('importRiffBtn').addEventListener('click', () => this.importFromRiffGen());

                // Form structure change
                document.getElementById('formStructure').addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        this.openSectionModal();
                    } else {
                        this.setupPredefinedForm(e.target.value);
                    }
                });

                // Message listener for integration
                window.addEventListener('message', (e) => this.handleMessage(e));
            }

            checkConnections() {
                // Check for Dashboard or other app connections
                if (window.opener || window.parent !== window) {
                    this.updateConnectionStatus(true);
                    const target = window.opener || window.parent;
                    target.postMessage({
                        type: 'HANDSHAKE',
                        source: 'quintet-composer',
                        version: this.version
                    }, '*');
                }
            }

            updateConnectionStatus(connected) {
                const dot = document.getElementById('connectionDot');
                const text = document.getElementById('connectionText');
                if (dot) {
                    dot.classList.toggle('connected', connected);
                }
                if (text) {
                    text.textContent = connected ? 'Connected to Dashboard' : 'Standalone Mode';
                }
            }

            handleMessage(event) {
                const { type, data } = event.data;
                
                switch(type) {
                    case 'RIFF_DATA':
                        this.receiveRiffData(data);
                        break;
                    case 'QUARTET_DATA':
                        this.receiveQuartetData(data);
                        break;
                    case 'GENERATE_REQUEST':
                        this.generate();
                        break;
                }
            }

            setupPredefinedForm(formType) {
                const totalMeasures = parseInt(document.getElementById('measures').value);
                this.state.sections = [];
                
                switch(formType) {
                    case 'single':
                        this.state.sections.push({
                            ...this.sectionTemplates.verse,
                            measures: totalMeasures,
                            rehearsalMark: 'A'
                        });
                        break;
                        
                    case 'AB':
                        const half = Math.floor(totalMeasures / 2);
                        this.state.sections.push(
                            { ...this.sectionTemplates.verse, measures: half, rehearsalMark: 'A' },
                            { ...this.sectionTemplates.chorus, measures: totalMeasures - half, rehearsalMark: 'B' }
                        );
                        break;
                        
                    case 'verse-chorus':
                        const verseLen = Math.floor(totalMeasures * 0.4);
                        const chorusLen = Math.floor(totalMeasures * 0.4);
                        const bridgeLen = totalMeasures - verseLen - chorusLen;
                        this.state.sections.push(
                            { ...this.sectionTemplates.verse, measures: verseLen, rehearsalMark: 'A' },
                            { ...this.sectionTemplates.chorus, measures: chorusLen, rehearsalMark: 'B' },
                            { ...this.sectionTemplates.bridge, measures: bridgeLen, rehearsalMark: 'C' }
                        );
                        break;
                }
                
                this.updateSectionOverview();
            }

            openSectionModal() {
                const modal = document.getElementById('sectionModal');
                const container = document.getElementById('sectionConfigs');
                
                // Initialize with at least one section
                if (this.state.sections.length === 0) {
                    this.state.sections.push({
                        ...this.sectionTemplates.intro,
                        rehearsalMark: 'A'
                    });
                }
                
                this.renderSectionConfigs();
                modal.classList.add('active');
            }

            renderSectionConfigs() {
                const container = document.getElementById('sectionConfigs');
                container.innerHTML = '';
                
                this.state.sections.forEach((section, index) => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'section-config';
                    sectionDiv.innerHTML = `
                        <div class="section-config-header">
                            <span class="section-title">${section.name} [${section.rehearsalMark}]</span>
                            <div>
                                <span style="opacity: 0.7; margin-right: 10px;">${section.measures} measures</span>
                                ${this.state.sections.length > 1 ? `
                                <button onclick="window.quintetComposer.removeSection(${index})" 
                                        style="background: rgba(239, 68, 68, 0.2); 
                                               padding: 4px 8px; 
                                               width: auto;
                                               border-radius: 4px;">‚úï</button>` : ''}
                            </div>
                        </div>
                        
                        <div class="guitar-role-selector">
                            <div class="role-option ${section.guitarRole === 'accompaniment' ? 'selected' : ''}" 
                                 onclick="window.quintetComposer.setGuitarRole(${index}, 'accompaniment')">
                                <div style="font-size: 20px;">üé∏</div>
                                <div style="font-weight: 600;">Accompaniment</div>
                                <div style="font-size: 11px; opacity: 0.7;">Chords & Patterns</div>
                            </div>
                            <div class="role-option ${section.guitarRole === 'riff' ? 'selected' : ''}"
                                 onclick="window.quintetComposer.setGuitarRole(${index}, 'riff')">
                                <div style="font-size: 20px;">üéµ</div>
                                <div style="font-weight: 600;">Riff</div>
                                <div style="font-size: 11px; opacity: 0.7;">Repeated Pattern</div>
                            </div>
                            <div class="role-option ${section.guitarRole === 'melody' ? 'selected' : ''}"
                                 onclick="window.quintetComposer.setGuitarRole(${index}, 'melody')">
                                <div style="font-size: 20px;">üéº</div>
                                <div style="font-weight: 600;">Melody</div>
                                <div style="font-size: 11px; opacity: 0.7;">Lead Line</div>
                            </div>
                        </div>
                        
                        <div class="role-details">
                            <div class="detail-grid">
                                <div class="control-group">
                                    <label class="control-label">Section Name</label>
                                    <input type="text" value="${section.name}" 
                                           onchange="window.quintetComposer.updateSection(${index}, 'name', this.value)">
                                </div>
                                <div class="control-group">
                                    <label class="control-label">Measures</label>
                                    <input type="number" min="1" max="32" value="${section.measures}" 
                                           onchange="window.quintetComposer.updateSection(${index}, 'measures', parseInt(this.value))">
                                </div>
                                <div class="control-group">
                                    <label class="control-label">Key</label>
                                    <select onchange="window.quintetComposer.updateSection(${index}, 'key', this.value)">
                                        ${this.generateKeyOptions(section.key)}
                                    </select>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">Pattern</label>
                                    <select onchange="window.quintetComposer.updateSection(${index}, 'guitarPattern', this.value)">
                                        ${this.generatePatternOptions(section.guitarRole, section.guitarPattern)}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="quartet-behavior">
                            <strong>Quartet Behavior:</strong> 
                            ${this.guitarRoles[section.guitarRole].quartetResponse === 'normal' ? 
                              'Playing normally with full texture' :
                              section.guitarRole === 'riff' ? 
                              'Reduced rhythmic complexity to support riff' :
                              'Providing harmonic support for guitar melody'}
                        </div>
                    `;
                    container.appendChild(sectionDiv);
                });
                
                // Update totals
                document.getElementById('totalSectionCount').textContent = this.state.sections.length;
                document.getElementById('totalMeasureCount').textContent = 
                    this.state.sections.reduce((sum, s) => sum + s.measures, 0);
            }

            generateKeyOptions(selectedKey) {
                const keys = ['C', 'G', 'D', 'A', 'E', 'F', 'Bb', 'Am', 'Em', 'Dm'];
                return keys.map(key => 
                    `<option value="${key}" ${key === selectedKey ? 'selected' : ''}>${key} ${key.includes('m') ? 'Minor' : 'Major'}</option>`
                ).join('');
            }

            generatePatternOptions(role, selectedPattern) {
                const patterns = {
                    accompaniment: ['strumming', 'fingerpicking', 'arpeggios', 'power_chords'],
                    riff: ['rhythmic', 'melodic', 'hybrid', 'percussive'],
                    melody: ['lead', 'solo', 'counterpoint', 'doubling']
                };
                
                return patterns[role].map(pattern => 
                    `<option value="${pattern}" ${pattern === selectedPattern ? 'selected' : ''}>${pattern.replace('_', ' ')}</option>`
                ).join('');
            }

            setGuitarRole(sectionIndex, role) {
                this.state.sections[sectionIndex].guitarRole = role;
                this.state.sections[sectionIndex].guitarPattern = this.getDefaultPattern(role);
                this.renderSectionConfigs();
                this.showNotification(`Guitar role set to ${role} for ${this.state.sections[sectionIndex].name}`);
            }

            getDefaultPattern(role) {
                const defaults = {
                    accompaniment: 'strumming',
                    riff: 'rhythmic',
                    melody: 'lead'
                };
                return defaults[role];
            }

            updateSection(index, field, value) {
                this.state.sections[index][field] = value;
                if (field === 'measures') {
                    this.renderSectionConfigs();
                }
            }

            addNewSection() {
                const sectionNumber = this.state.sections.length + 1;
                const rehearsalMark = String.fromCharCode(65 + this.state.sections.length);
                
                this.state.sections.push({
                    name: `Section ${sectionNumber}`,
                    rehearsalMark: rehearsalMark,
                    measures: 4,
                    guitarRole: 'accompaniment',
                    guitarPattern: 'strumming',
                    key: 'C',
                    stringTexture: 'homophonic'
                });
                
                this.renderSectionConfigs();
                this.showNotification('Added new section');
            }

            addTemplateSection(templateName) {
                const template = this.sectionTemplates[templateName];
                if (template) {
                    const rehearsalMark = String.fromCharCode(65 + this.state.sections.length);
                    this.state.sections.push({
                        ...template,
                        rehearsalMark: rehearsalMark
                    });
                    this.renderSectionConfigs();
                    this.showNotification(`Added ${template.name} section`);
                }
            }

            removeSection(index) {
                if (this.state.sections.length > 1) {
                    this.state.sections.splice(index, 1);
                    // Regenerate rehearsal marks
                    this.state.sections.forEach((section, i) => {
                        section.rehearsalMark = String.fromCharCode(65 + i);
                    });
                    this.renderSectionConfigs();
                }
            }

            generate() {
                console.log('Generating quintet with section-based guitar roles...');
                
                // Clear previous
                this.state.parts = {
                    guitar: [],
                    violin1: [],
                    violin2: [],
                    viola: [],
                    cello: []
                };

                // Generate each section
                let currentMeasure = 0;
                let guitarRoleChanges = 0;
                let previousRole = null;
                
                this.state.sections.forEach((section, sectionIndex) => {
                    console.log(`Generating ${section.name}: Guitar=${section.guitarRole}, ${section.measures} measures`);
                    
                    // Track guitar role changes
                    if (previousRole && previousRole !== section.guitarRole) {
                        guitarRoleChanges++;
                    }
                    previousRole = section.guitarRole;
                    
                    // Generate measures for this section
                    for (let m = 0; m < section.measures; m++) {
                        const measureData = this.generateMeasure(section, m, currentMeasure + 1);
                        
                        // Add to each part
                        Object.keys(this.state.parts).forEach(part => {
                            this.state.parts[part].push({
                                measure: currentMeasure + 1,
                                section: section.name,
                                sectionRole: part === 'guitar' ? section.guitarRole : 'support',
                                notes: measureData[part].notes,
                                rhythm: measureData[part].rhythm
                            });
                        });
                        
                        currentMeasure++;
                    }
                });

                this.updateDisplay();
                this.updateStats(guitarRoleChanges);
                this.showNotification(`Generated quintet with ${this.state.sections.length} sections`);
            }

            generateMeasure(section, measureInSection, absoluteMeasure) {
                const measureData = {};
                
                // Generate based on guitar role
                switch(section.guitarRole) {
                    case 'accompaniment':
                        measureData.guitar = this.generateAccompaniment(section);
                        // Quartet plays normally
                        measureData.violin1 = this.generateStringPart('violin1', section, 'melody');
                        measureData.violin2 = this.generateStringPart('violin2', section, 'harmony');
                        measureData.viola = this.generateStringPart('viola', section, 'inner');
                        measureData.cello = this.generateStringPart('cello', section, 'bass');
                        break;
                        
                    case 'riff':
                        measureData.guitar = this.generateRiff(section, measureInSection);
                        // Quartet reduces complexity
                        measureData.violin1 = this.generateStringPart('violin1', section, 'sustained');
                        measureData.violin2 = this.generateStringPart('violin2', section, 'sustained');
                        measureData.viola = this.generateStringPart('viola', section, 'rhythmic');
                        measureData.cello = this.generateStringPart('cello', section, 'bass');
                        break;
                        
                    case 'melody':
                        measureData.guitar = this.generateMelody(section);
                        // Quartet provides support
                        measureData.violin1 = this.generateStringPart('violin1', section, 'countermelody');
                        measureData.violin2 = this.generateStringPart('violin2', section, 'pad');
                        measureData.viola = this.generateStringPart('viola', section, 'pad');
                        measureData.cello = this.generateStringPart('cello', section, 'bass');
                        break;
                }
                
                return measureData;
            }

            generateAccompaniment(section) {
                const patterns = {
                    strumming: { notes: [60, 64, 67], rhythm: [256, 256, 256, 256] },
                    fingerpicking: { notes: [60, 64, 67, 72], rhythm: [128, 128, 128, 128, 128, 128, 128, 128] },
                    arpeggios: { notes: [60, 64, 67, 72, 67, 64], rhythm: [128, 128, 128, 128, 128, 128] },
                    power_chords: { notes: [60, 67], rhythm: [512, 512] }
                };
                
                return patterns[section.guitarPattern] || patterns.strumming;
            }

            generateRiff(section, measureInSection) {
                // Riff repeats every 2 measures
                const riffPattern = measureInSection % 2 === 0 ? 
                    { notes: [60, 62, 64, 62], rhythm: [128, 128, 256, 256, 256] } :
                    { notes: [64, 62, 60, 67], rhythm: [256, 128, 128, 512] };
                
                return riffPattern;
            }

            generateMelody(section) {
                // Generate a melodic line
                const melodyNotes = [72, 74, 76, 74, 72, 69, 67];
                const melodyRhythm = [256, 128, 128, 256, 256, 128, 128];
                
                return { notes: melodyNotes, rhythm: melodyRhythm };
            }

            generateStringPart(instrument, section, role) {
                const ranges = {
                    violin1: { low: 55, high: 93 },
                    violin2: { low: 55, high: 88 },
                    viola: { low: 48, high: 81 },
                    cello: { low: 36, high: 69 }
                };
                
                const range = ranges[instrument];
                let notes = [];
                let rhythm = [];
                
                switch(role) {
                    case 'melody':
                        notes = [range.low + 24, range.low + 26, range.low + 28];
                        rhythm = [256, 256, 512];
                        break;
                    case 'harmony':
                        notes = [range.low + 19, range.low + 21];
                        rhythm = [512, 512];
                        break;
                    case 'bass':
                        notes = [range.low];
                        rhythm = [1024];
                        break;
                    case 'sustained':
                        notes = [range.low + 12];
                        rhythm = [1024];
                        break;
                    case 'pad':
                        notes = [range.low + 7, range.low + 12];
                        rhythm = [512, 512];
                        break;
                    case 'countermelody':
                        notes = [range.low + 19, range.low + 17, range.low + 15];
                        rhythm = [256, 256, 512];
                        break;
                    default:
                        notes = [range.low + 12];
                        rhythm = [1024];
                }
                
                return { notes, rhythm };
            }

            updateDisplay() {
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                Object.keys(this.state.parts).forEach(part => {
                    const displayId = part === 'guitar' ? 'guitarDisplay' : 
                                     part === 'violin1' ? 'violin1Display' :
                                     part === 'violin2' ? 'violin2Display' :
                                     part === 'viola' ? 'violaDisplay' : 'celloDisplay';
                    
                    const element = document.getElementById(displayId);
                    if (element && this.state.parts[part].length > 0) {
                        let currentSection = '';
                        const content = this.state.parts[part].map(m => {
                            let sectionMarker = '';
                            if (m.section !== currentSection) {
                                currentSection = m.section;
                                const roleText = part === 'guitar' ? ` (${m.sectionRole})` : '';
                                sectionMarker = `<span class="section-header">[${currentSection}${roleText}]</span> `;
                            }
                            
                            const notes = m.notes.map(n => {
                                const octave = Math.floor(n / 12) - 1;
                                const noteName = noteNames[n % 12];
                                return noteName + octave;
                            }).join(' ');
                            
                            return `${sectionMarker}M${m.measure}: ${notes}`;
                        }).join(' | ');
                        
                        element.innerHTML = content;
                    }
                });
                
                // Update guitar role display
                const guitarRoles = [...new Set(this.state.sections.map(s => s.guitarRole))];
                document.getElementById('guitarRoleDisplay').textContent = 
                    guitarRoles.length > 1 ? 'Mixed' : guitarRoles[0] || 'Accompaniment';
            }

            updateStats(guitarRoleChanges) {
                document.getElementById('sectionCount').textContent = this.state.sections.length;
                document.getElementById('measureCount').textContent = 
                    this.state.sections.reduce((sum, s) => sum + s.measures, 0);
                document.getElementById('noteCount').textContent = 
                    Object.values(this.state.parts).reduce((sum, part) => 
                        sum + part.reduce((s, m) => s + m.notes.length, 0), 0);
                document.getElementById('guitarChanges').textContent = guitarRoleChanges;
            }

            updateSectionOverview() {
                const overview = document.getElementById('sectionOverview');
                if (this.state.sections.length === 0) {
                    overview.innerHTML = 'No sections configured';
                    return;
                }
                
                const content = this.state.sections.map(section => 
                    `<div style="margin-bottom: 8px;">
                        <strong>${section.rehearsalMark}:</strong> ${section.name} 
                        <span style="color: #ff6b6b;">[${section.guitarRole}]</span> 
                        - ${section.measures}m
                    </div>`
                ).join('');
                
                overview.innerHTML = content;
            }

            exportMusicXML() {
                const xml = this.generateMusicXML();
                const blob = new Blob([xml], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quintet_${Date.now()}.musicxml`;
                a.click();
                this.showNotification('MusicXML exported successfully!');
            }

            generateMusicXML() {
                const measureCount = this.state.sections.reduce((sum, s) => sum + s.measures, 0);
                
                return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <work>
    <work-title>Quintet - Generated by QuintetComposer v2.1</work-title>
  </work>
  <part-list>
    <score-part id="P1">
      <part-name>Electric Guitar</part-name>
    </score-part>
    <score-part id="P2">
      <part-name>Violin I</part-name>
    </score-part>
    <score-part id="P3">
      <part-name>Violin II</part-name>
    </score-part>
    <score-part id="P4">
      <part-name>Viola</part-name>
    </score-part>
    <score-part id="P5">
      <part-name>Violoncello</part-name>
    </score-part>
  </part-list>
  ${this.generatePartsXML(measureCount)}
</score-partwise>`;
            }

            generatePartsXML(measureCount) {
                const parts = ['P1', 'P2', 'P3', 'P4', 'P5'];
                const instruments = ['guitar', 'violin1', 'violin2', 'viola', 'cello'];
                
                return parts.map((partId, index) => {
                    let xml = `<part id="${partId}">`;
                    
                    let currentMeasure = 0;
                    this.state.sections.forEach((section, sectionIndex) => {
                        for (let m = 0; m < section.measures; m++) {
                            currentMeasure++;
                            xml += this.generateMeasureXML(currentMeasure, instruments[index], section, m === 0);
                        }
                    });
                    
                    xml += '</part>';
                    return xml;
                }).join('');
            }

            generateMeasureXML(measureNum, instrument, section, isFirstInSection) {
                let xml = `<measure number="${measureNum}">`;
                
                if (measureNum === 1) {
                    xml += `
                    <attributes>
                        <divisions>256</divisions>
                        <key><fifths>0</fifths></key>
                        <time><beats>4</beats><beat-type>4</beat-type></time>
                    </attributes>`;
                }
                
                // Add rehearsal mark for guitar part at section start
                if (isFirstInSection && instrument === 'guitar') {
                    xml += `
                    <direction placement="above">
                        <direction-type>
                            <rehearsal font-weight="bold">${section.rehearsalMark}</rehearsal>
                        </direction-type>
                    </direction>`;
                    
                    // Add text for guitar role
                    xml += `
                    <direction placement="above">
                        <direction-type>
                            <words>Guitar: ${section.guitarRole}</words>
                        </direction-type>
                    </direction>`;
                }
                
                // Add notes
                const pitches = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                const octave = instrument === 'cello' ? 3 : instrument === 'viola' ? 4 : 5;
                
                xml += `
                <note>
                    <pitch>
                        <step>${pitches[Math.floor(Math.random() * pitches.length)]}</step>
                        <octave>${octave}</octave>
                    </pitch>
                    <duration>1024</duration>
                    <type>whole</type>
                </note>`;
                
                xml += '</measure>';
                return xml;
            }

            exportMIDI() {
                const data = {
                    format: 'midi',
                    tracks: Object.keys(this.state.parts).map(part => ({
                        name: part,
                        data: this.state.parts[part]
                    }))
                };
                
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quintet_${Date.now()}_midi.json`;
                a.click();
                this.showNotification('MIDI exported as JSON!');
            }

            exportJSON() {
                const data = {
                    type: 'quintet',
                    version: this.version,
                    timestamp: Date.now(),
                    sections: this.state.sections,
                    parts: this.state.parts
                };
                
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quintet_${Date.now()}.json`;
                a.click();
                this.showNotification('JSON exported successfully!');
            }

            sendToDAW() {
                // Future implementation for DAW integration
                this.showNotification('DAW integration coming in v2.2');
            }

            importFromRiffGen() {
                // Request riff data from RiffGen
                if (window.opener || window.parent !== window) {
                    const target = window.opener || window.parent;
                    target.postMessage({
                        type: 'REQUEST_RIFF',
                        source: 'quintet-composer'
                    }, '*');
                    this.showNotification('Requesting riff from RiffGen...');
                } else {
                    this.showNotification('RiffGen not connected');
                }
            }

            receiveRiffData(data) {
                console.log('Received riff data:', data);
                this.showNotification('Riff received from RiffGen!');
                // Future: Apply riff to current section
            }

            preview() {
                this.showNotification('Audio preview coming in v2.2');
            }

            clear() {
                this.state.parts = {
                    guitar: [],
                    violin1: [],
                    violin2: [],
                    viola: [],
                    cello: []
                };
                this.state.sections = [];
                this.updateDisplay();
                this.updateSectionOverview();
                this.showNotification('Cleared all parts');
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            window.quintetComposer = new QuintetComposer();
        });

        // Modal control functions
        function closeSectionModal() {
            document.getElementById('sectionModal').classList.remove('active');
            window.quintetComposer.updateSectionOverview();
        }

        function applySections() {
            closeSectionModal();
            window.quintetComposer.updateSectionOverview();
            window.quintetComposer.showNotification('Section settings applied!');
        }
    </script>
</body>
</html>