<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quintet Composer v64 - Fixed</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
        }
        h1 { text-align: center; margin-bottom: 30px; }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: white;
            color: black;
        }
        button {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 20px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¸ðŸŽ» Quintet Composer v64 - Guitar + Strings ðŸŽ»ðŸŽ¸</h1>
        
        <div class="controls">
            <div class="control-group">
                <label>Guitar Style</label>
                <select id="guitarStyle">
                    <option value="classical">Classical (P-I-M-A)</option>
                    <option value="travis">Travis Picking</option>
                    <option value="flamenco">Flamenco</option>
                    <option value="jazz">Jazz Comping</option>
                    <option value="fingerstyle">Fingerstyle</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Key</label>
                <select id="key">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="E">E Major</option>
                    <option value="Am">A minor</option>
                    <option value="Em">E minor</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Tempo</label>
                <input type="number" id="tempo" value="90" min="60" max="180">
            </div>
            
            <div class="control-group">
                <label>Measures</label>
                <input type="number" id="measures" value="16" min="8" max="32">
            </div>
        </div>
        
        <div style="text-align: center;">
            <button id="generateBtn">Generate Composition</button>
            <button id="exportBtn" disabled>Export MusicXML</button>
        </div>
        
        <div id="status" class="status">Ready to compose</div>
        
        <div id="stats" class="stats" style="display: none;">
            <div class="stat">
                <strong>Key:</strong> <span id="statKey"></span>
            </div>
            <div class="stat">
                <strong>Guitar Style:</strong> <span id="statStyle"></span>
            </div>
            <div class="stat">
                <strong>Measures:</strong> <span id="statMeasures"></span>
            </div>
            <div class="stat">
                <strong>Notes:</strong> <span id="statNotes"></span>
            </div>
        </div>
    </div>

    <script>
        // Global composition object
        let composition = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            
            // Add event listeners
            document.getElementById('generateBtn').addEventListener('click', generateComposition);
            document.getElementById('exportBtn').addEventListener('click', exportMusicXML);
        });

        // Generate the composition
        function generateComposition() {
            console.log('Generating composition...');
            
            try {
                const guitarStyle = document.getElementById('guitarStyle').value;
                const key = document.getElementById('key').value;
                const tempo = parseInt(document.getElementById('tempo').value);
                const measures = parseInt(document.getElementById('measures').value);
                
                // Initialize composition
                composition = {
                    title: 'Quintet in ' + key,
                    guitarStyle: guitarStyle,
                    key: key,
                    tempo: tempo,
                    measures: measures,
                    parts: {
                        guitar: [],
                        violin1: [],
                        violin2: [],
                        viola: [],
                        cello: []
                    }
                };
                
                // Get chord progression for the key
                const progression = getChordProgression(key);
                
                // Generate music for each measure
                for (let m = 0; m < measures; m++) {
                    const chord = progression[m % progression.length];
                    
                    // Generate each part
                    composition.parts.guitar.push(generateGuitarPart(chord, guitarStyle));
                    composition.parts.violin1.push(generateViolin1(chord, key, m));
                    composition.parts.violin2.push(generateViolin2(chord));
                    composition.parts.viola.push(generateViola(chord));
                    composition.parts.cello.push(generateCello(chord));
                }
                
                // Update status
                document.getElementById('status').textContent = 'Generated ' + measures + ' measures with ' + guitarStyle + ' guitar style';
                document.getElementById('exportBtn').disabled = false;
                
                // Show stats
                updateStats();
                
            } catch (error) {
                document.getElementById('status').textContent = 'Error: ' + error.message;
                console.error(error);
            }
        }

        // Get chord progression based on key
        function getChordProgression(key) {
            const progressions = {
                'C': [
                    {root: 'C', third: 'E', fifth: 'G', symbol: 'C'},
                    {root: 'F', third: 'A', fifth: 'C', symbol: 'F'},
                    {root: 'G', third: 'B', fifth: 'D', symbol: 'G'},
                    {root: 'C', third: 'E', fifth: 'G', symbol: 'C'}
                ],
                'G': [
                    {root: 'G', third: 'B', fifth: 'D', symbol: 'G'},
                    {root: 'C', third: 'E', fifth: 'G', symbol: 'C'},
                    {root: 'D', third: 'F#', fifth: 'A', symbol: 'D'},
                    {root: 'G', third: 'B', fifth: 'D', symbol: 'G'}
                ],
                'D': [
                    {root: 'D', third: 'F#', fifth: 'A', symbol: 'D'},
                    {root: 'G', third: 'B', fifth: 'D', symbol: 'G'},
                    {root: 'A', third: 'C#', fifth: 'E', symbol: 'A'},
                    {root: 'D', third: 'F#', fifth: 'A', symbol: 'D'}
                ],
                'A': [
                    {root: 'A', third: 'C#', fifth: 'E', symbol: 'A'},
                    {root: 'D', third: 'F#', fifth: 'A', symbol: 'D'},
                    {root: 'E', third: 'G#', fifth: 'B', symbol: 'E'},
                    {root: 'A', third: 'C#', fifth: 'E', symbol: 'A'}
                ],
                'E': [
                    {root: 'E', third: 'G#', fifth: 'B', symbol: 'E'},
                    {root: 'A', third: 'C#', fifth: 'E', symbol: 'A'},
                    {root: 'B', third: 'D#', fifth: 'F#', symbol: 'B'},
                    {root: 'E', third: 'G#', fifth: 'B', symbol: 'E'}
                ],
                'Am': [
                    {root: 'A', third: 'C', fifth: 'E', symbol: 'Am'},
                    {root: 'D', third: 'F', fifth: 'A', symbol: 'Dm'},
                    {root: 'E', third: 'G#', fifth: 'B', symbol: 'E'},
                    {root: 'A', third: 'C', fifth: 'E', symbol: 'Am'}
                ],
                'Em': [
                    {root: 'E', third: 'G', fifth: 'B', symbol: 'Em'},
                    {root: 'A', third: 'C', fifth: 'E', symbol: 'Am'},
                    {root: 'B', third: 'D#', fifth: 'F#', symbol: 'B'},
                    {root: 'E', third: 'G', fifth: 'B', symbol: 'Em'}
                ]
            };
            return progressions[key] || progressions['C'];
        }

        // Generate guitar part based on style
        function generateGuitarPart(chord, style) {
            const notes = [];
            
            switch(style) {
                case 'classical':
                    // P-I-M-A pattern
                    notes.push({pitch: chord.root, octave: 3, duration: 1});
                    notes.push({pitch: chord.fifth, octave: 3, duration: 1});
                    notes.push({pitch: chord.third, octave: 4, duration: 1});
                    notes.push({pitch: chord.fifth, octave: 3, duration: 1});
                    break;
                    
                case 'travis':
                    // Alternating bass pattern
                    notes.push({pitch: chord.root, octave: 3, duration: 1});
                    notes.push({pitch: chord.third, octave: 4, duration: 0.5});
                    notes.push({pitch: chord.fifth, octave: 3, duration: 0.5});
                    notes.push({pitch: chord.fifth, octave: 3, duration: 1});
                    notes.push({pitch: chord.third, octave: 4, duration: 1});
                    break;
                    
                case 'flamenco':
                    // Rasgueado pattern
                    notes.push({pitch: chord.root, octave: 3, duration: 0.5});
                    notes.push({pitch: chord.third, octave: 3, duration: 0.5});
                    notes.push({pitch: chord.fifth, octave: 3, duration: 0.5});
                    notes.push({pitch: chord.root, octave: 3, duration: 0.5});
                    notes.push({pitch: chord.root, octave: 3, duration: 2});
                    break;
                    
                case 'jazz':
                    // Jazz comping
                    notes.push({pitch: chord.third, octave: 3, duration: 1.5});
                    notes.push({pitch: chord.fifth, octave: 3, duration: 0.5});
                    notes.push({pitch: chord.root, octave: 3, duration: 2});
                    break;
                    
                case 'fingerstyle':
                    // Modern fingerstyle
                    notes.push({pitch: chord.root, octave: 3, duration: 1});
                    notes.push({pitch: chord.fifth, octave: 3, duration: 0.5});
                    notes.push({pitch: chord.third, octave: 4, duration: 0.5});
                    notes.push({pitch: chord.fifth, octave: 3, duration: 0.5});
                    notes.push({pitch: chord.third, octave: 4, duration: 0.5});
                    notes.push({pitch: chord.root, octave: 3, duration: 1});
                    break;
                    
                default:
                    // Default pattern
                    notes.push({pitch: chord.root, octave: 3, duration: 2});
                    notes.push({pitch: chord.third, octave: 3, duration: 1});
                    notes.push({pitch: chord.fifth, octave: 3, duration: 1});
            }
            
            return notes;
        }

        // Generate Violin 1 (melody)
        function generateViolin1(chord, key, measure) {
            const notes = [];
            
            // Create melodic patterns
            if (measure % 4 === 0) {
                // Start of phrase
                notes.push({pitch: chord.root, octave: 5, duration: 2});
                notes.push({pitch: chord.third, octave: 5, duration: 1});
                notes.push({pitch: chord.fifth, octave: 5, duration: 1});
            } else if (measure % 4 === 3) {
                // End of phrase - add double stop occasionally
                notes.push({pitch: chord.fifth, octave: 5, duration: 2});
                notes.push({
                    pitch: chord.root, 
                    octave: 5, 
                    duration: 2,
                    doubleStop: chord.third
                });
            } else {
                // Middle of phrase
                notes.push({pitch: chord.third, octave: 5, duration: 1});
                notes.push({pitch: chord.fifth, octave: 5, duration: 1});
                notes.push({pitch: chord.root, octave: 5, duration: 1});
                notes.push({pitch: chord.third, octave: 5, duration: 1});
            }
            
            return notes;
        }

        // Generate Violin 2 (harmony)
        function generateViolin2(chord) {
            return [
                {pitch: chord.third, octave: 4, duration: 2},
                {pitch: chord.fifth, octave: 4, duration: 2}
            ];
        }

        // Generate Viola (inner voice)
        function generateViola(chord) {
            return [
                {pitch: chord.fifth, octave: 3, duration: 4}
            ];
        }

        // Generate Cello (bass)
        function generateCello(chord) {
            return [
                {pitch: chord.root, octave: 2, duration: 2},
                {pitch: chord.fifth, octave: 2, duration: 2}
            ];
        }

        // Update statistics
        function updateStats() {
            let totalNotes = 0;
            
            // Count all notes
            for (let part in composition.parts) {
                composition.parts[part].forEach(measure => {
                    totalNotes += measure.length;
                });
            }
            
            document.getElementById('statKey').textContent = composition.key;
            document.getElementById('statStyle').textContent = composition.guitarStyle;
            document.getElementById('statMeasures').textContent = composition.measures;
            document.getElementById('statNotes').textContent = totalNotes;
            document.getElementById('stats').style.display = 'grid';
        }

        // Export to MusicXML
        function exportMusicXML() {
            if (!composition) {
                alert('Please generate a composition first');
                return;
            }
            
            let xml = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
            xml += '<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">\n';
            xml += '<score-partwise version="3.1">\n';
            
            // Work title
            xml += '  <work>\n';
            xml += '    <work-title>Quintet in ' + composition.key + ' - ' + composition.guitarStyle + ' guitar</work-title>\n';
            xml += '  </work>\n';
            
            // Identification
            xml += '  <identification>\n';
            xml += '    <creator type="composer">Quintet Composer v64</creator>\n';
            xml += '  </identification>\n';
            
            // Part list - CORRECT ORDER: Guitar, Violin I, Violin II, Viola, Cello
            xml += '  <part-list>\n';
            xml += '    <score-part id="P1"><part-name>Classical Guitar</part-name></score-part>\n';
            xml += '    <score-part id="P2"><part-name>Violin I</part-name></score-part>\n';
            xml += '    <score-part id="P3"><part-name>Violin II</part-name></score-part>\n';
            xml += '    <score-part id="P4"><part-name>Viola</part-name></score-part>\n';
            xml += '    <score-part id="P5"><part-name>Violoncello</part-name></score-part>\n';
            xml += '  </part-list>\n';
            
            // Parts
            const partInfo = [
                {name: 'guitar', clef: {sign: 'G', line: 2}, transpose: true},
                {name: 'violin1', clef: {sign: 'G', line: 2}, transpose: false},
                {name: 'violin2', clef: {sign: 'G', line: 2}, transpose: false},
                {name: 'viola', clef: {sign: 'C', line: 3}, transpose: false},
                {name: 'cello', clef: {sign: 'F', line: 4}, transpose: false}
            ];
            
            partInfo.forEach(function(part, partIdx) {
                xml += '  <part id="P' + (partIdx + 1) + '">\n';
                
                for (let m = 0; m < composition.measures; m++) {
                    xml += '    <measure number="' + (m + 1) + '">\n';
                    
                    // First measure attributes
                    if (m === 0) {
                        xml += '      <attributes>\n';
                        xml += '        <divisions>4</divisions>\n';
                        xml += '        <key><fifths>0</fifths></key>\n';
                        xml += '        <time><beats>4</beats><beat-type>4</beat-type></time>\n';
                        xml += '        <clef><sign>' + part.clef.sign + '</sign><line>' + part.clef.line + '</line></clef>\n';
                        
                        // Guitar transposition
                        if (part.transpose) {
                            xml += '        <transpose>\n';
                            xml += '          <diatonic>0</diatonic>\n';
                            xml += '          <chromatic>0</chromatic>\n';
                            xml += '          <octave-change>-1</octave-change>\n';
                            xml += '        </transpose>\n';
                        }
                        
                        xml += '      </attributes>\n';
                    }
                    
                    // Add notes for this measure
                    const notes = composition.parts[part.name][m];
                    if (notes) {
                        notes.forEach(function(note) {
                            xml += '      <note>\n';
                            xml += '        <pitch>\n';
                            xml += '          <step>' + note.pitch.charAt(0) + '</step>\n';
                            if (note.pitch.includes('#')) {
                                xml += '          <alter>1</alter>\n';
                            }
                            xml += '          <octave>' + note.octave + '</octave>\n';
                            xml += '        </pitch>\n';
                            xml += '        <duration>' + Math.round(note.duration * 4) + '</duration>\n';
                            xml += '        <type>' + getDurationType(note.duration) + '</type>\n';
                            xml += '      </note>\n';
                            
                            // Add double stop if present
                            if (note.doubleStop) {
                                xml += '      <note>\n';
                                xml += '        <chord/>\n';
                                xml += '        <pitch>\n';
                                xml += '          <step>' + note.doubleStop.charAt(0) + '</step>\n';
                                if (note.doubleStop.includes('#')) {
                                    xml += '          <alter>1</alter>\n';
                                }
                                xml += '          <octave>' + note.octave + '</octave>\n';
                                xml += '        </pitch>\n';
                                xml += '        <duration>' + Math.round(note.duration * 4) + '</duration>\n';
                                xml += '        <type>' + getDurationType(note.duration) + '</type>\n';
                                xml += '      </note>\n';
                            }
                        });
                    }
                    
                    xml += '    </measure>\n';
                }
                
                xml += '  </part>\n';
            });
            
            xml += '</score-partwise>\n';
            
            // Download
            const blob = new Blob([xml], {type: 'application/xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quintet_v64.musicxml';
            a.click();
            URL.revokeObjectURL(url);
            
            document.getElementById('status').textContent = 'MusicXML exported successfully!';
        }

        // Helper function for note durations
        function getDurationType(duration) {
            if (duration >= 4) return 'whole';
            if (duration >= 2) return 'half';
            if (duration >= 1) return 'quarter';
            if (duration >= 0.5) return 'eighth';
            return 'sixteenth';
        }
    </script>
</body>
</html>